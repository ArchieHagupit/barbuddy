<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BarBuddy ‚Äî Philippine Bar Exam Companion</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#0d1117;--ink2:#111827;--ink3:#1c2840;
  --gold:#c9a84c;--gold-l:#e2c97e;--gold-d:#7a6128;
  --crim:#9b2335;--crim-l:#c43a4e;--blue:#0038a8;--blue-l:#1a52d4;--teal:#14b4a0;
  --white:#f8f6f1;--muted:#6b7fa0;--card:#131e30;--card2:#0f1924;
  --bdr:rgba(201,168,76,.13);--bdr2:rgba(255,255,255,.07);
  --sw:68px;--fd:'Cormorant Garamond',Georgia,serif;--fb:'DM Sans',sans-serif;--fm:'DM Mono',monospace;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:var(--fb);background:var(--ink);color:var(--white);min-height:100vh;display:flex;overflow-x:hidden;}
/* SIDEBAR */
.sidebar{width:var(--sw);background:var(--card2);border-right:1px solid var(--bdr);display:flex;flex-direction:column;align-items:center;padding:16px 0 20px;position:fixed;inset:0 auto 0 0;z-index:300;gap:4px;}
.s-logo{width:42px;height:42px;background:linear-gradient(145deg,var(--gold),var(--gold-d));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:14px;box-shadow:0 4px 18px rgba(201,168,76,.3);}
.s-btn{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;color:var(--muted);font-size:18px;position:relative;border:none;background:transparent;}
.s-btn:hover{background:rgba(201,168,76,.1);color:var(--gold-l);}
.s-btn.on{background:rgba(201,168,76,.13);color:var(--gold);}
.s-btn.on::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:22px;background:linear-gradient(var(--gold),var(--gold-d));border-radius:0 3px 3px 0;}
.s-tip{position:absolute;left:56px;top:50%;transform:translateY(-50%);background:var(--card);border:1px solid var(--bdr);color:var(--white);font-size:11px;font-weight:600;padding:5px 10px;border-radius:8px;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .2s;z-index:400;}
.s-btn:hover .s-tip{opacity:1;}
.s-div{width:30px;height:1px;background:var(--bdr);margin:4px 0;}
/* TOPBAR */
.topbar{position:sticky;top:0;z-index:200;background:var(--card2);border-bottom:1px solid var(--bdr);height:58px;display:flex;align-items:center;padding:0 22px;}
.tb-brand h1{font-family:var(--fd);font-size:24px;font-weight:700;color:var(--gold);line-height:1;}
.tb-brand h1 em{font-style:italic;color:var(--gold-l);}
.tb-sub{font-size:10px;color:var(--muted);letter-spacing:.04em;}
.ph-flag{display:flex;gap:2px;margin-left:5px;}
.pf-b{width:11px;height:6px;background:var(--blue);border-radius:2px 0 0 2px;}
.pf-r{width:11px;height:6px;background:var(--crim);border-radius:0 2px 2px 0;}
.tb-tabs{display:flex;gap:2px;margin:0 20px;flex:1;}
.tb-tab{display:flex;align-items:center;gap:6px;padding:7px 15px;border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;color:var(--muted);transition:all .2s;border:1px solid transparent;background:transparent;font-family:var(--fb);}
.tb-tab:hover{color:var(--white);background:rgba(255,255,255,.05);}
.tb-tab.on{color:var(--gold);background:rgba(201,168,76,.1);border-color:rgba(201,168,76,.2);}
.tb-tab.mock.on{color:#ff8c42;background:rgba(255,140,66,.1);border-color:rgba(255,140,66,.2);}
.tb-right{display:flex;align-items:center;gap:10px;flex-shrink:0;}
.exam-pill{background:rgba(155,35,53,.2);border:1px solid rgba(155,35,53,.4);color:#e07080;font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;font-family:var(--fm);}
/* KB indicator */
.kb-ind{display:flex;align-items:center;gap:5px;font-size:11px;padding:4px 10px;border-radius:8px;font-family:var(--fm);cursor:pointer;border:1px solid;transition:all .2s;}
.kb-ind.loaded{color:var(--teal);background:rgba(20,180,160,.08);border-color:rgba(20,180,160,.2);}
.kb-ind.empty{color:var(--muted);background:rgba(255,255,255,.04);border-color:var(--bdr2);}
.kb-ind.generating{color:#ff8c42;background:rgba(255,140,66,.08);border-color:rgba(255,140,66,.2);}
.kb-dot{width:6px;height:6px;border-radius:50%;}
.kb-ind.loaded .kb-dot{background:var(--teal);animation:pulse 2s infinite;}
/* API status banner */
#apiBanner{display:none;position:fixed;top:0;left:0;right:0;z-index:500;background:rgba(155,35,53,.92);backdrop-filter:blur(4px);color:#fff;font-size:12px;font-weight:600;text-align:center;padding:7px 16px;letter-spacing:.02em;}
#apiBanner button{margin-left:12px;background:transparent;border:1px solid rgba(255,255,255,.45);color:#fff;border-radius:5px;padding:2px 9px;cursor:pointer;font-size:11px;}
.kb-ind.generating .kb-dot{background:#ff8c42;animation:pulse .6s infinite;}
.kb-ind.empty .kb-dot{background:var(--muted);}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}
.avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--crim),var(--blue));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;border:2px solid var(--bdr);}
/* MAIN */
.main{margin-left:var(--sw);flex:1;display:flex;flex-direction:column;min-height:100vh;}
.page{display:none;flex:1;} .page.on{display:block;}
/* PREGEN BANNER */
.pregen-banner{background:linear-gradient(135deg,#1a1000,#2a1800);border-bottom:1px solid rgba(255,140,66,.25);padding:11px 22px;display:none;align-items:center;gap:14px;position:sticky;top:58px;z-index:190;}
.pregen-banner.on{display:flex;}
.pb-label{font-size:12px;font-weight:600;color:#ff8c42;white-space:nowrap;}
.pb-prog-wrap{flex:1;max-width:300px;}
.pb-track{height:5px;background:rgba(255,255,255,.08);border-radius:3px;overflow:hidden;}
.pb-fill{height:100%;background:linear-gradient(90deg,#d4621a,#ff8c42);border-radius:3px;transition:width .4s;}
.pb-meta{font-size:11px;color:#a08060;font-family:var(--fm);margin-top:4px;}
.pb-cur{font-size:11px;color:#a08060;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.pb-done-badge{font-size:11px;font-weight:700;color:var(--teal);background:rgba(20,180,160,.1);border:1px solid rgba(20,180,160,.3);border-radius:6px;padding:3px 9px;white-space:nowrap;}
/* LAYOUT */
.pg-inner{padding:24px 26px 60px;max-width:1300px;width:100%;}
.two-col{display:grid;grid-template-columns:1fr 278px;gap:20px;}
.left-col{display:flex;flex-direction:column;gap:16px;}
.right-col{display:flex;flex-direction:column;gap:14px;}
/* BUTTONS */
.btn-gold{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,var(--gold),var(--gold-d));color:var(--ink);padding:9px 17px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;border:none;transition:all .2s;font-family:var(--fb);box-shadow:0 4px 14px rgba(201,168,76,.25);}
.btn-gold:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(201,168,76,.35);}
.btn-gold:disabled{opacity:.45;cursor:not-allowed;transform:none;}
.btn-og{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(201,168,76,.5);color:var(--gold-l);padding:7px 14px;border-radius:10px;font-size:12px;font-weight:600;cursor:pointer;background:transparent;transition:all .2s;font-family:var(--fb);}
.btn-og:hover{background:rgba(201,168,76,.1);}
.btn-og:disabled{opacity:.4;cursor:not-allowed;}
.btn-ghost{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.06);color:var(--white);padding:8px 16px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid var(--bdr2);transition:all .2s;font-family:var(--fb);}
.btn-ghost:hover{background:rgba(255,255,255,.1);}
.btn-mock{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#ff8c42,#d4621a);color:#fff;padding:9px 17px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;border:none;transition:all .2s;font-family:var(--fb);box-shadow:0 4px 14px rgba(255,140,66,.3);}
.btn-mock:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(255,140,66,.45);}
.btn-mock:disabled{opacity:.45;cursor:not-allowed;transform:none;}
/* CARDS */
.card{background:var(--card);border:1px solid var(--bdr2);border-radius:18px;overflow:hidden;}
.card-h{padding:14px 20px 12px;border-bottom:1px solid var(--bdr2);display:flex;align-items:center;justify-content:space-between;}
.card-title{font-family:var(--fd);font-size:18px;font-weight:700;color:var(--gold-l);display:flex;align-items:center;gap:8px;}
.card-b{padding:16px 20px;}
/* HERO */
.hero{background:linear-gradient(125deg,var(--ink3),#1a2540,#0f1a30);border:1px solid var(--bdr);border-radius:20px;padding:26px 30px;display:flex;align-items:center;gap:22px;position:relative;overflow:hidden;}
.hero::before{content:'‚öñ';position:absolute;right:-8px;top:50%;transform:translateY(-50%);font-size:150px;opacity:.04;pointer-events:none;}
.hero::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--blue),var(--gold),var(--crim));}
.hero-txt h2{font-family:var(--fd);font-size:25px;font-weight:700;line-height:1.25;margin-bottom:7px;}
.hero-txt h2 em{font-style:italic;color:var(--gold-l);}
.hero-txt p{font-size:13px;color:var(--muted);line-height:1.55;margin-bottom:16px;}
.hero-btns{display:flex;gap:8px;flex-wrap:wrap;}
.hero-stats{margin-left:auto;display:flex;gap:10px;flex-shrink:0;}
.hst{text-align:center;background:rgba(201,168,76,.08);border:1px solid rgba(201,168,76,.2);border-radius:13px;padding:13px 16px;min-width:72px;}
.hst-n{font-family:var(--fd);font-size:28px;font-weight:700;color:var(--gold-l);line-height:1;}
.hst-l{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-top:3px;}
/* STAT ROW */
.stat-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
.stt{background:var(--card);border:1px solid var(--bdr2);border-radius:13px;padding:14px;display:flex;align-items:center;gap:10px;}
.stt-ic{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.ic-g{background:rgba(201,168,76,.15);}.ic-b{background:rgba(0,56,168,.2);}.ic-r{background:rgba(155,35,53,.2);}.ic-t{background:rgba(20,180,160,.15);}
.stt-n{font-family:var(--fd);font-size:24px;font-weight:700;color:var(--gold-l);line-height:1;}
.stt-l{font-size:11px;color:var(--muted);margin-top:2px;}
/* SUBJECT BADGES */
.sbg{font-size:10px;font-weight:700;padding:2px 8px;border-radius:5px;font-family:var(--fm);letter-spacing:.03em;white-space:nowrap;}
.sg-civ{background:rgba(201,168,76,.15);color:var(--gold);}.sg-cri{background:rgba(155,35,53,.2);color:#e07080;}
.sg-pol{background:rgba(0,56,168,.2);color:#6b9af8;}.sg-lab{background:rgba(20,180,160,.15);color:#14b4a0;}
.sg-com{background:rgba(160,100,200,.15);color:#c080f0;}.sg-tax{background:rgba(200,120,40,.15);color:#e09050;}
.sg-rem{background:rgba(40,160,100,.15);color:#50d090;}.sg-eth{background:rgba(120,120,180,.15);color:#9090d0;}
.sg-gen{background:rgba(100,100,120,.15);color:#a0a0c0;}
/* RECENT ITEMS */
.r-item{display:flex;align-items:center;gap:10px;padding:11px 13px;background:rgba(255,255,255,.03);border:1px solid var(--bdr2);border-radius:12px;cursor:pointer;transition:all .2s;margin-bottom:7px;}
.r-item:last-child{margin-bottom:0;}
.r-item:hover{background:rgba(201,168,76,.06);border-color:rgba(201,168,76,.25);transform:translateX(2px);}
.r-ic{width:34px;height:34px;border-radius:9px;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.2);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
.r-info{flex:1;min-width:0;}
.r-title{font-size:13px;font-weight:600;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.r-sub{font-size:11px;color:var(--muted);}
.tag{font-size:10px;font-weight:700;padding:2px 7px;border-radius:5px;font-family:var(--fm);}
.tg-l{background:rgba(201,168,76,.15);color:var(--gold);}.tg-q{background:rgba(0,56,168,.2);color:#6b9af8;}
.tg-e{background:rgba(20,180,160,.15);color:#14b4a0;}.tg-m{background:rgba(255,140,66,.15);color:#ff8c42;}
/* SUBJECT TRACKER */
.sub-row{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--bdr2);cursor:pointer;transition:all .18s;}
.sub-row:last-child{border-bottom:none;}
.sub-row:hover{opacity:.82;}
.sub-num{width:24px;height:24px;border-radius:6px;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.2);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:var(--gold);font-family:var(--fm);flex-shrink:0;}
.bar-track{height:4px;background:rgba(255,255,255,.07);border-radius:2px;overflow:hidden;width:70px;}
.bar-fill{height:100%;border-radius:2px;transition:width .6s;}
.bf-g{background:linear-gradient(90deg,var(--gold-d),var(--gold));}.bf-r{background:linear-gradient(90deg,var(--crim),var(--crim-l));}
.bf-b{background:linear-gradient(90deg,var(--blue),var(--blue-l));}.bf-t{background:linear-gradient(90deg,#0d8a7a,var(--teal));}
/* WARN */
.warn{background:linear-gradient(135deg,#2a1a06,#1e1406);border:1px solid rgba(201,168,76,.28);border-radius:14px;padding:14px 18px;display:flex;align-items:center;gap:12px;}
.warn strong{font-size:13px;font-weight:600;color:var(--gold-l);display:block;margin-bottom:2px;}
.warn span{font-size:12px;color:#a08040;}
/* RIGHT SIDEBAR */
.rc{background:var(--card);border:1px solid var(--bdr2);border-radius:16px;overflow:hidden;}
.rc-h{padding:13px 16px 11px;border-bottom:1px solid var(--bdr2);font-family:var(--fd);font-size:16px;font-weight:700;color:var(--gold-l);}
.rc-b{padding:10px 12px;}
.act{display:flex;align-items:center;gap:9px;padding:9px 10px;border-radius:9px;cursor:pointer;transition:background .18s;font-size:13px;font-weight:500;border:none;width:100%;text-align:left;background:transparent;color:var(--white);font-family:var(--fb);margin-bottom:2px;}
.act:last-child{margin-bottom:0;}
.act:hover{background:rgba(201,168,76,.08);}
/* KB CARD */
.kb-card{background:linear-gradient(145deg,#081410,#0d1f16);border:1px solid rgba(20,180,160,.2);border-radius:16px;padding:16px;}
.kb-item{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.05);font-size:12px;}
.kb-item:last-child{border-bottom:none;}
/* ‚îÄ‚îÄ‚îÄ SPLIT LAYOUT (Learn + Practice + Mock) ‚îÄ‚îÄ‚îÄ */
.split-layout{display:grid;grid-template-columns:258px 1fr;height:calc(100vh - 58px);overflow:hidden;}
.panel-l{background:var(--card2);border-right:1px solid var(--bdr);display:flex;flex-direction:column;overflow:hidden;}
.pl-head{padding:16px 14px 13px;border-bottom:1px solid var(--bdr);}
.pl-head h3{font-family:var(--fd);font-size:17px;font-weight:700;color:var(--gold-l);margin-bottom:8px;}
.sp-search{width:100%;background:rgba(255,255,255,.05);border:1px solid var(--bdr2);border-radius:9px;padding:7px 11px;color:var(--white);font-family:var(--fb);font-size:12px;outline:none;transition:border-color .2s;}
.sp-search:focus{border-color:rgba(201,168,76,.4);}
.prog-mini{margin-top:8px;}
.prog-row{display:flex;justify-content:space-between;margin-bottom:4px;}
.prog-pct{font-size:11px;font-weight:700;color:var(--gold);font-family:var(--fm);}
.prog-lbl{font-size:10px;color:var(--muted);}
.prog-track{height:3px;background:rgba(255,255,255,.08);border-radius:2px;overflow:hidden;}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--gold-d),var(--gold));border-radius:2px;transition:width .5s;}
.tree{flex:1;overflow-y:auto;padding:6px 0;}
.tree::-webkit-scrollbar{width:3px;}
.tree::-webkit-scrollbar-thumb{background:rgba(201,168,76,.2);border-radius:3px;}
.up-btn{margin:8px 10px;padding:9px;border-radius:9px;background:rgba(201,168,76,.07);border:1px dashed rgba(201,168,76,.28);color:var(--gold-l);font-size:12px;font-weight:600;cursor:pointer;text-align:center;transition:all .2s;font-family:var(--fb);}
.up-btn:hover{background:rgba(201,168,76,.15);}
/* TREE NODES */
.subj-hdr{display:flex;align-items:center;gap:7px;padding:8px 12px;cursor:pointer;transition:background .18s;user-select:none;}
.subj-hdr:hover{background:rgba(255,255,255,.03);}
.chev{color:var(--muted);font-size:10px;transition:transform .2s;}
.subj-hdr.open .chev{transform:rotate(90deg);}
.subj-label{font-size:12px;font-weight:700;flex:1;color:var(--white);}
.subj-cnt{font-size:10px;color:var(--muted);font-family:var(--fm);}
.topic-list{display:none;} .topic-list.open{display:block;}
.topic-item{display:flex;align-items:center;gap:7px;padding:7px 12px 7px 26px;cursor:pointer;transition:all .18s;font-size:12px;color:var(--muted);position:relative;}
.topic-item:hover{color:var(--white);background:rgba(255,255,255,.03);}
.topic-item.active{color:var(--gold-l);background:rgba(201,168,76,.08);}
.topic-item.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:var(--gold);}
.t-chk{font-size:10px;flex-shrink:0;color:rgba(255,255,255,.15);}
.topic-item.done .t-chk{color:var(--teal);}
.t-lbl{flex:1;line-height:1.4;}
/* READY BADGE ‚Äî shows pre-generated content is cached */
.ready-badge{font-size:9px;padding:1px 5px;border-radius:3px;font-family:var(--fm);flex-shrink:0;}
.rb-cached{background:rgba(20,180,160,.15);color:var(--teal);}
.rb-gen{background:rgba(255,140,66,.12);color:#ff8c42;animation:genFlash 1s ease infinite;}
@keyframes genFlash{0%,100%{opacity:1;}50%{opacity:.4;}}
/* LESSON PANEL */
.panel-r{display:flex;flex-direction:column;overflow:hidden;}
.pr-top{padding:13px 24px;border-bottom:1px solid var(--bdr2);display:flex;align-items:center;gap:12px;background:var(--ink2);}
.pr-bc{font-size:12px;color:var(--muted);flex:1;} .pr-bc strong{color:var(--gold-l);}
.pr-content{flex:1;overflow-y:auto;padding:28px 38px;background:var(--ink);}
.pr-content::-webkit-scrollbar{width:5px;}
.pr-content::-webkit-scrollbar-thumb{background:rgba(201,168,76,.15);border-radius:4px;}
.pr-foot{padding:13px 24px;border-top:1px solid var(--bdr2);display:flex;align-items:center;justify-content:space-between;background:var(--ink2);}
/* WELCOME / GEN STATES */
.welcome-st{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;padding:36px;color:var(--muted);}
.welcome-st .big-ic{font-size:60px;margin-bottom:16px;opacity:.35;}
.welcome-st h3{font-family:var(--fd);font-size:25px;font-weight:700;color:var(--gold-l);margin-bottom:8px;opacity:.7;}
.welcome-st p{font-size:14px;line-height:1.6;max-width:380px;margin-bottom:18px;}
.gen-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:13px;}
.spin{width:36px;height:36px;border:3px solid rgba(201,168,76,.2);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
/* LESSON CONTENT */
.lc h2{font-family:var(--fd);font-size:26px;font-weight:700;color:var(--gold-l);margin-bottom:8px;line-height:1.2;}
.lc-meta{display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap;}
.lc h3{font-family:var(--fd);font-size:20px;font-weight:700;color:var(--gold-l);margin:22px 0 9px;}
.lc h4{font-size:15px;font-weight:700;color:#a8bfdf;margin:16px 0 7px;}
.lc p{font-size:14px;line-height:1.85;color:rgba(248,246,241,.82);margin-bottom:11px;}
.lc ul,.lc ol{padding-left:20px;margin-bottom:11px;}
.lc li{font-size:14px;line-height:1.8;color:rgba(248,246,241,.8);}
.lc strong{color:var(--white);} .lc em{color:var(--gold-l);font-style:italic;}
.definition-box{background:rgba(201,168,76,.07);border-left:3px solid var(--gold);border-radius:0 10px 10px 0;padding:13px 15px;margin:13px 0;font-size:14px;line-height:1.7;}
.case-box{background:rgba(0,56,168,.1);border:1px solid rgba(0,56,168,.25);border-radius:11px;padding:13px 15px;margin:13px 0;font-size:14px;line-height:1.7;}
.case-box strong{color:#6b9af8;display:block;margin-bottom:4px;}
.codal-box{background:rgba(155,35,53,.08);border:1px solid rgba(155,35,53,.25);border-radius:11px;padding:13px 15px;margin:13px 0;font-size:13px;line-height:1.7;font-family:var(--fm);color:#e07080;}
.rule-box{background:rgba(20,180,160,.07);border-left:3px solid var(--teal);border-radius:0 10px 10px 0;padding:13px 15px;margin:13px 0;font-size:14px;line-height:1.7;color:#80ddd0;}
.tip-box{background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:11px;padding:13px 15px;margin:13px 0;font-size:13px;line-height:1.7;color:var(--gold-l);}
.kb-ref-note{background:rgba(20,180,160,.06);border:1px solid rgba(20,180,160,.18);border-radius:9px;padding:8px 12px;margin-bottom:14px;font-size:12px;color:var(--teal);display:flex;align-items:center;gap:7px;}
/* PRACTICE */
.qn-list{flex:1;overflow-y:auto;padding:6px 0;}
.qn-list::-webkit-scrollbar{width:3px;}
.qn-list::-webkit-scrollbar-thumb{background:rgba(201,168,76,.2);border-radius:3px;}
.qn-item{display:flex;align-items:center;gap:9px;padding:9px 12px;cursor:pointer;transition:all .18s;position:relative;}
.qn-item:hover{background:rgba(255,255,255,.03);}
.qn-item.active{background:rgba(201,168,76,.08);}
.qn-item.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:var(--gold);}
.qn-icon{font-size:15px;flex-shrink:0;}
.qn-info{flex:1;min-width:0;}
.qn-title{font-size:12px;font-weight:600;color:var(--white);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:1px;}
.qn-sub{font-size:10px;color:var(--muted);}
.q-type-tabs{display:flex;gap:5px;margin-top:10px;}
.qtt{flex:1;padding:7px 5px;border-radius:8px;border:1px solid var(--bdr2);text-align:center;cursor:pointer;font-size:11px;font-weight:600;color:var(--muted);transition:all .2s;}
.qtt.on{border-color:rgba(201,168,76,.4);background:rgba(201,168,76,.08);color:var(--gold-l);}
.qtt:hover:not(.on){color:var(--white);border-color:rgba(255,255,255,.12);}
.qtt-ic{font-size:16px;display:block;margin-bottom:2px;}
/* QUIZ ELEMENTS */
.qm-body{flex:1;overflow-y:auto;padding:24px 32px;background:var(--ink);}
.qm-body::-webkit-scrollbar{width:5px;}
.qm-body::-webkit-scrollbar-thumb{background:rgba(201,168,76,.15);border-radius:4px;}
.q-prog-track{height:4px;background:rgba(255,255,255,.07);border-radius:2px;overflow:hidden;margin-bottom:7px;}
.q-prog-fill{height:100%;background:linear-gradient(90deg,var(--gold-d),var(--gold));border-radius:2px;transition:width .4s;}
.q-prog-meta{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);font-family:var(--fm);margin-bottom:18px;}
.q-question{font-size:15px;font-weight:500;line-height:1.75;margin-bottom:16px;color:var(--white);}
.q-opts{display:flex;flex-direction:column;gap:8px;}
.q-opt{padding:12px 16px;background:rgba(255,255,255,.04);border:1px solid var(--bdr2);border-radius:11px;cursor:pointer;font-size:14px;line-height:1.5;transition:all .2s;}
.q-opt:hover:not(.correct):not(.wrong){border-color:rgba(201,168,76,.4);background:rgba(201,168,76,.06);}
.q-opt.correct{border-color:var(--teal)!important;background:rgba(20,180,160,.1)!important;color:#80ddd0;}
.q-opt.wrong{border-color:var(--crim-l)!important;background:rgba(155,35,53,.1)!important;color:#e07080;}
.q-feedback{margin-top:12px;padding:13px 15px;border-radius:11px;font-size:14px;line-height:1.65;display:none;}
.q-feedback.show{display:block;}
.q-feedback.ok{background:rgba(20,180,160,.1);border:1px solid rgba(20,180,160,.3);color:#80ddd0;}
.q-feedback.no{background:rgba(155,35,53,.1);border:1px solid rgba(155,35,53,.3);color:#e07080;}
/* ESSAY */
.essay-prompt{font-size:15px;font-weight:600;line-height:1.75;margin-bottom:10px;color:var(--white);}
.essay-ctx{background:rgba(0,56,168,.07);border:1px solid rgba(0,56,168,.2);border-radius:11px;padding:13px 15px;margin-bottom:13px;font-size:13px;line-height:1.75;color:rgba(248,246,241,.78);font-style:italic;}
.facts-label{font-size:10px;font-weight:700;color:#6b9fff;text-transform:uppercase;letter-spacing:.09em;margin-bottom:6px;display:block;}
.q-label{font-size:10px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:.09em;margin-bottom:5px;display:block;}
.alac-table{width:100%;border-collapse:collapse;font-size:13px;margin:10px 0;}
.alac-table th{text-align:left;padding:6px 10px;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;border-bottom:1px solid var(--bdr2);}
.alac-table td{padding:7px 10px;vertical-align:top;border-bottom:1px solid rgba(255,255,255,.04);}
.alac-score{font-family:var(--fm);font-weight:700;font-size:13px;white-space:nowrap;padding:2px 8px;border-radius:5px;display:inline-block;}
.alac-score.hi{color:#14b4a0;background:rgba(20,180,160,.15);}
.alac-score.mid{color:#c9a84c;background:rgba(201,168,76,.15);}
.alac-score.lo{color:#e07080;background:rgba(155,35,53,.15);}
.alac-total-row td{border-top:1px solid var(--bdr2);font-weight:700;padding:8px 10px;}
.alac-model{white-space:pre-line;font-size:13px;line-height:1.8;}
.model-answer-section{margin-bottom:2px;}
.ma-label{color:var(--gold);font-weight:700;text-transform:uppercase;font-size:11px;letter-spacing:.08em;margin-bottom:4px;}
.ma-text{font-size:14px;line-height:1.75;color:rgba(248,246,241,.88);margin-bottom:14px;white-space:pre-line;}
.essay-box{width:100%;min-height:190px;background:rgba(255,255,255,.04);border:1px solid var(--bdr2);border-radius:11px;padding:13px 15px;color:var(--white);font-family:var(--fb);font-size:14px;line-height:1.75;outline:none;resize:vertical;transition:border-color .2s;}
.essay-box:focus{border-color:rgba(201,168,76,.4);}
.ai-fb{background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:13px;padding:16px;margin-top:14px;display:none;}
.ai-fb.show{display:block;}
.ai-fb-head{font-size:12px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:.06em;margin-bottom:9px;display:flex;align-items:center;gap:7px;flex-wrap:wrap;}
.ai-fb-score{background:rgba(201,168,76,.15);border-radius:5px;padding:2px 7px;font-family:var(--fm);}
.ai-fb-content{font-size:14px;line-height:1.75;color:rgba(248,246,241,.85);}
/* QUIZ RESULTS */
.quiz-results{text-align:center;padding:18px 0;}
.qr-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:18px 0;}
.qr-stat{background:rgba(255,255,255,.04);border:1px solid var(--bdr2);border-radius:11px;padding:13px;text-align:center;}
.qr-stat .n{font-family:var(--fd);font-size:26px;font-weight:700;color:var(--gold-l);}
.qr-stat .l{font-size:11px;color:var(--muted);margin-top:2px;}
/* ‚îÄ‚îÄ‚îÄ MOCK BAR ‚îÄ‚îÄ‚îÄ */
.mock-hero{background:linear-gradient(125deg,#1a0a00,#2a1400,#1a0800);border:1px solid rgba(255,140,66,.2);border-radius:20px;padding:26px 30px;position:relative;overflow:hidden;}
.mock-hero::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#ff8c42,var(--gold),#ff8c42);}
.mock-hero h2{font-family:var(--fd);font-size:26px;font-weight:700;margin-bottom:6px;color:#ff8c42;}
.mock-hero h2 em{font-style:italic;color:var(--gold-l);}
.mock-hero p{font-size:13px;color:#a08060;line-height:1.6;margin-bottom:18px;max-width:600px;}
.mock-config-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;}
.mc-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,140,66,.15);border-radius:13px;padding:14px;}
.mc-label{font-size:11px;color:#a08060;font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px;}
.mc-select{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,140,66,.25);border-radius:8px;padding:8px 10px;color:var(--white);font-family:var(--fb);font-size:13px;outline:none;}
.mc-subj-tag{font-size:10px;font-weight:700;padding:3px 8px;border-radius:5px;cursor:pointer;transition:all .2s;border:1px solid transparent;font-family:var(--fm);}
.mc-subj-tag.on{background:rgba(255,140,66,.2);border-color:rgba(255,140,66,.4);color:#ff8c42;}
.mc-subj-tag:not(.on){background:rgba(255,255,255,.04);border-color:var(--bdr2);color:var(--muted);}
/* SESSION */
.mock-session{display:none;} .mock-session.on{display:block;}
.ms-header{background:linear-gradient(135deg,#1a0a00,#2a1400);border:1px solid rgba(255,140,66,.2);border-radius:13px;padding:15px 20px;display:flex;align-items:center;gap:16px;margin-bottom:18px;}
.ms-q-num{font-family:var(--fd);font-size:22px;font-weight:700;color:#ff8c42;}
.ms-of{font-size:12px;color:#a08060;font-family:var(--fm);}
.ms-timer{display:flex;align-items:center;gap:6px;font-size:22px;font-weight:700;color:#ff8c42;font-family:var(--fm);margin-left:auto;}
.ms-timer.warn{color:#e07080;animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.4;}}
.ms-source{font-size:10px;color:#a08060;background:rgba(255,140,66,.1);border-radius:5px;padding:2px 7px;font-family:var(--fm);}
.q-markers{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:16px;}
.q-marker{width:26px;height:26px;border-radius:6px;border:1px solid var(--bdr2);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;cursor:pointer;transition:all .18s;color:var(--muted);}
.q-marker.done{background:rgba(255,140,66,.15);border-color:rgba(255,140,66,.4);color:#ff8c42;}
.q-marker.current{background:rgba(255,140,66,.25);border-color:#ff8c42;color:#ff8c42;}
/* MOCK RESULTS */
.mock-results{background:linear-gradient(145deg,#1a0a00,#0d0800);border:1px solid rgba(255,140,66,.2);border-radius:20px;padding:32px;text-align:center;}
.mr-grade{font-family:var(--fd);font-size:64px;font-weight:700;color:#ff8c42;line-height:1;margin:10px 0;}
.mr-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:22px 0;}
.mr-stat{background:rgba(255,255,255,.04);border:1px solid rgba(255,140,66,.15);border-radius:11px;padding:12px;text-align:center;}
.mr-stat .n{font-family:var(--fd);font-size:22px;font-weight:700;color:#ff8c42;}
.mr-stat .l{font-size:11px;color:#a08060;margin-top:2px;}
.q-review-item{background:rgba(255,255,255,.03);border:1px solid var(--bdr2);border-radius:12px;padding:13px;margin-bottom:9px;text-align:left;}
.q-score-badge{display:inline-flex;align-items:center;gap:5px;font-size:11px;font-weight:700;padding:3px 9px;border-radius:6px;font-family:var(--fm);}
.qsb-high{background:rgba(20,180,160,.15);color:var(--teal);}
.qsb-mid{background:rgba(201,168,76,.15);color:var(--gold);}
.qsb-low{background:rgba(155,35,53,.15);color:#e07080;}
/* MOCK SOURCE STATS */
.source-stats{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;}
.src-badge{font-size:11px;padding:4px 10px;border-radius:7px;font-family:var(--fm);font-weight:600;}
.sb-real{background:rgba(155,35,53,.15);color:#e07080;border:1px solid rgba(155,35,53,.25);}
.sb-pregen{background:rgba(20,180,160,.1);color:var(--teal);border:1px solid rgba(20,180,160,.2);}
.sb-ai{background:rgba(255,140,66,.1);color:#ff8c42;border:1px solid rgba(255,140,66,.2);}
/* MANUAL ENTRY DIVIDER */
.manual-divider{display:flex;align-items:center;gap:10px;font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.05em;margin:20px 0 14px;text-transform:uppercase;}
.manual-divider::before,.manual-divider::after{content:'';flex:1;height:1px;background:var(--bdr);}
.mn-note{background:rgba(20,180,160,.07);border:1px solid rgba(20,180,160,.2);border-radius:10px;padding:10px 13px;font-size:12px;color:var(--teal);line-height:1.55;margin-bottom:14px;}
.mn-preview{display:flex;flex-direction:column;gap:5px;margin:12px 0;}
.mn-prev-item{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.04);border:1px solid var(--bdr2);border-radius:8px;padding:7px 11px;font-size:12px;color:var(--white);}
.mn-prev-item .mn-rm{margin-left:auto;background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;line-height:1;padding:0 2px;}
.mn-prev-item .mn-rm:hover{color:#e07080;}
.mn-radio-group{display:flex;gap:14px;margin-bottom:10px;}
.mn-radio-group label{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--white);cursor:pointer;}
/* ‚îÄ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ‚îÄ */
.admin-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;}
.admin-panel{background:var(--card);border:1px solid var(--bdr2);border-radius:16px;padding:20px;}
.admin-panel h3{font-family:var(--fd);font-size:18px;font-weight:700;color:var(--gold-l);margin-bottom:5px;}
.admin-panel p{font-size:12px;color:var(--muted);margin-bottom:14px;line-height:1.55;}
.form-label{font-size:11px;font-weight:600;color:var(--gold-l);display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.04em;}
.form-input{width:100%;background:rgba(255,255,255,.05);border:1px solid var(--bdr2);border-radius:9px;padding:9px 12px;color:var(--white);font-family:var(--fb);font-size:13px;outline:none;transition:border-color .2s;margin-bottom:10px;}
.form-input:focus{border-color:rgba(201,168,76,.4);}
.form-select{width:100%;background:rgba(255,255,255,.05);border:1px solid var(--bdr2);border-radius:9px;padding:9px 12px;color:var(--white);font-family:var(--fb);font-size:13px;outline:none;margin-bottom:10px;}
.form-select option{background:var(--card2);}
.kb-list-item{display:flex;align-items:center;gap:9px;padding:8px 10px;background:rgba(255,255,255,.03);border:1px solid var(--bdr2);border-radius:9px;margin-bottom:6px;}
.kl-name{font-size:12px;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.kl-sub{font-size:10px;color:var(--muted);}
.kl-del{font-size:11px;color:#e07080;cursor:pointer;padding:3px 7px;border-radius:5px;background:rgba(155,35,53,.1);border:none;transition:background .18s;}
.kl-del:hover{background:rgba(155,35,53,.25);}
.admin-locked{text-align:center;padding:48px;color:var(--muted);}
/* Gen progress panel */
.gen-prog-panel{background:linear-gradient(135deg,#0a1000,#141800);border:1px solid rgba(255,140,66,.25);border-radius:14px;padding:18px;margin-top:14px;}
.gpp-head{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.gpp-title{font-family:var(--fd);font-size:17px;font-weight:700;color:#ff8c42;}
.gpp-track{height:6px;background:rgba(255,255,255,.08);border-radius:3px;overflow:hidden;margin-bottom:7px;}
.gpp-fill{height:100%;background:linear-gradient(90deg,#d4621a,#ff8c42);border-radius:3px;transition:width .4s;}
.gpp-meta{font-size:12px;color:#a08060;font-family:var(--fm);}
.gpp-cur{font-size:11px;color:#a08060;margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
/* MODALS */
.overlay{display:none;position:fixed;inset:0;background:rgba(5,10,18,.85);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(8px);}
.overlay.on{display:flex;}
.modal{background:var(--card);border:1px solid rgba(201,168,76,.2);border-radius:20px;width:92%;max-width:620px;max-height:88vh;overflow-y:auto;padding:30px;position:relative;animation:mIn .28s cubic-bezier(.22,.68,0,1.35);box-shadow:0 32px 80px rgba(0,0,0,.65);}
.modal::before{content:'';position:absolute;top:0;left:10%;right:10%;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);}
@keyframes mIn{from{transform:scale(.91) translateY(22px);opacity:0;}to{transform:scale(1) translateY(0);opacity:1;}}
.modal-x{position:absolute;top:16px;right:16px;width:30px;height:30px;background:rgba(255,255,255,.07);border:none;border-radius:8px;color:var(--muted);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .18s;}
.modal-x:hover{background:rgba(255,255,255,.14);color:var(--white);}
.modal-t{font-family:var(--fd);font-size:24px;font-weight:700;color:var(--gold-l);margin-bottom:6px;}
.modal-s{font-size:13px;color:var(--muted);margin-bottom:20px;line-height:1.55;}
/* CHAT */
.chat-box{min-height:200px;max-height:340px;overflow-y:auto;display:flex;flex-direction:column;gap:9px;margin-bottom:13px;padding-right:4px;}
.chat-box::-webkit-scrollbar{width:4px;}
.chat-box::-webkit-scrollbar-thumb{background:rgba(201,168,76,.2);border-radius:4px;}
.msg-ai{background:rgba(201,168,76,.07);border:1px solid rgba(201,168,76,.15);border-radius:11px;padding:12px 14px;font-size:13px;line-height:1.7;}
.msg-user{background:rgba(0,56,168,.15);border:1px solid rgba(0,56,168,.25);border-radius:11px;padding:12px 14px;font-size:13px;line-height:1.7;align-self:flex-end;max-width:88%;}
.chat-row{display:flex;gap:9px;}
.chat-in{flex:1;background:rgba(255,255,255,.05);border:1px solid var(--bdr2);border-radius:9px;padding:10px 13px;color:var(--white);font-family:var(--fb);font-size:14px;outline:none;transition:border-color .2s;}
.chat-in:focus{border-color:rgba(201,168,76,.4);}
/* ANIMS */
.fade{opacity:0;animation:fadeUp .4s ease forwards;}
.fade:nth-child(1){animation-delay:.04s;}.fade:nth-child(2){animation-delay:.09s;}.fade:nth-child(3){animation-delay:.14s;}.fade:nth-child(4){animation-delay:.19s;}.fade:nth-child(5){animation-delay:.23s;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
::-webkit-scrollbar{width:6px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:rgba(201,168,76,.14);border-radius:4px;}
@media(max-width:900px){.two-col{grid-template-columns:1fr;}.right-col{display:none;}.stat-row{grid-template-columns:repeat(2,1fr);}.split-layout{grid-template-columns:1fr;}.panel-l{display:none;}.mock-config-grid{grid-template-columns:1fr;}.admin-grid{grid-template-columns:1fr;}.mr-stats{grid-template-columns:repeat(2,1fr);}}
</style>
</head>
<body>
<div id="apiBanner">‚ö†Ô∏è Claude API is currently overloaded ‚Äî some features may be slow or unavailable. <button onclick="document.getElementById('apiBanner').style.display='none'">Dismiss</button></div>
<aside class="sidebar">
  <div class="s-logo">‚öñÔ∏è</div>
  <button class="s-btn on" onclick="nav('dashboard',this)">üèõ<span class="s-tip">Dashboard</span></button>
  <button class="s-btn" onclick="nav('learn',this)">üìñ<span class="s-tip">Learn</span></button>
  <button class="s-btn" onclick="nav('practice',this)">‚úçÔ∏è<span class="s-tip">Practice</span></button>
  <button class="s-btn" onclick="nav('mockbar',this)">‚è±<span class="s-tip">Mock Bar</span></button>
  <div class="s-div"></div>
  <button class="s-btn" onclick="openChatModal()">üí¨<span class="s-tip">AI Tutor</span></button>
  <div class="s-div"></div>
  <button class="s-btn" onclick="nav('admin',this)" style="margin-top:auto;">‚öôÔ∏è<span class="s-tip">Admin / KB</span></button>
</aside>

<div class="main">
<header class="topbar">
  <div class="tb-brand" style="margin-right:14px;">
    <div><h1>Bar<em>Buddy</em></h1><div class="tb-sub">Philippine Bar Exam Companion</div></div>
    <div class="ph-flag"><div class="pf-b"></div><div class="pf-r"></div></div>
  </div>
  <nav class="tb-tabs">
    <button class="tb-tab on" id="tab-dashboard" onclick="nav('dashboard',this)">üèõ Dashboard</button>
    <button class="tb-tab" id="tab-learn" onclick="nav('learn',this)">üìñ Learn</button>
    <button class="tb-tab" id="tab-practice" onclick="nav('practice',this)">‚úçÔ∏è Practice</button>
    <button class="tb-tab mock" id="tab-mockbar" onclick="nav('mockbar',this)">‚è± Mock Bar</button>
    <button class="tb-tab" id="tab-admin" onclick="nav('admin',this)" style="font-size:12px;">‚öôÔ∏è Admin</button>
  </nav>
  <div class="tb-right">
    <span class="exam-pill">PH BAR 2025</span>
    <div class="kb-ind empty" id="kbInd" onclick="nav('admin',document.getElementById('tab-admin'))">
      <div class="kb-dot"></div><span id="kbIndTxt">No KB</span>
    </div>
    <div class="avatar">BB</div>
  </div>
</header>

<!-- PRE-GEN PROGRESS BANNER (sticky, shows during generation) -->
<div class="pregen-banner" id="pregenBanner">
  <div class="pb-label">‚öôÔ∏è Generating content‚Ä¶</div>
  <div class="pb-prog-wrap">
    <div class="pb-track"><div class="pb-fill" id="pbFill" style="width:0%"></div></div>
    <div class="pb-meta"><span id="pbDone">0</span>/<span id="pbTotal">0</span> topics</div>
  </div>
  <div class="pb-cur" id="pbCur"></div>
</div>

<!-- ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê -->
<div class="page on" id="page-dashboard">
<div class="pg-inner"><div class="two-col">
<div class="left-col">
  <div class="hero fade">
    <div><div class="hero-txt"><h2>Pass the Bar.<br><em>One topic at a time.</em></h2>
    <p>Upload your Bar Syllabus in Admin ‚Äî all lessons and quizzes pre-generate automatically, grounded in your uploaded reference materials.</p></div>
    <div class="hero-btns">
      <button class="btn-gold" onclick="nav('learn',document.getElementById('tab-learn'))">üìñ Start Learning</button>
      <button class="btn-mock" onclick="nav('mockbar',document.getElementById('tab-mockbar'))">‚è± Mock Bar</button>
      <button class="btn-og" onclick="nav('admin',document.getElementById('tab-admin'))">‚öôÔ∏è Manage KB</button>
    </div></div>
    <div class="hero-stats">
      <div class="hst"><div class="hst-n" id="h-ready">0</div><div class="hst-l">Ready Topics</div></div>
      <div class="hst"><div class="hst-n" id="h-done">0</div><div class="hst-l">Qs Done</div></div>
      <div class="hst"><div class="hst-n" id="h-mock">0</div><div class="hst-l">Mock Sessions</div></div>
    </div>
  </div>
  <div class="stat-row fade">
    <div class="stt"><div class="stt-ic ic-g">üìö</div><div><div class="stt-n" id="st-topics">0</div><div class="stt-l">Pre-gen Topics</div></div></div>
    <div class="stt"><div class="stt-ic ic-b">‚úçÔ∏è</div><div><div class="stt-n" id="st-refs">0</div><div class="stt-l">References</div></div></div>
    <div class="stt"><div class="stt-ic ic-r">‚öñÔ∏è</div><div><div class="stt-n" id="st-score">‚Äî</div><div class="stt-l">Avg Score</div></div></div>
    <div class="stt"><div class="stt-ic ic-t">üìú</div><div><div class="stt-n" id="st-pb">0</div><div class="stt-l">Past Bar Qs</div></div></div>
  </div>
  <!-- Recent activity -->
  <div class="card fade">
    <div class="card-h"><div class="card-title">üìñ Recently Studied</div><button class="btn-og" style="font-size:11px;padding:5px 11px;" onclick="nav('learn',document.getElementById('tab-learn'))">Go to Learn ‚Üí</button></div>
    <div class="card-b" id="recent-list">
      <div style="text-align:center;padding:24px 0;color:var(--muted);">
        <div style="font-size:36px;margin-bottom:10px;">‚öñÔ∏è</div>
        <div style="font-family:var(--fd);font-size:16px;color:var(--gold-l);margin-bottom:5px;">No activity yet</div>
        <div style="font-size:12px;margin-bottom:16px;">Upload materials in Admin to generate your study plan.</div>
        <button class="btn-gold" onclick="nav('admin',document.getElementById('tab-admin'))">‚öôÔ∏è Go to Admin</button>
      </div>
    </div>
  </div>
  <div class="card fade">
    <div class="card-h"><div class="card-title">üèõ Bar Subjects Coverage</div></div>
    <div class="card-b" id="sub-tracker"></div>
  </div>
</div>
<div class="right-col">
  <div class="kb-card" id="kb-dash-card">
    <div style="font-family:var(--fd);font-size:16px;font-weight:700;color:var(--teal);margin-bottom:10px;display:flex;align-items:center;gap:7px;">üìö Knowledge Base</div>
    <div id="kb-dash-list"><div style="font-size:12px;color:var(--muted);">No materials loaded.</div></div>
    <button class="btn-og" style="width:100%;justify-content:center;margin-top:10px;font-size:11px;" onclick="nav('admin',document.getElementById('tab-admin'))">‚öôÔ∏è Manage KB</button>
  </div>
  <div class="rc"><div class="rc-h">‚ö° Quick Actions</div><div class="rc-b">
    <button class="act" onclick="nav('learn',document.getElementById('tab-learn'))"><span>üìñ</span><span style="flex:1;">Browse Lessons</span><span style="color:var(--muted);font-size:11px;">‚Ä∫</span></button>
    <button class="act" onclick="nav('practice',document.getElementById('tab-practice'))"><span>‚úçÔ∏è</span><span style="flex:1;">Practice Quiz</span><span style="color:var(--muted);font-size:11px;">‚Ä∫</span></button>
    <button class="act" onclick="nav('mockbar',document.getElementById('tab-mockbar'))"><span>‚è±</span><span style="flex:1;">Mock Bar Session</span><span style="color:var(--muted);font-size:11px;">‚Ä∫</span></button>
    <button class="act" onclick="nav('admin',document.getElementById('tab-admin'))"><span>‚öôÔ∏è</span><span style="flex:1;">Upload References</span><span style="color:var(--muted);font-size:11px;">‚Ä∫</span></button>
    <button class="act" onclick="openChatModal()"><span>üí¨</span><span style="flex:1;">Ask AI Tutor</span><span style="color:var(--muted);font-size:11px;">‚Ä∫</span></button>
  </div></div>
</div>
</div></div>
</div>

<!-- ‚ïê‚ïê‚ïê LEARN ‚ïê‚ïê‚ïê -->
<div class="page" id="page-learn">
<div class="split-layout">
  <aside class="panel-l">
    <div class="pl-head">
      <h3>üìñ Syllabus</h3>
      <input class="sp-search" type="text" placeholder="Search topics‚Ä¶" oninput="filterTopics(this.value)" id="topicSearch">
      <div class="prog-mini">
        <div class="prog-row"><span class="prog-lbl">Completion</span><span class="prog-pct" id="learn-pct">0%</span></div>
        <div class="prog-track"><div class="prog-fill" id="learn-fill" style="width:0%"></div></div>
      </div>
    </div>
    <div class="tree" id="syllabusTree">
      <div style="padding:20px 12px;text-align:center;color:var(--muted);font-size:12px;line-height:1.6;"><div style="font-size:28px;margin-bottom:8px;opacity:.4;">üìã</div>Upload Bar Syllabus in Admin.</div>
    </div>
    <div class="up-btn" onclick="nav('admin',document.getElementById('tab-admin'))">‚öôÔ∏è Manage Knowledge Base</div>
  </aside>
  <div class="panel-r">
    <div class="pr-top" id="lpTopbar" style="display:none;">
      <div class="pr-bc" id="lpBC"></div>
      <div style="display:flex;gap:7px;">
        <button class="btn-og" style="font-size:11px;" onclick="markDone()">‚úì Mark Done</button>
        <button class="btn-og" style="font-size:11px;" onclick="goToPractice()">Take Quiz ‚Üí</button>
      </div>
    </div>
    <div class="pr-content" id="lpContent">
      <div class="welcome-st"><div class="big-ic">üìñ</div><h3>Welcome to Learn</h3><p>Upload your Bar Syllabus in Admin ‚Äî all topics are pre-generated instantly. Click any topic to load it from cache.</p><button class="btn-gold" onclick="nav('admin',document.getElementById('tab-admin'))">‚öôÔ∏è Upload Materials</button></div>
    </div>
    <div id="lpFooter" style="display:none;" class="pr-foot">
      <div style="font-size:12px;color:var(--muted);font-family:var(--fm);" id="lpPgInfo">Page 1 of 1</div>
      <div style="display:flex;gap:8px;">
        <button class="btn-ghost" id="lpPrev" onclick="chgPage(-1)">‚Üê Prev</button>
        <button class="btn-gold" id="lpNext" onclick="chgPage(1)">Next ‚Üí</button>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê PRACTICE ‚ïê‚ïê‚ïê -->
<div class="page" id="page-practice">
<div class="split-layout">
  <aside class="panel-l">
    <div class="pl-head">
      <h3>‚úçÔ∏è Practice</h3>
      <div class="q-type-tabs">
        <div class="qtt on" id="qmode-mcq" onclick="setQMode('mcq')"><span class="qtt-ic">üîò</span>MCQ</div>
        <div class="qtt" id="qmode-essay" onclick="setQMode('essay')"><span class="qtt-ic">‚úçÔ∏è</span>Essay</div>
      </div>
    </div>
    <div class="qn-list" id="quizList">
      <div style="padding:16px 12px;text-align:center;color:var(--muted);font-size:12px;line-height:1.6;"><div style="font-size:22px;margin-bottom:6px;opacity:.4;">‚úçÔ∏è</div>Upload syllabus to pre-generate quizzes.</div>
    </div>
  </aside>
  <div style="display:flex;flex-direction:column;overflow:hidden;">
    <div id="qmHead" style="display:none;padding:13px 24px;align-items:center;gap:10px;background:var(--ink2);border-bottom:1px solid var(--bdr2);">
      <div style="font-family:var(--fd);font-size:19px;font-weight:700;color:var(--gold-l);flex:1;" id="qmTitle">Quiz</div>
      <div style="font-size:11px;color:var(--muted);font-family:var(--fm);" id="qmMeta"></div>
      <button class="btn-og" style="font-size:11px;" onclick="resetQuiz()">‚Ü∫ Restart</button>
    </div>
    <div class="qm-body" id="qmBody">
      <div class="welcome-st"><div class="big-ic">‚úçÔ∏è</div><h3>Practice Makes Perfect</h3><p>All quizzes are pre-generated when you upload the syllabus. Select a topic's MCQ or essay set from the left panel.</p><button class="btn-gold" onclick="nav('admin',document.getElementById('tab-admin'))">‚öôÔ∏è Upload Syllabus</button></div>
    </div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê MOCK BAR ‚ïê‚ïê‚ïê -->
<div class="page" id="page-mockbar">
<div class="pg-inner">
  <div id="mockConfig">
    <div class="mock-hero fade">
      <div style="font-size:36px;margin-bottom:10px;">‚è±üèõ</div>
      <h2>Mock <em>Bar Examination</em></h2>
      <p>Simulate the actual Philippine Bar Exam. Questions are drawn from your uploaded <strong>past bar exam materials</strong> and your <strong>pre-generated question bank</strong> built from uploaded reference materials ‚Äî for an authentic bar exam experience grounded in your study materials.</p>
      <div class="mock-config-grid">
        <div class="mc-card"><div class="mc-label">Questions</div>
          <select class="mc-select" id="mc-qcount">
            <option value="5">5 questions (Quick)</option>
            <option value="10">10 questions</option>
            <option value="20" selected>20 questions (Full)</option>
          </select>
        </div>
        <div class="mc-card"><div class="mc-label">Time Limit</div>
          <select class="mc-select" id="mc-time">
            <option value="0">No time limit</option>
            <option value="60">1 hour</option>
            <option value="120">2 hours</option>
            <option value="180">3 hours (Full Bar)</option>
          </select>
        </div>
        <div class="mc-card"><div class="mc-label">Subjects</div>
          <div style="display:flex;flex-wrap:wrap;gap:5px;" id="mc-subjects">
            <span class="mc-subj-tag on" data-key="all" onclick="toggleMockSubj(this)">All</span>
            <span class="mc-subj-tag" data-key="civil" onclick="toggleMockSubj(this)">Civil</span>
            <span class="mc-subj-tag" data-key="criminal" onclick="toggleMockSubj(this)">Criminal</span>
            <span class="mc-subj-tag" data-key="political" onclick="toggleMockSubj(this)">Political</span>
            <span class="mc-subj-tag" data-key="labor" onclick="toggleMockSubj(this)">Labor</span>
            <span class="mc-subj-tag" data-key="commercial" onclick="toggleMockSubj(this)">Commercial</span>
            <span class="mc-subj-tag" data-key="taxation" onclick="toggleMockSubj(this)">Taxation</span>
            <span class="mc-subj-tag" data-key="remedial" onclick="toggleMockSubj(this)">Remedial</span>
            <span class="mc-subj-tag" data-key="ethics" onclick="toggleMockSubj(this)">Ethics</span>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <button class="btn-mock" onclick="startMockBar()" id="startMockBtn">‚è± Begin Mock Bar</button>
        <div id="mockSourceStats" class="source-stats"></div>
      </div>
      <div id="mockStartError" style="display:none;margin-top:10px;padding:10px 14px;background:rgba(224,112,128,.12);border:1px solid rgba(224,112,128,.35);border-radius:10px;color:#e07080;font-size:13px;"></div>
    </div>
    <!-- Past bar status -->
    <div class="card fade" style="margin-top:14px;">
      <div class="card-h"><div class="card-title">üìú Past Bar Materials</div><button class="btn-og" style="font-size:11px;" onclick="nav('admin',document.getElementById('tab-admin'))">+ Upload Past Bar</button></div>
      <div class="card-b" id="pb-list"><div style="font-size:13px;color:var(--muted);text-align:center;padding:14px 0;">No past bar materials uploaded.</div></div>
    </div>
  </div>
  <!-- Active session -->
  <div class="mock-session" id="mockSession">
    <div class="ms-header">
      <div><div class="ms-q-num" id="ms-qnum">Q1</div><div class="ms-of" id="ms-of">of 20</div></div>
      <div style="flex:1;max-width:220px;padding:0 18px;">
        <div class="pb-track" style="height:4px;"><div class="pb-fill" id="ms-prog" style="width:0%;background:linear-gradient(90deg,#d4621a,#ff8c42);"></div></div>
      </div>
      <div id="ms-src"></div>
      <div class="ms-timer" id="ms-timer" style="display:none;">‚è± <span id="timer-val"></span></div>
      <button class="btn-og" onclick="endMockSession()" style="font-size:11px;border-color:rgba(255,140,66,.4);color:#ff8c42;">End &amp; Score</button>
    </div>
    <div class="q-markers" id="qMarkers"></div>
    <div id="mockQArea"></div>
  </div>
  <div id="mockResults" style="display:none;"></div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê ADMIN ‚ïê‚ïê‚ïê -->
<div class="page" id="page-admin">
<div class="pg-inner">
  <div style="margin-bottom:18px;">
    <h2 style="font-family:var(--fd);font-size:28px;font-weight:700;color:var(--gold-l);margin-bottom:5px;">‚öôÔ∏è Knowledge Base Admin</h2>
    <p style="font-size:13px;color:var(--muted);line-height:1.6;">Upload materials once ‚Äî stored server-side, cached in your browser for speed. Uploading the syllabus automatically pre-generates all lessons and quizzes in the background.</p>
  </div>
  <div style="display:flex;gap:8px;margin-bottom:18px;align-items:center;">
    <input type="password" id="adminKeyInput" placeholder="Admin key" style="flex:1;background:rgba(255,255,255,.05);border:1px solid var(--bdr2);border-radius:9px;padding:9px 12px;color:var(--white);font-family:var(--fm);font-size:13px;outline:none;max-width:320px;">
    <button class="btn-gold" onclick="unlockAdmin()">Unlock</button>
    <span id="adminStatus" style="font-size:12px;color:var(--muted);"></span>
  </div>
  <div id="adminLocked" class="admin-locked"><div style="font-size:48px;margin-bottom:14px;">üîí</div><div style="font-family:var(--fd);font-size:20px;color:var(--gold-l);margin-bottom:6px;">Admin Access Required</div><div style="font-size:13px;">Enter your admin key above.</div></div>
  <div id="adminUnlocked" style="display:none;">
    <!-- Pre-gen status -->
    <div id="adminGenPanel" style="display:none;" class="gen-prog-panel">
      <div class="gpp-head"><div class="spin" style="width:20px;height:20px;border-width:2px;border-top-color:#ff8c42;border-color:rgba(255,140,66,.2);"></div><div class="gpp-title">Pre-generating all lessons &amp; quizzes‚Ä¶</div></div>
      <div class="gpp-track"><div class="gpp-fill" id="gppFill" style="width:0%"></div></div>
      <div class="gpp-meta"><span id="gppDone">0</span>/<span id="gppTotal">0</span> topics complete</div>
      <div class="gpp-cur" id="gppCur"></div>
    </div>
    <div id="adminGenDone" style="display:none;" class="gen-prog-panel" style="border-color:rgba(20,180,160,.25);background:linear-gradient(135deg,#040e08,#081410);">
      <div class="gpp-head">‚úÖ <div class="gpp-title" style="color:var(--teal);">All content pre-generated!</div></div>
      <div class="gpp-meta" id="adminGenDoneMeta">All topics ready. Lessons and quizzes load instantly.</div>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="btn-gold" onclick="nav('learn',document.getElementById('tab-learn'))" style="font-size:12px;padding:7px 14px;">üìñ Go to Learn</button>
        <button class="btn-og" style="font-size:11px;" onclick="retriggerGen()">‚Ü∫ Regenerate All</button>
      </div>
    </div>
    <div class="admin-grid">
      <!-- SYLLABUS -->
      <div class="admin-panel">
        <h3>üìã Bar Exam Syllabus</h3>
        <p>Upload once. Claude parses all subjects and topics, populates the Learn sidebar, and <strong>immediately kicks off pre-generation</strong> of all lessons and quizzes in the background.</p>
        <div id="syllabusStatus" style="padding:10px;background:rgba(255,255,255,.04);border-radius:8px;margin-bottom:12px;font-size:12px;color:var(--muted);">No syllabus uploaded yet.</div>
        <label class="form-label">Name</label>
        <input class="form-input" id="syl-name" placeholder="e.g. 2025 Bar Exam Syllabus">
        <label class="form-label">Content (paste or upload file)</label>
        <textarea class="form-input" id="syl-content" rows="5" placeholder="Paste syllabus text here‚Ä¶" style="resize:vertical;"></textarea>
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <input type="file" id="syl-file" accept=".txt,.md,.pdf,.doc,.docx" style="display:none;" onchange="readFile(this,'syl-content')">
          <button class="btn-og" onclick="document.getElementById('syl-file').click()">üìÑ Upload File</button>
        </div>
        <div id="syl-status"></div>
        <button class="btn-gold" onclick="uploadSyllabus()" style="width:100%;justify-content:center;">üìã Save &amp; Pre-generate</button>
      </div>
      <!-- REFERENCES -->
      <div class="admin-panel">
        <h3>üìÇ Reference Materials</h3>
        <p>Upload reviewers, codals, digests, lecture notes. Stored server-side, used as context when generating lessons and quiz questions. Adding a reference re-generates the affected subject.</p>
        <label class="form-label">Name</label>
        <input class="form-input" id="ref-name" placeholder="e.g. Civil Code Reviewer">
        <label class="form-label">Subject</label>
        <select class="form-select" id="ref-subject">
          <option value="general">General (all subjects)</option>
          <option value="civil">Civil Law</option><option value="criminal">Criminal Law</option>
          <option value="political">Political Law</option><option value="labor">Labor Law</option>
          <option value="commercial">Commercial Law</option><option value="taxation">Taxation</option>
          <option value="remedial">Remedial Law</option><option value="ethics">Legal Ethics</option>
        </select>
        <label class="form-label">Type</label>
        <select class="form-select" id="ref-type">
          <option value="reviewer">Reviewer book</option><option value="codal">Codal / statutes</option>
          <option value="digest">Case digest</option><option value="notes">Lecture notes</option><option value="other">Other</option>
        </select>
        <label class="form-label">Content</label>
        <textarea class="form-input" id="ref-content" rows="4" placeholder="Paste or upload‚Ä¶" style="resize:vertical;"></textarea>
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <input type="file" id="ref-file" accept=".txt,.md,.pdf,.doc,.docx" style="display:none;" onchange="readFile(this,'ref-content')">
          <button class="btn-og" onclick="document.getElementById('ref-file').click()">üìÑ Upload File</button>
        </div>
        <div id="ref-status"></div>
        <button class="btn-gold" onclick="uploadReference()" style="width:100%;justify-content:center;">üìÇ Save Reference</button>
      </div>
      <!-- PAST BAR -->
      <div class="admin-panel">
        <h3>üìú Past Bar Questions</h3>
        <p>Upload past bar exams with suggested answers. Claude extracts structured Q&A. Questions appear in Mock Bar sessions as authentic past bar items with source attribution.</p>
        <label class="form-label">Name</label>
        <input class="form-input" id="pb-name" placeholder="e.g. 2023 Bar ‚Äî Civil Law">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <div>
            <label class="form-label">Subject</label>
            <select class="form-select" id="pb-subject">
              <option value="general">All subjects</option>
              <option value="civil">Civil Law</option><option value="criminal">Criminal Law</option>
              <option value="political">Political Law</option><option value="labor">Labor Law</option>
              <option value="commercial">Commercial Law</option><option value="taxation">Taxation</option>
              <option value="remedial">Remedial Law</option><option value="ethics">Legal Ethics</option>
            </select>
          </div>
          <div><label class="form-label">Year</label><input class="form-input" id="pb-year" placeholder="e.g. 2023"></div>
        </div>
        <label class="form-label">Content</label>
        <textarea class="form-input" id="pb-content" rows="4" placeholder="Paste bar exam Q&A or upload file‚Ä¶" style="resize:vertical;"></textarea>
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <input type="file" id="pb-file" accept=".txt,.md,.pdf,.doc,.docx" style="display:none;" onchange="readFile(this,'pb-content')">
          <button class="btn-og" onclick="document.getElementById('pb-file').click()">üìÑ Upload File</button>
        </div>
        <div id="pb-status"></div>
        <button class="btn-gold" onclick="uploadPastBar()" style="width:100%;justify-content:center;">üìú Save Past Bar</button>

        <div class="manual-divider">Or Add Questions Manually</div>
        <div class="mn-note">üí° Manual entry saves instantly with no AI processing ‚Äî use this to add questions one by one with full control over the fact pattern, suggested answer, and key points.</div>

        <label class="form-label">Question Number</label>
        <input class="form-input" id="mn-num" type="number" value="1" min="1">
        <label class="form-label">Question Type</label>
        <div class="mn-radio-group">
          <label><input type="radio" name="mn-type" value="situational" checked onchange="toggleManualContext()"> Situational (has fact pattern)</label>
          <label><input type="radio" name="mn-type" value="conceptual" onchange="toggleManualContext()"> Conceptual (define/distinguish)</label>
        </div>
        <div id="mn-context-wrap">
          <label class="form-label">Fact Pattern / Context</label>
          <textarea class="form-input" id="mn-context" rows="4" placeholder="Full facts of the case ‚Äî all parties, events, and circumstances‚Ä¶" style="resize:vertical;"></textarea>
        </div>
        <label class="form-label">Question</label>
        <textarea class="form-input" id="mn-q" rows="3" placeholder="The actual question asked (e.g. Is X liable? What are the rights of Y?)" style="resize:vertical;"></textarea>
        <label class="form-label">Suggested Answer</label>
        <textarea class="form-input" id="mn-answer" rows="5" placeholder="Model answer (ideally in ALAC format)‚Ä¶" style="resize:vertical;"></textarea>
        <label class="form-label">Key Legal Points (one per line)</label>
        <textarea class="form-input" id="mn-points" rows="3" placeholder="Article 94, Labor Code&#10;G.R. No. 12345&#10;Doctrine of‚Ä¶" style="resize:vertical;"></textarea>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <div>
            <label class="form-label">Subject</label>
            <select class="form-select" id="mn-subject">
              <option value="general">All subjects</option>
              <option value="civil">Civil Law</option><option value="criminal">Criminal Law</option>
              <option value="political">Political Law</option><option value="labor">Labor Law</option>
              <option value="commercial">Commercial Law</option><option value="taxation">Taxation</option>
              <option value="remedial">Remedial Law</option><option value="ethics">Legal Ethics</option>
            </select>
          </div>
          <div><label class="form-label">Year</label><input class="form-input" id="mn-year" placeholder="e.g. 2023"></div>
        </div>
        <label class="form-label">Batch Name</label>
        <input class="form-input" id="mn-name" placeholder="e.g. 2023 Bar ‚Äî Civil Law (Manual)">
        <div id="mn-preview" class="mn-preview"></div>
        <div id="mn-status"></div>
        <div style="display:flex;gap:8px;margin-top:4px;">
          <button class="btn-og" onclick="addManualQ()" style="flex:1;justify-content:center;">+ Add to Batch</button>
          <button class="btn-gold" onclick="saveManualBatch()" style="flex:1;justify-content:center;">üíæ Save All</button>
        </div>
      </div>
      <!-- CURRENT KB -->
      <div class="admin-panel">
        <h3>üìö Current Knowledge Base</h3>
        <p>All uploaded materials stored on the server. Content is cached in your browser for instant access across sessions.</p>
        <div id="adminKbList"><div style="font-size:12px;color:var(--muted);">Loading‚Ä¶</div></div>
        <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn-og" onclick="retriggerGen()" style="font-size:11px;">‚Ü∫ Re-generate All</button>
          <button class="btn-og" onclick="clearContent()" style="font-size:11px;border-color:rgba(155,35,53,.4);color:#e07080;">üóë Clear Content Cache</button>
        </div>
        <div id="storageIndicator" style="margin-top:14px;padding:10px 13px;border-radius:10px;background:rgba(255,255,255,.04);border:1px solid var(--bdr2);font-size:12px;color:var(--muted);">
          Checking storage‚Ä¶
        </div>
      </div>
    </div>
  </div>
</div>
</div>

</div><!-- .main -->

<!-- CHAT MODAL -->
<div class="overlay" id="chatOverlay">
<div class="modal">
  <button class="modal-x" onclick="closeModal('chatOverlay')">‚úï</button>
  <div class="modal-t">üí¨ BarBuddy AI Tutor</div>
  <p class="modal-s">Ask anything about Philippine law or bar exam topics. I'll cite specific articles and G.R. numbers.</p>
  <div class="chat-box" id="chatBox">
    <div class="msg-ai">‚öñÔ∏è Mabuhay! I'm BarBuddy. Ask me about any Bar subject ‚Äî Civil, Criminal, Political, Labor, Commercial, Taxation, Remedial, or Legal Ethics. I cite specific articles and G.R. numbers!</div>
  </div>
  <div class="chat-row">
    <input class="chat-in" id="chatInput" type="text" placeholder="Ask about any bar topic‚Ä¶" onkeydown="if(event.key==='Enter')sendChat()">
    <button class="btn-gold" id="chatBtn" onclick="sendChat()">Send</button>
  </div>
</div>
</div>

<!-- EMAIL RESULTS MODAL -->
<div class="overlay" id="emailOverlay">
<div class="modal" style="max-width:460px;">
  <button class="modal-x" onclick="closeModal('emailOverlay')">‚úï</button>
  <div class="modal-t">üìß Email Results</div>
  <p class="modal-s">Send your mock bar results to an email address.</p>
  <label class="form-label" style="margin-top:4px;">Email Address</label>
  <input class="form-input" id="email-to" type="email" placeholder="you@example.com" style="margin-bottom:10px;">
  <label class="form-label">Subject Line</label>
  <input class="form-input" id="email-subject" type="text" style="margin-bottom:10px;">
  <div id="email-status" style="display:none;font-size:13px;padding:8px 12px;border-radius:8px;margin-bottom:10px;"></div>
  <div style="display:flex;gap:8px;margin-top:4px;">
    <button class="btn-gold" id="emailSendBtn" onclick="sendEmailResults()" style="flex:1;justify-content:center;">üìß Send Results</button>
    <button class="btn-ghost" onclick="closeModal('emailOverlay')">Cancel</button>
  </div>
</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let KB = { hasSyllabus:false, syllabusTopics:[], references:[], pastBar:[], contentTopics:0, genState:{} };
let CACHE = {};          // browser-side content cache: { [subj]: { [topic]: {lesson,mcq,essay} } }
const VISITED = [];      // [{subjKey, topicName, title, type}] ‚Äî recent activity
let totalQDone=0, totalCorrect=0, mockSessions=0;
let curSubj=null, curTopic=null, curPage=0;
let quizPool=[];         // flat list of {type,subject,topic,data} loaded from CACHE for practice panel
let activeQuiz=null, qIdx=0, qScore=0, qMode='mcq';
let chatHistory=[];
let mockQs=[], mockIdx=0, mockAnswers=[], mockTimer=null, mockLeft=0;
let mockScores=[], mockSubjectsUsed=[], mockSessionDate=null;
let manualBatch=[], manualQNum=1;
let adminKey='', sseSource=null;

const SUBJS=[
  {key:'civil',name:'Civil Law',cls:'sg-civ',f:'bf-g'},
  {key:'criminal',name:'Criminal Law',cls:'sg-cri',f:'bf-r'},
  {key:'political',name:'Political Law',cls:'sg-pol',f:'bf-b'},
  {key:'labor',name:'Labor & Social Leg.',cls:'sg-lab',f:'bf-t'},
  {key:'commercial',name:'Commercial Law',cls:'sg-com',f:'bf-g'},
  {key:'taxation',name:'Taxation',cls:'sg-tax',f:'bf-r'},
  {key:'remedial',name:'Remedial Law',cls:'sg-rem',f:'bf-t'},
  {key:'ethics',name:'Legal Ethics',cls:'sg-eth',f:'bf-b'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
  loadLocalCache();
  renderSubjectTracker();
  await loadKB();
  subscribeToProgress();
  checkAPIStatus();
}

async function checkAPIStatus(){
  try{
    const r=await fetch('/api/status');
    const d=await r.json();
    document.getElementById('apiBanner').style.display=d.apiOk?'none':'block';
  }catch(e){}
}
init();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOCAL BROWSER CACHE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LS_KEY = 'barbuddy_cache_v3';
const LS_VISITED = 'barbuddy_visited';

function loadLocalCache() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (raw) { CACHE = JSON.parse(raw); console.log('Cache loaded:', Object.values(CACHE).reduce((a,s)=>a+Object.keys(s).length,0), 'topics'); }
    const vis = localStorage.getItem(LS_VISITED);
    if (vis) VISITED.splice(0,0,...JSON.parse(vis));
  } catch(e) { console.warn('Cache load:', e.message); }
}

function saveLocalCache() {
  try { localStorage.setItem(LS_KEY, JSON.stringify(CACHE)); } catch(e) { console.warn('Cache save:', e.message); }
}

function saveCacheItem(subj, topic, data) {
  if (!CACHE[subj]) CACHE[subj] = {};
  CACHE[subj][topic] = data;
  saveLocalCache();
}

function getCached(subj, topic) {
  return CACHE[subj]?.[topic] || null;
}

async function syncCacheFromServer() {
  try {
    const r = await fetch('/api/content');
    const serverContent = await r.json();
    // Merge server content into local cache
    let merged = 0;
    Object.entries(serverContent).forEach(([subj, topics]) => {
      Object.entries(topics).forEach(([topic, data]) => {
        if (!getCached(subj, topic)) { saveCacheItem(subj, topic, data); merged++; }
      });
    });
    if (merged > 0) { console.log('Synced', merged, 'topics from server'); buildQuizPool(); renderSyllabusTree(); }
  } catch(e) { console.warn('Sync:', e.message); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SERVER STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadKB() {
  try {
    const r = await fetch('/api/kb');
    KB = await r.json();
    updateKBIndicator();
    renderSyllabusTree();
    buildQuizPool();
    updateDash();
    renderPastBarList();
    // Sync any server content not in local cache
    if (KB.contentTopics > 0) syncCacheFromServer();
  } catch(e) { console.warn('KB load:', e.message); }
}

function updateKBIndicator() {
  const ind = document.getElementById('kbInd'), txt = document.getElementById('kbIndTxt');
  const gs = KB.genState;
  const n = Object.values(CACHE).reduce((a,s)=>a+Object.keys(s).length, 0);
  if (gs?.running) { ind.className='kb-ind generating'; txt.textContent=`Generating ${gs.done||0}/${gs.total||0}`; }
  else if (n > 0) { ind.className='kb-ind loaded'; txt.textContent=`${n} topics ready`; }
  else if (KB.hasSyllabus) { ind.className='kb-ind generating'; txt.textContent='Generating‚Ä¶'; }
  else { ind.className='kb-ind empty'; txt.textContent='No KB'; }

  // Update stat cards
  document.getElementById('st-topics').textContent = n;
  document.getElementById('st-refs').textContent   = KB.references?.length || 0;
  document.getElementById('st-pb').textContent     = KB.pastBar?.reduce((a,p)=>a+(p.qCount||0),0) || 0;
  document.getElementById('h-ready').textContent   = n;

  // KB dash card
  const all = [
    ...(KB.hasSyllabus ? [{name:KB.syllabusName||'Syllabus',type:'syllabus',subject:'all'}] : []),
    ...(KB.references||[]),
    ...(KB.pastBar||[]),
  ];
  document.getElementById('kb-dash-list').innerHTML = all.length
    ? all.slice(0,6).map(i=>`<div class="kb-item"><span>${i.type==='syllabus'?'üìã':i.qCount!==undefined?'üìú':'üìÇ'}</span><div><div style="font-size:12px;font-weight:600;">${h(i.name)}</div><div style="font-size:10px;color:var(--muted);">${i.subject||''} ${i.year?'¬∑'+i.year:''} ${i.qCount!==undefined?'¬∑'+i.qCount+' Qs':''}</div></div></div>`).join('')
    : '<div style="font-size:12px;color:var(--muted);">No materials loaded.</div>';

  // Mock source stats
  const pbTotal = KB.pastBar?.reduce((a,p)=>a+(p.qCount||0),0)||0;
  const pgTotal = Object.values(CACHE).reduce((a,s)=>a+Object.keys(s).length,0);
  document.getElementById('mockSourceStats').innerHTML = `
    <span class="src-badge sb-real">üìú ${pbTotal} Past Bar Qs</span>
    <span class="src-badge sb-pregen">üìö ${pgTotal} Pre-gen Topics</span>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SSE ‚Äî LIVE GENERATION PROGRESS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function subscribeToProgress() {
  if (sseSource) sseSource.close();
  sseSource = new EventSource('/api/gen/progress');
  sseSource.onmessage = e => {
    const d = JSON.parse(e.data);
    updateProgressUI(d);
    if (d.finished || (!d.running && d.done > 0)) {
      // Generation done ‚Äî sync cache
      setTimeout(() => syncCacheFromServer(), 1000);
      KB.genState = d;
      updateKBIndicator();
    }
  };
  sseSource.onerror = () => { sseSource.close(); setTimeout(subscribeToProgress, 5000); };
}

function updateProgressUI(d) {
  const banner = document.getElementById('pregenBanner');
  const adminPanel = document.getElementById('adminGenPanel');
  const adminDone  = document.getElementById('adminGenDone');

  if (d.running) {
    const pct = d.total ? Math.round(d.done/d.total*100) : 0;
    banner.classList.add('on');
    document.getElementById('pbFill').style.width = pct + '%';
    document.getElementById('pbDone').textContent = d.done;
    document.getElementById('pbTotal').textContent = d.total;
    document.getElementById('pbCur').textContent = d.current || '';
    if (adminPanel) { adminPanel.style.display='block'; adminDone.style.display='none'; }
    document.getElementById('gppFill').style.width = pct + '%';
    document.getElementById('gppDone').textContent = d.done;
    document.getElementById('gppTotal').textContent = d.total;
    document.getElementById('gppCur').textContent = d.current || '';
  } else {
    banner.classList.remove('on');
    if (d.finished) {
      if (adminPanel) { adminPanel.style.display='none'; adminDone.style.display='block'; }
      document.getElementById('adminGenDoneMeta').textContent = `${d.done} topics generated. ${d.errors || 0} errors.`;
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function nav(id, btn) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.tb-tab,.s-btn').forEach(b=>b.classList.remove('on'));
  document.getElementById('page-'+id).classList.add('on');
  if (btn) btn.classList.add('on');
  const map={dashboard:0,learn:1,practice:2,mockbar:3,admin:5};
  const sb=document.querySelectorAll('.s-btn');
  if (map[id]!==undefined&&sb[map[id]]) sb[map[id]].classList.add('on');
  document.getElementById('tab-'+id)?.classList.add('on');
}
const openModal  = id => document.getElementById(id).classList.add('on');
const closeModal = id => document.getElementById(id).classList.remove('on');
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('on');}));
function openChatModal(){openModal('chatOverlay');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SYLLABUS TREE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSyllabusTree(filter='') {
  const tree = document.getElementById('syllabusTree');
  if (!KB.hasSyllabus && !KB.syllabusTopics?.length) {
    tree.innerHTML=`<div style="padding:20px 12px;text-align:center;color:var(--muted);font-size:12px;line-height:1.6;"><div style="font-size:28px;margin-bottom:8px;opacity:.4;">üìã</div>Upload Bar Syllabus in Admin.</div>`;
    return;
  }
  const fl = filter.toLowerCase();
  let html='', tAll=0, tDone=0;
  (KB.syllabusTopics||[]).forEach(subj => {
    const sub = SUBJS.find(s=>s.key===subj.key)||{name:subj.name||subj.key,cls:'sg-gen'};
    const items = (subj.topics||[]).filter(t=>!fl||t.name.toLowerCase().includes(fl));
    if (!items.length) return;
    tAll+=items.length;
    const hasRef = KB.references?.some(r=>r.subject===subj.key||r.subject==='general');
    html+=`<div>
      <div class="subj-hdr open" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
        <span class="chev">‚ñ∂</span><span class="subj-label">${h(sub.name)}</span>
        ${hasRef?'<span style="font-size:9px;color:var(--teal);" title="References loaded">üìö</span>':''}
        <span class="subj-cnt">${items.filter(t=>getCached(subj.key,t.name)).length}/${items.length}</span>
      </div>
      <div class="topic-list open">
        ${items.map(t => {
          const cached = getCached(subj.key,t.name);
          const genNow = KB.genState?.running && KB.genState?.current?.includes(t.name);
          return `<div class="topic-item${cached?' done':''}" onclick="clickTopic('${h(subj.key)}','${h(t.name)}')">
            <span class="t-chk">${cached?'‚úì':'‚óã'}</span>
            <span class="t-lbl">${h(t.name)}</span>
            ${genNow?'<span class="ready-badge rb-gen">gen‚Ä¶</span>':cached?'<span class="ready-badge rb-cached">cached</span>':''}
          </div>`;
        }).join('')}
      </div>
    </div>`;
    tDone+=items.filter(t=>getCached(subj.key,t.name)).length;
  });
  tree.innerHTML=html||`<div style="padding:18px;text-align:center;color:var(--muted);font-size:12px;">No topics match.</div>`;
  const pct=tAll?Math.round(tDone/tAll*100):0;
  document.getElementById('learn-pct').textContent=pct+'%';
  document.getElementById('learn-fill').style.width=pct+'%';
}
function filterTopics(v){renderSyllabusTree(v);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LESSON VIEWER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function clickTopic(subjKey, topicName) {
  document.querySelectorAll('.topic-item').forEach(t=>t.classList.remove('active'));
  const el=document.querySelector(`.topic-item[onclick*="${CSS.escape(topicName)}"]`);
  if(el) el.classList.add('active');
  curSubj=subjKey; curTopic=topicName; curPage=0;
  const sub=SUBJS.find(s=>s.key===subjKey)||{name:subjKey,cls:'sg-gen'};
  document.getElementById('lpBC').innerHTML=`<span class="sbg ${sub.cls}">${h(sub.name)}</span> &nbsp;‚Ä∫&nbsp; <strong>${h(topicName)}</strong>`;
  document.getElementById('lpTopbar').style.display='flex';

  // 1) Check browser cache first
  let data = getCached(subjKey, topicName);
  if (data) { renderLesson(data, topicName, subjKey, 'cache'); return; }

  // 2) Try server
  document.getElementById('lpContent').innerHTML=`<div class="gen-state"><div class="spin"></div><div style="font-size:14px;color:var(--gold-l);">Loading from server‚Ä¶</div></div>`;
  document.getElementById('lpFooter').style.display='none';
  try {
    const r = await fetch(`/api/content/${subjKey}/${encodeURIComponent(topicName)}`);
    const d = await r.json();
    if (d.found) { saveCacheItem(subjKey, topicName, d); renderLesson(d, topicName, subjKey, 'server'); return; }
  } catch(e){}

  // 3) On-demand generation (fallback if pre-gen hasn't reached this yet)
  await genOnDemand(subjKey, topicName);
}

function renderLesson(data, topicName, subjKey, source) {
  const pages = data.lesson?.pages;
  if (!pages?.length) { document.getElementById('lpContent').innerHTML=`<div style="padding:30px;text-align:center;color:#e07080;">‚ö†Ô∏è No lesson content found. Try regenerating.</div>`; return; }
  const page = pages[curPage], total=pages.length;
  const sub=SUBJS.find(s=>s.key===subjKey)||{cls:'sg-gen',name:subjKey};
  const hasRef=KB.references?.some(r=>r.subject===subjKey||r.subject==='general');
  document.getElementById('lpContent').innerHTML=`<div class="lc">
    ${hasRef?`<div class="kb-ref-note">üìö Grounded in uploaded reference materials. ${source==='cache'?'Loaded from browser cache.':'Loaded from server.'}</div>`:''}
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
      <span class="sbg ${sub.cls}">${h(sub.name)}</span><span class="tag tg-l">Lesson</span>
      <span style="font-size:10px;color:var(--muted);margin-left:auto;font-family:var(--fm);">${source==='cache'?'üíæ cached':'üñ• server'}</span>
    </div>
    <h2>${h(topicName)}</h2>
    <div class="lc-meta">
      <span style="font-size:12px;color:var(--muted);font-family:var(--fm);">Page ${curPage+1} of ${total}</span>
      <div style="height:4px;width:110px;background:rgba(255,255,255,.07);border-radius:2px;overflow:hidden;">
        <div style="height:100%;width:${((curPage+1)/total)*100}%;background:linear-gradient(90deg,var(--gold-d),var(--gold));border-radius:2px;"></div>
      </div>
    </div>
    <h3>${h(page.title)}</h3>
    ${page.content}
  </div>`;
  document.getElementById('lpPgInfo').textContent=`Page ${curPage+1} of ${total}`;
  document.getElementById('lpPrev').disabled=curPage===0;
  document.getElementById('lpFooter').style.display='flex';
  const nxt=document.getElementById('lpNext');
  if (curPage<total-1){nxt.textContent='Next ‚Üí';nxt.onclick=()=>chgPage(1);}
  else{nxt.textContent='Done ‚úì';nxt.onclick=()=>{markDone();goToPractice();};}
  // Track visit
  const existing=VISITED.findIndex(v=>v.subjKey===subjKey&&v.topicName===topicName);
  if(existing>=0)VISITED.splice(existing,1);
  VISITED.unshift({subjKey,topicName,title:topicName,type:'lesson'});
  if(VISITED.length>12)VISITED.length=12;
  try{localStorage.setItem(LS_VISITED,JSON.stringify(VISITED));}catch(e){}
  updateDash();
}

async function genOnDemand(subjKey, topicName) {
  document.getElementById('lpContent').innerHTML=`<div class="gen-state"><div class="spin"></div><div style="font-size:14px;color:var(--gold-l);">Generating "${h(topicName)}"‚Ä¶</div><div style="font-size:12px;color:var(--muted);text-align:center;max-width:280px;">Pre-generation hasn't reached this topic yet. Generating now and caching for next time.</div></div>`;
  document.getElementById('lpFooter').style.display='none';
  const prompt=`Generate a complete Philippine Bar Exam study package for: "${topicName}" (${subjKey} law)

Respond ONLY with valid JSON (no markdown):
{
  "lesson":{"pages":[{"title":"Page 1: Overview","content":"Rich HTML with definition-box, case-box, codal-box, rule-box, tip-box divs"},{"title":"Page 2: Applications","content":"More cases and bar tips"}]},
  "mcq":{"questions":[{"q":"Bar MCQ","options":["A.","B.","C.","D."],"answer":0,"explanation":"Cite Art./G.R."},{"q":"...","options":["A.","B.","C.","D."],"answer":1,"explanation":"..."},{"q":"...","options":["A.","B.","C.","D."],"answer":2,"explanation":"..."},{"q":"...","options":["A.","B.","C.","D."],"answer":0,"explanation":"..."},{"q":"...","options":["A.","B.","C.","D."],"answer":3,"explanation":"..."}]},
  "essay":{"questions":[{"prompt":"Full bar essay question","context":"","modelAnswer":"Answer with citations","keyPoints":["Point 1","Point 2"]},{"prompt":"...","context":"","modelAnswer":"...","keyPoints":["..."]},{"prompt":"...","context":"","modelAnswer":"...","keyPoints":["..."]}]}
}`;
  try{
    const raw=await callAPI({messages:[{role:'user',content:prompt}],max_tokens:4096,subject:subjKey,topicName,mode:'lesson'});
    const data=JSON.parse(raw.replace(/^```json\s*/i,'').replace(/```$/,'').trim());
    saveCacheItem(subjKey,topicName,data);
    buildQuizPool();
    renderSyllabusTree(document.getElementById('topicSearch')?.value||'');
    renderLesson(data,topicName,subjKey,'generated');
  }catch(err){
    document.getElementById('lpContent').innerHTML=`<div style="padding:36px;text-align:center;color:#e07080;"><div style="font-size:36px;margin-bottom:10px;">‚ö†Ô∏è</div><p style="margin-bottom:14px;">${h(err.message)}</p><button class="btn-gold" onclick="genOnDemand('${subjKey}','${h(topicName)}')">Retry</button></div>`;
  }
}

function chgPage(d){
  const data=getCached(curSubj,curTopic);if(!data)return;
  curPage+=d;renderLesson(data,curTopic,curSubj,'cache');
}
function markDone(){document.querySelector('.topic-item.active')?.classList.add('done');}
function goToPractice(){
  nav('practice',document.getElementById('tab-practice'));
  const qi=quizPool.findIndex(q=>q.type===qMode&&q.subject===curSubj&&q.topic===curTopic);
  if(qi>=0)openQuizItem(qi);else renderQuizList();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUIZ POOL (from cache)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildQuizPool() {
  quizPool=[];
  Object.entries(CACHE).forEach(([subj,topics])=>{
    Object.entries(topics).forEach(([topic,data])=>{
      if(data.mcq?.questions?.length) quizPool.push({type:'mcq',subject:subj,topic,data:data.mcq});
      if(data.essay?.questions?.length) quizPool.push({type:'essay',subject:subj,topic,data:data.essay});
    });
  });
  renderQuizList();
  updateDash();
}

function setQMode(m){qMode=m;['mcq','essay'].forEach(x=>document.getElementById('qmode-'+x).classList.toggle('on',x===m));renderQuizList();}
function renderQuizList(){
  const list=document.getElementById('quizList');
  const items=quizPool.filter(q=>q.type===qMode);
  if(!items.length){list.innerHTML=`<div style="padding:16px 12px;text-align:center;color:var(--muted);font-size:12px;line-height:1.6;">No ${qMode} quizzes cached yet.</div>`;return;}
  list.innerHTML=items.map((q,i)=>{const sub=SUBJS.find(s=>s.key===q.subject)||{cls:'sg-gen',name:q.subject};
    return `<div class="qn-item${activeQuiz===i?' active':''}" onclick="openQuizItem(${i})"><div class="qn-icon">${qMode==='mcq'?'üîò':'‚úçÔ∏è'}</div><div class="qn-info"><div class="qn-title">${h(q.topic)}</div><div class="qn-sub"><span class="sbg ${sub.cls}" style="font-size:9px;">${sub.name}</span> ${q.data.questions?.length||0} Qs</div></div></div>`;
  }).join('');
}
function openQuizItem(i){activeQuiz=i;qIdx=0;qScore=0;renderQuizList();const qh=document.getElementById('qmHead');qh.style.display='flex';document.getElementById('qmTitle').textContent=quizPool[i]?.topic||'Quiz';document.getElementById('qmMeta').textContent=`${quizPool[i]?.data?.questions?.length||0} questions`;renderQuizQ();}
function resetQuiz(){if(activeQuiz!==null){qIdx=0;qScore=0;renderQuizQ();}}

function renderQuizQ(){
  const pool=quizPool[activeQuiz];if(!pool)return;
  const qs=pool.data.questions,body=document.getElementById('qmBody');
  if(qIdx>=qs.length){showQuizResults();return;}
  const cur=qs[qIdx],sub=SUBJS.find(s=>s.key===pool.subject)||{cls:'sg-gen',name:pool.subject};
  if(pool.type==='mcq'){
    body.innerHTML=`<div style="display:flex;gap:7px;margin-bottom:14px;flex-wrap:wrap;"><span class="sbg ${sub.cls}">${sub.name}</span><span class="tag tg-q">Bar MCQ</span></div>
      <div class="q-prog-track"><div class="q-prog-fill" style="width:${(qIdx/qs.length)*100}%"></div></div>
      <div class="q-prog-meta"><span>Q${qIdx+1} of ${qs.length}</span><span>Score: ${qScore}/${qIdx}</span></div>
      <div class="q-question">${h(cur.q)}</div>
      <div class="q-opts">${cur.options.map((o,i)=>`<div class="q-opt" id="qo${i}" onclick="pickMCQ(${i})">${h(o)}</div>`).join('')}</div>
      <div class="q-feedback" id="qfb"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:14px;"><button class="btn-gold" id="qnxt" style="display:none;" onclick="nextQ()">Next ‚Üí</button></div>`;
  }else{
    body.innerHTML=`<div style="display:flex;gap:7px;margin-bottom:14px;flex-wrap:wrap;"><span class="sbg ${sub.cls}">${sub.name}</span><span class="tag tg-e">Essay</span></div>
      <div class="q-prog-track"><div class="q-prog-fill" style="width:${(qIdx/qs.length)*100}%"></div></div>
      <div class="q-prog-meta"><span>Q${qIdx+1} of ${qs.length}</span><span>Write answer ‚Üí AI feedback</span></div>
      ${(cur.type==='situational'&&cur.context)?`<div class="essay-ctx"><span class="facts-label">Facts</span>${h(cur.context)}</div><span class="q-label">Question</span>`:cur.context?`<div class="essay-ctx">${h(cur.context)}</div>`:''}
      <div class="essay-prompt">${h(cur.prompt||cur.q||'')}</div>
      <textarea class="essay-box" id="essayBox" placeholder="Write your answer‚Ä¶"></textarea>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="btn-gold" id="essFB" onclick="submitEssay()">ü§ñ Get AI Feedback</button>
        <button class="btn-ghost" onclick="nextQ()">Skip ‚Üí</button>
      </div>
      <div class="ai-fb" id="aiFB"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:8px;"><button class="btn-gold" id="essNext" style="display:none;" onclick="nextQ()">Next ‚Üí</button></div>`;
  }
}
function pickMCQ(i){
  const pool=quizPool[activeQuiz],cur=pool.data.questions[qIdx];
  const ok=i===cur.answer;if(ok){qScore++;totalCorrect++;}totalQDone++;
  document.querySelectorAll('.q-opt').forEach((el,j)=>{if(j===cur.answer)el.classList.add('correct');else if(j===i)el.classList.add('wrong');});
  const fb=document.getElementById('qfb');fb.className='q-feedback show '+(ok?'ok':'no');
  fb.innerHTML=(ok?'‚úÖ <strong>Correct!</strong> ':'‚ùå <strong>Incorrect.</strong> ')+h(cur.explanation);
  document.getElementById('qnxt').style.display='block';updateDash();
}
// ALAC color thresholds per component
function alacScoreCls(score, key){
  if(key==='answer')      return score>=1.2?'hi':score>=0.7?'mid':'lo';
  if(key==='legalBasis')  return score>=2.0?'hi':score>=1.0?'mid':'lo';
  if(key==='application') return score>=2.8?'hi':score>=1.75?'mid':'lo';
  if(key==='conclusion')  return score>=1.2?'hi':score>=0.7?'mid':'lo';
  return score>=2?'hi':score>=1?'mid':'lo';
}
// Parse "ANSWER: ... LEGAL BASIS: ... APPLICATION: ... CONCLUSION: ..." into sections
function renderModelAnswer(text){
  if(!text) return '';
  const markers=['ANSWER','LEGAL BASIS','APPLICATION','CONCLUSION'];
  const hasAny=markers.some(m=>text.includes(m+':'));
  if(!hasAny) return `<span class="alac-model">${h(text)}</span>`;
  const positions=[];
  markers.forEach(m=>{const idx=text.indexOf(m+':');if(idx!==-1)positions.push({label:m,idx,end:idx+m.length+1});});
  positions.sort((a,b)=>a.idx-b.idx);
  const parts=positions.map((p,i)=>{
    const nextIdx=positions[i+1]?positions[i+1].idx:text.length;
    return {label:p.label,text:text.slice(p.end,nextIdx).trim()};
  });
  return parts.map(p=>`<div class="model-answer-section"><div class="ma-label">${h(p.label)}</div><div class="ma-text">${h(p.text)}</div></div>`).join('');
}
function renderAlacCard(ev){
  const gc=ev.grade==='Excellent'?'#14b4a0':ev.grade==='Good'?'#50d090':ev.grade==='Satisfactory'?'#c9a84c':ev.grade==='Needs Improvement'?'#e09050':'#e07080';
  const al=ev.alac||{};
  const rows=[
    ['A ‚Äî Answer',      'answer',      al.answer,      1.5],
    ['L ‚Äî Legal Basis', 'legalBasis',  al.legalBasis,  3.0],
    ['A ‚Äî Application', 'application', al.application, 4.0],
    ['C ‚Äî Conclusion',  'conclusion',  al.conclusion,  1.5],
  ];
  const tableRows=rows.map(([label,key,c,maxPts])=>c?`<tr>
    <td style="color:var(--white);font-weight:600;">${label}</td>
    <td><span class="alac-score ${alacScoreCls(c.score??0,key)}">${c.score!=null?c.score:'‚Äî'}</span></td>
    <td style="color:var(--muted);font-size:12px;white-space:nowrap;">/${maxPts}</td>
    <td style="color:rgba(248,246,241,.8);">${h(c.feedback||'')}</td>
  </tr>`:''
  ).join('');
  return `<div class="ai-fb-head">‚öñÔ∏è <span class="ai-fb-score">${h(ev.score||'?/10')}</span><span style="background:rgba(255,255,255,.08);border-radius:5px;padding:2px 7px;font-family:var(--fm);color:${gc};">${h(ev.grade||'')}</span></div>
  <div class="ai-fb-content">
    <table class="alac-table">
      <thead><tr><th>Component</th><th>Score</th><th>Max</th><th>Feedback</th></tr></thead>
      <tbody>${tableRows}<tr class="alac-total-row"><td style="color:${gc};">Total</td><td style="color:${gc};">${h(ev.score||'?/10')}</td><td style="color:var(--muted);font-size:12px;">/10</td><td style="color:rgba(248,246,241,.6);font-size:12px;">${h(ev.overallFeedback||'')}</td></tr></tbody>
    </table>
    ${ev.strengths?.length?`<p style="margin-top:10px;"><strong>‚úÖ Strengths:</strong></p><ul>${ev.strengths.map(s=>`<li>${h(s)}</li>`).join('')}</ul>`:''}
    ${ev.improvements?.length?`<p><strong>‚ö†Ô∏è Improve:</strong></p><ul>${ev.improvements.map(s=>`<li>${h(s)}</li>`).join('')}</ul>`:''}
    ${ev.keyMissed?.length?`<p><strong>üìö Missed:</strong></p><ul>${ev.keyMissed.map(s=>`<li>${h(s)}</li>`).join('')}</ul>`:''}
    <details style="margin-top:12px;"><summary style="cursor:pointer;color:var(--gold);font-weight:600;font-size:13px;">üìñ Model Answer (ALAC Format)</summary>
    <div style="margin-top:8px;padding:12px;background:rgba(255,255,255,.03);border-radius:9px;">${renderModelAnswer(ev.modelAnswer||'')}</div></details>
  </div>`;
}
async function submitEssay(){
  const ans=document.getElementById('essayBox')?.value.trim();if(!ans){document.getElementById('essayBox')?.focus();return;}
  const btn=document.getElementById('essFB');btn.disabled=true;btn.textContent='‚è≥ Evaluating‚Ä¶';
  const pool=quizPool[activeQuiz],cur=pool.data.questions[qIdx];
  const fb=document.getElementById('aiFB');fb.className='ai-fb show';
  fb.innerHTML=`<div class="ai-fb-head"><div class="spin" style="width:16px;height:16px;border-width:2px;"></div> Evaluating‚Ä¶</div>`;
  try{
    const r=await fetch('/api/evaluate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:cur.prompt||cur.q,answer:ans,modelAnswer:cur.modelAnswer,keyPoints:cur.keyPoints,subject:pool.subject})});
    const ev=await r.json();if(ev.error)throw new Error(ev.error);
    fb.innerHTML=renderAlacCard(ev);
    document.getElementById('essNext').style.display='block';totalQDone++;updateDash();
  }catch(err){fb.innerHTML=`<div class="ai-fb-head" style="color:#e07080;">‚ö†Ô∏è ${h(err.message)}</div>`;}
  btn.disabled=false;btn.textContent='ü§ñ Get AI Feedback';
}
function nextQ(){qIdx++;renderQuizQ();}
function showQuizResults(){
  const pct=qIdx>0?Math.round(qScore/qIdx*100):0;
  document.getElementById('qmBody').innerHTML=`<div class="quiz-results">
    <div style="font-size:48px;margin-bottom:12px;">${pct>=75?'‚öñÔ∏è':pct>=50?'üìñ':'üí™'}</div>
    <div style="font-family:var(--fd);font-size:26px;font-weight:700;color:var(--gold-l);margin-bottom:5px;">${pct>=75?'Excellent!':pct>=50?'Good Effort!':'Keep Reviewing!'}</div>
    <div class="qr-stats">
      <div class="qr-stat"><div class="n">${qScore}</div><div class="l">Correct</div></div>
      <div class="qr-stat"><div class="n">${qIdx-qScore}</div><div class="l">Wrong</div></div>
      <div class="qr-stat"><div class="n">${pct}%</div><div class="l">Score</div></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
      <button class="btn-gold" onclick="resetQuiz()">‚Ü∫ Retry</button>
      <button class="btn-ghost" onclick="nav('learn',document.getElementById('tab-learn'))">üìñ Learn</button>
      <button class="btn-mock" onclick="nav('mockbar',document.getElementById('tab-mockbar'))">‚è± Mock Bar</button>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateDash(){
  document.getElementById('st-score').textContent=totalQDone?Math.round(totalCorrect/totalQDone*100)+'%':'‚Äî';
  document.getElementById('h-done').textContent=totalQDone;
  document.getElementById('h-mock').textContent=mockSessions;
  updateKBIndicator();
  // Recent list
  if(VISITED.length){
    document.getElementById('recent-list').innerHTML=VISITED.slice(0,6).map(v=>{
      const sub=SUBJS.find(s=>s.key===v.subjKey)||{cls:'sg-gen',name:v.subjKey};
      return `<div class="r-item" onclick="nav('learn',document.getElementById('tab-learn'));clickTopic('${v.subjKey}','${h(v.topicName)}')">
        <div class="r-ic">üìñ</div>
        <div class="r-info"><div class="r-title">${h(v.topicName)}</div><div class="r-sub">${sub.name}</div></div>
        <span class="sbg ${sub.cls}">${sub.name}</span><span class="tag tg-l">Lesson</span>
      </div>`;
    }).join('');
  }
  renderSubjectTracker();
}
function renderSubjectTracker(){
  const cachedBySubj={};
  Object.entries(CACHE).forEach(([k,v])=>cachedBySubj[k]=Object.keys(v).length);
  document.getElementById('sub-tracker').innerHTML=SUBJS.map((s,i)=>{
    const total=(KB.syllabusTopics||[]).find(st=>st.key===s.key)?.topics?.length||0;
    const cached=cachedBySubj[s.key]||0;
    const pct=total?Math.round(cached/total*100):0;
    return `<div class="sub-row"><div class="sub-num">${i+1}</div>
      <div style="flex:1;"><div style="font-size:12px;font-weight:600;margin-bottom:1px;">${s.name}</div><div style="font-size:10px;color:var(--muted);">${cached}/${total} topics ready</div></div>
      <div><div class="bar-track"><div class="bar-fill ${s.f}" style="width:${pct}%"></div></div><div style="font-size:10px;color:var(--muted);font-family:var(--fm);">${pct}%</div></div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOCK BAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleMockSubj(el){
  if(el.dataset.key==='all'){document.querySelectorAll('.mc-subj-tag').forEach(t=>t.classList.remove('on'));el.classList.add('on');return;}
  document.querySelector('.mc-subj-tag[data-key="all"]').classList.remove('on');
  el.classList.toggle('on');
  if(!document.querySelector('.mc-subj-tag.on'))document.querySelector('.mc-subj-tag[data-key="all"]').classList.add('on');
}

async function startMockBar(){
  const count=parseInt(document.getElementById('mc-qcount').value,10);
  const timeMin=parseInt(document.getElementById('mc-time').value,10);
  const allOn=document.querySelector('.mc-subj-tag[data-key="all"]').classList.contains('on');
  const subjects=allOn?['all']:Array.from(document.querySelectorAll('.mc-subj-tag.on')).map(t=>t.dataset.key);
  console.log('Starting mock bar with count:',count,'subjects:',subjects);
  mockSubjectsUsed=subjects; mockSessionDate=new Date(); mockScores=[];
  const btn=document.getElementById('startMockBtn');
  btn.disabled=true;btn.textContent='‚è≥ Building question set‚Ä¶';
  document.getElementById('mockStartError').style.display='none';
  try{
    const r=await fetch('/api/mockbar/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({subjects,count})});
    const data=await r.json();if(data.error)throw new Error(data.error);
    console.log('Questions received:',data.questions?.length,'requested:',count);
    mockQs=data.questions;mockIdx=0;mockAnswers=Array(mockQs.length).fill('');
    document.getElementById('mockConfig').style.display='none';
    document.getElementById('mockResults').style.display='none';
    document.getElementById('mockSession').classList.add('on');
    document.getElementById('ms-of').textContent=`of ${mockQs.length}`;
    document.getElementById('qMarkers').innerHTML=mockQs.map((_,i)=>`<div class="q-marker" id="qm${i}" onclick="jumpMock(${i})">${i+1}</div>`).join('');
    if(timeMin>0){mockLeft=timeMin*60;document.getElementById('ms-timer').style.display='flex';runTimer();}
    else document.getElementById('ms-timer').style.display='none';
    renderMockQ();
    mockSessions++;updateDash();
  }catch(err){
    const errEl=document.getElementById('mockStartError');
    errEl.textContent='‚ö†Ô∏è '+err.message;errEl.style.display='block';
  }
  btn.disabled=false;btn.textContent='‚è± Begin Mock Bar';
}

function runTimer(){
  if(mockTimer)clearInterval(mockTimer);
  mockTimer=setInterval(()=>{
    mockLeft--;
    const m=Math.floor(mockLeft/60),s=mockLeft%60;
    document.getElementById('timer-val').textContent=`${m}:${s.toString().padStart(2,'0')}`;
    document.getElementById('ms-timer').classList.toggle('warn',mockLeft<=300);
    if(mockLeft<=0){clearInterval(mockTimer);endMockSession();}
  },1000);
}

function renderMockQ(){
  const q=mockQs[mockIdx];if(!q)return;
  document.getElementById('ms-qnum').textContent=`Question ${mockIdx+1}`;
  document.getElementById('ms-prog').style.width=`${((mockIdx+1)/mockQs.length)*100}%`;
  const sub=SUBJS.find(s=>s.key===q.subject)||{name:q.subject,cls:'sg-gen'};
  document.getElementById('ms-src').innerHTML=q.isReal
    ?`<span class="ms-source">üìú ${h(q.source||'')} ${h(q.year||'')}</span>`
    :q.source==='Pre-generated'
      ?`<span class="ms-source">üìö Pre-generated</span>`
      :`<span class="ms-source">ü§ñ AI Generated</span>`;
  document.querySelectorAll('.q-marker').forEach((m,i)=>{
    m.className='q-marker'+(mockAnswers[i]?.trim()?' done':'')+(i===mockIdx?' current':'');
  });
  const qText = q.prompt || q.q || '';
  const isSituational = (q.type === 'situational') && q.context;
  document.getElementById('mockQArea').innerHTML=`
    <div style="display:flex;gap:7px;margin-bottom:14px;flex-wrap:wrap;"><span class="sbg ${sub.cls}">${h(sub.name)}</span><span class="tag tg-e">Bar Essay</span></div>
    ${isSituational?`<div class="essay-ctx"><span class="facts-label">Facts</span>${h(q.context)}</div><span class="q-label">Question</span>`:''}
    ${!isSituational&&q.context?`<div class="essay-ctx">${h(q.context)}</div>`:''}
    <div class="essay-prompt">${h(qText)}</div>
    <div style="font-size:11px;color:var(--muted);margin:8px 0 10px;">Write a complete bar exam answer. Navigate freely between questions before submitting.</div>
    <textarea class="essay-box" id="mockBox" style="min-height:220px;" placeholder="Write your answer‚Ä¶" oninput="saveMock()">${h(mockAnswers[mockIdx]||'')}</textarea>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;">
      <button class="btn-ghost" onclick="moveMock(-1)" ${mockIdx===0?'disabled':''}>‚Üê Prev</button>
      <span style="font-size:12px;color:var(--muted);font-family:var(--fm);">${mockAnswers.filter(a=>a?.trim()).length}/${mockQs.length} answered</span>
      ${mockIdx<mockQs.length-1?`<button class="btn-gold" onclick="moveMock(1)">Next ‚Üí</button>`:`<button class="btn-mock" onclick="endMockSession()">Submit All &amp; Score</button>`}
    </div>`;
}
function saveMock(){mockAnswers[mockIdx]=document.getElementById('mockBox')?.value||'';}
function moveMock(d){saveMock();mockIdx=Math.max(0,Math.min(mockQs.length-1,mockIdx+d));renderMockQ();}
function jumpMock(i){saveMock();mockIdx=i;renderMockQ();}

async function endMockSession(){
  saveMock();if(mockTimer)clearInterval(mockTimer);
  document.getElementById('mockSession').classList.remove('on');
  const answered=mockAnswers.filter(a=>a?.trim()).length;
  const res=document.getElementById('mockResults');
  res.style.display='block';
  res.innerHTML=`<div class="mock-results"><div style="font-size:40px;margin-bottom:10px;">‚è≥</div><div style="font-family:var(--fd);font-size:22px;color:var(--gold-l);">Scoring ${answered} answers‚Ä¶</div><div style="font-size:13px;color:var(--muted);">AI is evaluating each answer. This may take a moment.</div></div>`;

  const scores=[];
  for(let i=0;i<mockQs.length;i++){
    const q=mockQs[i],ans=mockAnswers[i]||'';
    if(!ans.trim()){scores.push({score:'0/10',numericScore:0,grade:'Not Answered',overallFeedback:'No answer provided.',keyMissed:[]});continue;}
    try{
      const r=await fetch('/api/evaluate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:q.prompt||q.q,answer:ans,modelAnswer:q.modelAnswer,keyPoints:q.keyPoints,subject:q.subject})});
      scores.push(await r.json());
    }catch(e){scores.push({score:'?/10',numericScore:0,grade:'Error',overallFeedback:e.message,keyMissed:[]});}
  }

  mockScores=scores;
  const total=scores.reduce((a,s)=>a+(s.numericScore||0),0);
  const avg=scores.length?Math.round(total/scores.length*10)/10:0;
  const pct=Math.round(avg/10*100);
  totalQDone+=answered;totalCorrect+=Math.round(pct/100*answered);updateDash();

  // Pre-fill email modal subject
  const emailSubj=`BarBuddy Mock Bar Results ‚Äî ${new Date().toLocaleDateString('en-PH')} ‚Äî ${avg}/10`;
  document.getElementById('email-subject').value=emailSubj;

  res.innerHTML=`<div class="mock-results">
    <div style="font-size:32px;margin-bottom:8px;">üèõ</div>
    <div style="font-family:var(--fd);font-size:20px;font-weight:700;color:#ff8c42;margin-bottom:4px;">Mock Bar Results</div>
    <div class="mr-grade">${avg}/10</div>
    <div style="font-size:16px;font-weight:700;color:${pct>=75?'#14b4a0':pct>=55?'var(--gold)':'#e07080'};margin-bottom:18px;">${pct}% ‚Äî ${pct>=75?'‚úÖ Passing Level':'‚ùå Needs Improvement'}</div>
    <div class="mr-stats">
      <div class="mr-stat"><div class="n">${answered}</div><div class="l">Answered</div></div>
      <div class="mr-stat"><div class="n">${mockQs.length-answered}</div><div class="l">Skipped</div></div>
      <div class="mr-stat"><div class="n">${avg}/10</div><div class="l">Avg Score</div></div>
      <div class="mr-stat"><div class="n">${pct}%</div><div class="l">Overall</div></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-bottom:22px;flex-wrap:wrap;">
      <button class="btn-mock" onclick="document.getElementById('mockConfig').style.display='block';res.style.display='none';">‚è± New Session</button>
      <button class="btn-ghost" onclick="nav('learn',document.getElementById('tab-learn'))">üìñ Back to Learn</button>
      <button class="btn-ghost" onclick="printMockResults()">üñ®Ô∏è Print</button>
      <button class="btn-ghost" onclick="openModal('emailOverlay')">üìß Email</button>
    </div>
    <h3 style="font-family:var(--fd);font-size:20px;font-weight:700;color:var(--gold-l);margin-bottom:14px;text-align:left;">üìã Question Review</h3>
    ${mockQs.map((q,i)=>{
      const s=scores[i],sub=SUBJS.find(x=>x.key===q.subject)||{name:q.subject,cls:'sg-gen'},ns=s.numericScore||0;
      const qText=q.prompt||q.q||'';
      const isSit=(q.type==='situational')&&q.context;
      return `<div class="q-review-item">
        <div style="font-size:11px;color:#a08060;margin-bottom:5px;display:flex;align-items:center;gap:8px;">
          Q${i+1} ¬∑ <span class="sbg ${sub.cls}">${sub.name}</span>
          ${q.isReal?'<span style="font-size:9px;">üìú Past Bar</span>':q.source==='Pre-generated'?'<span style="font-size:9px;color:var(--teal);">üìö Pre-gen</span>':'<span style="font-size:9px;">ü§ñ AI</span>'}
        </div>
        ${isSit?`<div class="essay-ctx" style="margin-bottom:8px;"><span class="facts-label">Facts</span>${h(q.context)}</div><span class="q-label">Question</span>`:''}
        <div style="font-size:13px;color:rgba(248,246,241,.85);margin-bottom:8px;line-height:1.6;">${h(qText)}</div>
        ${s.grade==='Not Answered'?`<span class="q-score-badge qsb-low">Not Answered</span>`:`
        <div class="ai-fb show" style="margin-top:8px;">${renderAlacCard(s)}</div>`}
        <details style="margin-top:8px;"><summary style="cursor:pointer;color:var(--muted);font-size:12px;font-weight:600;">Your answer</summary>
          <div style="margin-top:6px;padding:10px;background:rgba(255,255,255,.03);border-radius:8px;font-size:12px;line-height:1.7;color:rgba(248,246,241,.8);">${h(mockAnswers[i]||'(no answer)')}</div>
        </details>
      </div>`;
    }).join('')}
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MANUAL QUESTION UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleManualContext(){
  const isSit=document.querySelector('input[name="mn-type"]:checked')?.value==='situational';
  document.getElementById('mn-context-wrap').style.display=isSit?'block':'none';
}
function updateManualPreview(){
  const el=document.getElementById('mn-preview');
  if(!manualBatch.length){el.innerHTML='';return;}
  el.innerHTML=manualBatch.map((q,i)=>`
    <div class="mn-prev-item">
      <span style="font-weight:700;color:var(--gold);font-family:var(--fm);flex-shrink:0;">Q${i+1}</span>
      <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${h(q.q.slice(0,80))}${q.q.length>80?'‚Ä¶':''}</span>
      <button class="mn-rm" onclick="removeManualQ(${i})">‚úï</button>
    </div>`).join('');
}
function removeManualQ(i){
  manualBatch.splice(i,1);
  updateManualPreview();
}
function addManualQ(){
  const qText=document.getElementById('mn-q').value.trim();
  if(!qText){document.getElementById('mn-q').focus();document.getElementById('mn-status').innerHTML='<div style="color:#e07080;font-size:12px;padding:4px 0;">‚ö†Ô∏è Enter the question text first.</div>';return;}
  const type=document.querySelector('input[name="mn-type"]:checked')?.value||'situational';
  const context=type==='situational'?document.getElementById('mn-context').value.trim():'';
  const rawPoints=document.getElementById('mn-points').value.trim();
  const keyPoints=rawPoints?rawPoints.split('\n').map(l=>l.trim()).filter(Boolean):[];
  manualBatch.push({
    q:qText,
    context,
    modelAnswer:document.getElementById('mn-answer').value.trim(),
    keyPoints,
    type,
  });
  // Auto-increment number, clear question-specific fields
  manualQNum++;
  document.getElementById('mn-num').value=manualQNum;
  document.getElementById('mn-q').value='';
  document.getElementById('mn-context').value='';
  document.getElementById('mn-answer').value='';
  document.getElementById('mn-points').value='';
  document.getElementById('mn-status').innerHTML='';
  updateManualPreview();
}
async function saveManualBatch(){
  if(!manualBatch.length){document.getElementById('mn-status').innerHTML='<div style="color:#e07080;font-size:12px;padding:4px 0;">‚ö†Ô∏è Add at least one question first.</div>';return;}
  const name=document.getElementById('mn-name').value.trim();
  if(!name){document.getElementById('mn-name').focus();document.getElementById('mn-status').innerHTML='<div style="color:#e07080;font-size:12px;padding:4px 0;">‚ö†Ô∏è Enter a batch name.</div>';return;}
  const subject=document.getElementById('mn-subject').value;
  const year=document.getElementById('mn-year').value.trim();
  const sta=document.getElementById('mn-status');
  sta.innerHTML='<div style="color:var(--gold-l);font-size:12px;padding:4px 0;">‚è≥ Saving‚Ä¶</div>';
  try{
    const r=await fetch('/api/admin/pastbar/manual',{method:'POST',headers:{'Content-Type':'application/json','x-admin-key':adminKey},body:JSON.stringify({name,subject,year,questions:manualBatch})});
    const d=await r.json();
    if(d.error)throw new Error(d.error);
    sta.innerHTML=`<div style="color:var(--teal);font-size:12px;padding:4px 0;">‚úÖ Saved ${d.questionsAdded} question${d.questionsAdded===1?'':'s'} to Knowledge Base.</div>`;
    manualBatch=[];manualQNum=1;
    document.getElementById('mn-num').value=1;
    document.getElementById('mn-name').value='';
    updateManualPreview();
    await loadKB();refreshAdminKB();renderPastBarList();
  }catch(e){sta.innerHTML=`<div style="color:#e07080;font-size:12px;padding:4px 0;">‚ö†Ô∏è ${h(e.message)}</div>`;}
}

function renderPastBarList(){
  const el=document.getElementById('pb-list');if(!el)return;
  if(!KB.pastBar?.length){el.innerHTML=`<div style="font-size:13px;color:var(--muted);text-align:center;padding:12px 0;">No past bar materials uploaded yet.</div>`;return;}
  el.innerHTML=KB.pastBar.map(pb=>{const sub=SUBJS.find(s=>s.key===pb.subject)||{cls:'sg-gen',name:pb.subject};
    return `<div class="r-item" style="cursor:default;"><div class="r-ic">üìú</div><div class="r-info"><div class="r-title">${h(pb.name)}</div><div class="r-sub">${pb.year} ¬∑ ${pb.qCount} questions extracted</div></div><span class="sbg ${sub.cls}">${sub.name}</span></div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRINT / EMAIL RESULTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildResultsHtml(){
  const e=s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
  const dateStr=mockSessionDate?mockSessionDate.toLocaleString('en-PH'):new Date().toLocaleString('en-PH');
  const subjStr=(!mockSubjectsUsed.length||mockSubjectsUsed.includes('all'))?'All Subjects':mockSubjectsUsed.map(s=>SUBJS.find(x=>x.key===s)?.name||s).join(', ');
  const answered=mockAnswers.filter(a=>a?.trim()).length;
  const totalSc=mockScores.reduce((a,s)=>a+(s.numericScore||0),0);
  const avg=mockScores.length?Math.round(totalSc/mockScores.length*10)/10:0;
  const pct=Math.round(avg/10*100);
  const passColor=pct>=75?'#1a7a5e':pct>=55?'#8b6914':'#b32d2d';

  const alacTr=(label,c,max)=>c?`<tr><td style="padding:6px 8px;border:1px solid #d0b870;font-weight:600;">${label}</td><td style="padding:6px 8px;border:1px solid #d0b870;text-align:center;font-weight:bold;">${c.score!=null?c.score+'/'+max:'‚Äî'}</td><td style="padding:6px 8px;border:1px solid #d0b870;">${e(c.feedback||'')}</td></tr>`:'';

  const qHtml=mockQs.map((q,i)=>{
    const s=mockScores[i]||{};
    const sub=SUBJS.find(x=>x.key===q.subject)||{name:q.subject||'Unknown'};
    const qText=q.prompt||q.q||'';
    const ans=mockAnswers[i]||'';
    const al=s.alac||{};
    const isSit=(q.type==='situational')&&q.context;
    const pageBreak=i<mockQs.length-1?'page-break-after:always;':'';
    return `<div style="padding:22px 0;${pageBreak}${i>0?'border-top:1px solid #e0d0a0;':''}">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
        <span style="font-size:17px;font-weight:bold;color:#7a6128;">Q${i+1}</span>
        <span style="background:#eee;border-radius:4px;padding:2px 8px;font-size:12px;color:#333;">${e(sub.name)}</span>
        <span style="color:#666;font-size:12px;">${q.isReal?'üìú Past Bar '+(q.year||''):q.source==='Pre-generated'?'üìö Pre-generated':'ü§ñ AI Generated'}</span>
      </div>
      ${isSit?`<div style="background:#f0f4ff;border-left:3px solid #3a5abf;padding:10px 14px;margin-bottom:12px;border-radius:4px;"><div style="font-size:10px;font-weight:bold;text-transform:uppercase;letter-spacing:.08em;color:#3a5abf;margin-bottom:5px;">FACTS</div><div style="font-size:13px;line-height:1.7;">${e(q.context)}</div></div>`:''}
      <div style="font-size:14px;font-weight:bold;line-height:1.7;margin-bottom:14px;">${e(qText)}</div>
      ${ans.trim()?`
      <div style="font-size:10px;font-weight:bold;text-transform:uppercase;letter-spacing:.08em;color:#7a6128;margin:12px 0 5px;">ALAC SCORECARD</div>
      <table style="width:100%;border-collapse:collapse;font-size:12px;margin-bottom:12px;">
        <tr style="background:#f5efe0;"><th style="text-align:left;padding:6px 8px;border:1px solid #d0b870;font-size:11px;">Component</th><th style="padding:6px 8px;border:1px solid #d0b870;font-size:11px;">Score</th><th style="text-align:left;padding:6px 8px;border:1px solid #d0b870;font-size:11px;">Feedback</th></tr>
        ${alacTr('A ‚Äî Answer',al.answer,1.5)}
        ${alacTr('L ‚Äî Legal Basis',al.legalBasis,3.0)}
        ${alacTr('A ‚Äî Application',al.application,4.0)}
        ${alacTr('C ‚Äî Conclusion',al.conclusion,1.5)}
        <tr style="background:#faf5e0;"><td colspan="2" style="padding:7px 8px;border:1px solid #d0b870;font-weight:bold;">TOTAL: ${e(s.score||'?/10')} ‚Äî ${e(s.grade||'')}</td><td style="padding:7px 8px;border:1px solid #d0b870;font-size:12px;">${e(s.overallFeedback||'')}</td></tr>
      </table>
      ${s.keyMissed?.length?`<div style="font-size:10px;font-weight:bold;text-transform:uppercase;letter-spacing:.08em;color:#7a6128;margin:12px 0 5px;">KEY POINTS MISSED</div><ul style="margin:4px 0 12px 20px;font-size:13px;">${s.keyMissed.map(k=>`<li>${e(k)}</li>`).join('')}</ul>`:''}
      <div style="font-size:10px;font-weight:bold;text-transform:uppercase;letter-spacing:.08em;color:#7a6128;margin:12px 0 5px;">STUDENT ANSWER</div>
      <div style="background:#f9f9f9;border:1px solid #ddd;border-radius:4px;padding:10px 14px;font-size:13px;line-height:1.7;margin-bottom:10px;">${e(ans)}</div>
      <div style="font-size:10px;font-weight:bold;text-transform:uppercase;letter-spacing:.08em;color:#7a6128;margin:12px 0 5px;">MODEL ANSWER</div>
      <div style="background:#f0f8f0;border:1px solid #b0d8b0;border-radius:4px;padding:10px 14px;font-size:13px;line-height:1.7;">${e(s.modelAnswer||'‚Äî')}</div>
      `:'<div style="color:#999;font-style:italic;font-size:13px;margin:8px 0;">‚Äî Not Answered ‚Äî</div>'}
    </div>`;
  }).join('');

  return `<div style="font-family:Georgia,serif;color:#111;max-width:800px;margin:0 auto;padding:20px;">
    <h1 style="font-size:22px;color:#7a6128;border-bottom:2px solid #7a6128;padding-bottom:8px;margin-bottom:8px;">BarBuddy ‚Äî Mock Bar Examination Results</h1>
    <div style="font-size:13px;color:#333;margin-bottom:14px;line-height:2;">
      <div><strong>Date:</strong> ${e(dateStr)}</div>
      <div><strong>Subject:</strong> ${e(subjStr)}</div>
      <div><strong>Questions:</strong> ${answered} answered / ${mockQs.length} total</div>
    </div>
    <div style="font-size:20px;font-weight:bold;color:${passColor};margin:10px 0 20px;">Overall Score: ${avg}/10 ‚Äî ${pct>=75?'‚úÖ PASSING LEVEL':'‚ùå NEEDS IMPROVEMENT'}</div>
    ${qHtml}
    <div style="margin-top:30px;padding-top:12px;border-top:1px solid #ccc;font-size:11px;color:#666;text-align:center;">Generated by BarBuddy ‚Äî Philippine Bar Exam Companion</div>
  </div>`;
}

function printMockResults(){
  if(!mockQs.length)return;
  const body=buildResultsHtml();
  const w=window.open('','_blank');
  if(!w){alert('Pop-up blocked. Please allow pop-ups to print results.');return;}
  w.document.write(`<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>BarBuddy Results</title><style>@media print{@page{margin:1.5cm;}}</style></head><body>${body}</body></html>`);
  w.document.close();w.focus();
  setTimeout(()=>w.print(),600);
}

async function sendEmailResults(){
  const to=document.getElementById('email-to').value.trim();
  const subject=document.getElementById('email-subject').value.trim();
  const sta=document.getElementById('email-status');
  const btn=document.getElementById('emailSendBtn');
  if(!to){sta.style.display='block';sta.style.background='rgba(155,35,53,.15)';sta.style.color='#e07080';sta.textContent='‚ö†Ô∏è Enter an email address.';return;}
  btn.disabled=true;btn.textContent='‚è≥ Sending‚Ä¶';
  sta.style.display='block';sta.style.background='rgba(201,168,76,.1)';sta.style.color='var(--gold-l)';sta.textContent='Sending‚Ä¶';
  try{
    const r=await fetch('/api/email-results',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to,subject,htmlBody:buildResultsHtml()})});
    const d=await r.json();
    if(d.error){
      sta.style.background='rgba(155,35,53,.15)';sta.style.color='#e07080';
      sta.innerHTML=`‚ö†Ô∏è ${h(d.error)}${d.error.includes('not configured')?'<br><small style="display:block;margin-top:5px;opacity:.8;">Go to Railway ‚Üí Variables ‚Üí add EMAIL_USER and EMAIL_PASS (Gmail app password).</small>':''}`;
    }else{
      sta.style.background='rgba(20,180,160,.1)';sta.style.color='var(--teal)';
      sta.textContent=`‚úÖ Results sent to ${to}`;
    }
  }catch(err){sta.style.background='rgba(155,35,53,.15)';sta.style.color='#e07080';sta.textContent='‚ö†Ô∏è '+err.message;}
  btn.disabled=false;btn.textContent='üìß Send Results';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function unlockAdmin(){
  adminKey=document.getElementById('adminKeyInput').value.trim();
  if(!adminKey)return;
  document.getElementById('adminStatus').textContent='Checking‚Ä¶';
  try{
    await fetch('/api/kb');
    document.getElementById('adminLocked').style.display='none';
    document.getElementById('adminUnlocked').style.display='block';
    document.getElementById('adminStatus').textContent='‚úì Unlocked';
    refreshAdminKB();updateSyllabusStatus();
    // Show gen panel if running
    if(KB.genState?.running) document.getElementById('adminGenPanel').style.display='block';
    else if(KB.genState?.finishedAt) document.getElementById('adminGenDone').style.display='block';
  }catch(e){document.getElementById('adminStatus').textContent='Error: '+e.message;}
}

async function readFile(input,targetId){
  const f=input.files[0];if(!f)return;
  const ext=f.name.split('.').pop().toLowerCase();
  if(ext==='pdf'||ext==='doc'||ext==='docx'){
    const fd=new FormData();fd.append('file',f);
    const statusId=targetId.replace('-content','-status');
    const sta=document.getElementById(statusId);
    if(sta)sta.innerHTML=`<div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--gold-l);padding:8px;"><div class="spin" style="width:14px;height:14px;border-width:2px;"></div>Extracting text from ${ext.toUpperCase()}‚Ä¶</div>`;
    try{
      const r=await fetch('/api/admin/parse-file',{method:'POST',headers:{'x-admin-key':adminKey},body:fd});
      const d=await r.json();
      if(d.error)throw new Error(d.error);
      document.getElementById(targetId).value=d.text;
      if(sta)sta.innerHTML=`<div style="color:var(--teal);font-size:12px;padding:4px 8px;">‚úì Extracted ${d.text.length.toLocaleString()} characters from ${h(f.name)}</div>`;
    }catch(e){
      if(sta)sta.innerHTML=`<div style="color:#e07080;font-size:13px;padding:8px;">‚ö†Ô∏è ${h(e.message)}</div>`;
    }
  }else{
    const r=new FileReader();r.onload=e=>document.getElementById(targetId).value=e.target.result;r.readAsText(f);
  }
}
function updateSyllabusStatus(){
  const el=document.getElementById('syllabusStatus');if(!el)return;
  if(KB.hasSyllabus){
    const n=KB.syllabusTopics?.reduce((a,s)=>a+(s.topics?.length||0),0)||0;
    el.innerHTML=`<span style="color:var(--teal);">‚úì ${h(KB.syllabusName||'Syllabus')} ¬∑ ${KB.syllabusTopics?.length||0} subjects ¬∑ ${n} topics</span>`;
  } else el.textContent='No syllabus uploaded yet.';
}

async function adminPost(url,body,status){
  const sta=document.getElementById(status);
  sta.innerHTML=`<div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--gold-l);padding:10px;"><div class="spin" style="width:16px;height:16px;border-width:2px;"></div>Processing‚Ä¶</div>`;
  const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','x-admin-key':adminKey},body:JSON.stringify(body)});
  return r.json();
}

async function uploadSyllabus(){
  const name=document.getElementById('syl-name').value.trim();
  const content=document.getElementById('syl-content').value.trim();
  if(!content){alert('Paste or upload syllabus content.');return;}
  try{
    const r=await adminPost('/api/admin/syllabus',{name,content},'syl-status');
    if(r.error)throw new Error(r.error);
    document.getElementById('syl-status').innerHTML=`<div style="color:var(--teal);font-size:13px;padding:8px;">‚úÖ Saved! ${r.subjects} subjects, ${r.totalTopics} topics. Pre-generating content now‚Ä¶</div>`;
    document.getElementById('adminGenPanel').style.display='block';
    document.getElementById('adminGenDone').style.display='none';
    await loadKB();updateSyllabusStatus();renderSyllabusTree();
  }catch(e){document.getElementById('syl-status').innerHTML=`<div style="color:#e07080;font-size:13px;padding:8px;">‚ö†Ô∏è ${h(e.message)}</div>`;}
}
async function uploadReference(){
  const name=document.getElementById('ref-name').value.trim(),content=document.getElementById('ref-content').value.trim();
  const subject=document.getElementById('ref-subject').value,type=document.getElementById('ref-type').value;
  if(!name||!content){alert('Enter name and content.');return;}
  const sta=document.getElementById('ref-status');
  const spin=`<div class="spin" style="width:14px;height:14px;border-width:2px;flex-shrink:0;"></div>`;
  try{
    const r=await adminPost('/api/admin/reference',{name,subject,type,content},'ref-status');
    if(r.error)throw new Error(r.error);
    document.getElementById('ref-name').value='';document.getElementById('ref-content').value='';
    await loadKB();refreshAdminKB();
    sta.innerHTML=`<div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--gold-l);padding:10px;">${spin}‚è≥ Saved "${h(r.name)}" ‚Äî summarising in background‚Ä¶</div>`;
    pollJob(r.jobId,sta,(err)=>{
      if(err){
        sta.innerHTML=`<div style="color:#ff8c42;font-size:13px;padding:8px;">‚ö†Ô∏è Saved "${h(r.name)}" but summarisation failed: ${h(err)}</div>`;
      }else{
        sta.innerHTML=`<div style="color:var(--teal);font-size:13px;padding:8px;">‚úÖ "${h(r.name)}" saved and summarised. Re-generating ${h(subject)} content‚Ä¶</div>`;
      }
    });
  }catch(e){sta.innerHTML=`<div style="color:#e07080;font-size:13px;padding:8px;">‚ö†Ô∏è ${h(e.message)}</div>`;}
}
async function uploadPastBar(){
  const name=document.getElementById('pb-name').value.trim();
  const content=document.getElementById('pb-content').value.trim();
  const subject=document.getElementById('pb-subject').value;
  const year=document.getElementById('pb-year').value.trim();
  const sta=document.getElementById('pb-status');
  if(!name||!content){
    sta.innerHTML=`<div style="color:#e07080;font-size:13px;padding:8px;">‚ö†Ô∏è Enter a name and paste or upload content first.</div>`;
    return;
  }
  const spin=`<div class="spin" style="width:14px;height:14px;border-width:2px;flex-shrink:0;"></div>`;
  sta.innerHTML=`<div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--gold-l);padding:10px;">${spin}Saving‚Ä¶</div>`;
  try{
    const r=await fetch('/api/admin/pastbar',{method:'POST',headers:{'Content-Type':'application/json','x-admin-key':adminKey},body:JSON.stringify({name,content,subject,year})});
    const d=await r.json();
    if(d.error)throw new Error(d.error);
    document.getElementById('pb-name').value='';
    document.getElementById('pb-content').value='';
    await loadKB();refreshAdminKB();renderPastBarList();
    sta.innerHTML=`<div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--gold-l);padding:10px;">${spin}‚è≥ Saved "${h(d.name)}" ‚Äî extracting questions‚Ä¶</div>`;
    pollJob(d.jobId,sta,(err,result)=>{
      if(err){
        sta.innerHTML=`<div style="color:#ff8c42;font-size:13px;padding:8px;">‚ö†Ô∏è Saved "${h(d.name)}" but extraction failed: ${h(err)}</div>`;
      }else if(!result?.questionsExtracted){
        sta.innerHTML=`<div style="color:#ff8c42;font-size:13px;padding:8px;">‚ö†Ô∏è Saved "${h(d.name)}" but 0 questions were extracted. Try pasting as plain text.</div>`;
      }else{
        sta.innerHTML=`<div style="color:var(--teal);font-size:13px;padding:8px;">‚úÖ "${h(d.name)}" ‚Äî ${result.questionsExtracted} questions extracted.</div>`;
      }
      loadKB();refreshAdminKB();renderPastBarList();
    });
  }catch(e){sta.innerHTML=`<div style="color:#e07080;font-size:13px;padding:8px;">‚ö†Ô∏è ${h(e.message)}</div>`;}
}
// Generic job poller ‚Äî polls /api/job/:jobId every 8s
// onDone(errorMsg|null, result|null)
function pollJob(jobId,sta,onDone){
  const spin=`<div class="spin" style="width:14px;height:14px;border-width:2px;flex-shrink:0;"></div>`;
  let attempts=0;
  const iv=setInterval(async()=>{
    attempts++;
    try{
      const r=await fetch(`/api/job/${jobId}`,{headers:{'x-admin-key':adminKey}});
      const d=await r.json();
      if(d.status==='done'){
        clearInterval(iv);onDone(null,d.result);
      }else if(d.status==='failed'){
        clearInterval(iv);onDone(d.error,null);
      }else if(attempts>=38){ // ~5 min max
        clearInterval(iv);
        sta.innerHTML=`<div style="color:var(--muted);font-size:13px;padding:8px;">‚è≥ Still processing on server. Check back later.</div>`;
      }else{
        const elapsed=attempts*8;
        sta.innerHTML=`<div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--gold-l);padding:10px;">${spin}Processing‚Ä¶ (${elapsed<60?elapsed+'s':Math.floor(elapsed/60)+'m '+elapsed%60+'s'} elapsed)</div>`;
      }
    }catch(e){if(attempts>=38)clearInterval(iv);}
  },8000);
}
async function refreshAdminKB(){
  loadStorageInfo();
  const el=document.getElementById('adminKbList');if(!el)return;
  const items=[
    ...(KB.hasSyllabus?[{name:KB.syllabusName||'Syllabus',subject:'all',type:'syllabus',id:'_syl'}]:[]),
    ...(KB.references||[]).map(r=>({...r,_cat:'ref'})),
    ...(KB.pastBar||[]).map(p=>({...p,_cat:'pb'})),
  ];
  if(!items.length){el.innerHTML=`<div style="font-size:12px;color:var(--muted);">Knowledge base is empty.</div>`;return;}
  el.innerHTML=items.map(i=>`<div class="kb-list-item">
    <div style="font-size:15px;">${i.type==='syllabus'?'üìã':i._cat==='pb'||i.qCount!==undefined?'üìú':'üìÇ'}</div>
    <div style="flex:1;min-width:0;"><div class="kl-name">${h(i.name)}</div><div class="kl-sub">${i.subject||''} ${i.year?'¬∑ '+i.year:''} ${i.qCount!==undefined?'¬∑ '+i.qCount+' Qs':i.type?'¬∑ '+i.type:''}</div></div>
    ${i.id!=='_syl'?`<button class="kl-del" onclick="deleteItem('${i.id}',this)">‚úï</button>`:`<button class="kl-del" onclick="deleteSyllabus(this)">‚úï</button>`}
  </div>`).join('');
}
async function loadStorageInfo(){
  const el=document.getElementById('storageIndicator');if(!el)return;
  try{
    const r=await fetch('/api/storage-info',{headers:{'x-admin-key':adminKey}});
    if(!r.ok){el.innerHTML='<span style="color:var(--muted);">Storage info unavailable.</span>';return;}
    const d=await r.json();
    const kb=d.files['kb.json'],ct=d.files['content.json'];
    const fmt=b=>b>=1024*1024?(b/1024/1024).toFixed(1)+'MB':b>=1024?(b/1024).toFixed(1)+'KB':b+'B';
    const persistColor=d.persistent?'#14b4a0':'#e09050';
    const persistLabel=d.persistent?'‚úÖ Persistent (Railway Volume)':'‚ö†Ô∏è Ephemeral ‚Äî data lost on redeploy';
    el.innerHTML=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
      <span style="color:${persistColor};font-weight:600;">${persistLabel}</span>
    </div>
    <div style="color:rgba(248,246,241,.6);line-height:1.7;">
      üìÑ kb.json: ${kb.exists?fmt(kb.bytes):'not found'} &nbsp;|&nbsp;
      üìÑ content.json: ${ct.exists?fmt(ct.bytes):'not found'}<br>
      üìÅ Path: <code style="font-size:11px;background:rgba(255,255,255,.06);padding:1px 5px;border-radius:4px;">${h(d.storageDir)}</code>
    </div>
    ${!d.persistent?`<div style="margin-top:8px;padding:8px 10px;background:rgba(224,144,80,.08);border:1px solid rgba(224,144,80,.25);border-radius:8px;color:#e09050;line-height:1.6;">
      <strong>To enable persistent storage on Railway:</strong><br>
      1. Add a Volume to your Railway service (Storage ‚Üí Add Volume)<br>
      2. Set mount path (e.g. <code style="font-size:11px;">/data</code>)<br>
      3. Add env var: <code style="font-size:11px;">PERSISTENT_STORAGE_PATH=/data</code><br>
      4. Redeploy ‚Äî your KB will survive future redeploys.
    </div>`:''}`;
  }catch(e){el.innerHTML=`<span style="color:var(--muted);">Storage info unavailable.</span>`;}
}
async function deleteItem(id,btn){
  if(!confirm('Delete this material?'))return;btn.disabled=true;
  await fetch('/api/admin/reference/'+id,{method:'DELETE',headers:{'x-admin-key':adminKey}});
  await loadKB();refreshAdminKB();renderPastBarList();
}
async function deleteSyllabus(btn){
  if(!confirm('Delete syllabus? All generated content will also be cleared.'))return;btn.disabled=true;
  await fetch('/api/admin/syllabus',{method:'DELETE',headers:{'x-admin-key':adminKey}});
  CACHE={};saveLocalCache();
  await loadKB();refreshAdminKB();renderSyllabusTree();updateSyllabusStatus();
}
async function retriggerGen(){
  if(!confirm('Regenerate all content? This replaces all existing lessons and quizzes.'))return;
  // Clear local cache
  CACHE={};saveLocalCache();buildQuizPool();renderSyllabusTree();
  await fetch('/api/admin/content',{method:'DELETE',headers:{'x-admin-key':adminKey}});
  const r=await fetch('/api/admin/generate',{method:'POST',headers:{'Content-Type':'application/json','x-admin-key':adminKey},body:JSON.stringify({})});
  const d=await r.json();
  document.getElementById('adminGenPanel').style.display='block';
  document.getElementById('adminGenDone').style.display='none';
  alert(`Re-generation started! ${d.total||0} topics queued.`);
}
async function clearContent(){
  if(!confirm('Clear all browser-cached content? Server content is preserved.'))return;
  CACHE={};saveLocalCache();buildQuizPool();renderSyllabusTree();
  alert('Browser cache cleared. Click topics to reload from server.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHAT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sendChat(retryMsg){
  const input=document.getElementById('chatInput');
  const msg=retryMsg||input.value.trim();if(!msg)return;
  const box=document.getElementById('chatBox'),btn=document.getElementById('chatBtn');
  if(!retryMsg){
    box.innerHTML+=`<div class="msg-user">${h(msg)}</div>`;
    input.value='';chatHistory.push({role:'user',content:msg});
  }
  btn.disabled=true;box.scrollTop=box.scrollHeight;
  const ai=document.createElement('div');ai.className='msg-ai';ai.textContent='‚öñÔ∏è ‚Ä¶';
  box.appendChild(ai);box.scrollTop=box.scrollHeight;
  try{
    const sys='You are BarBuddy, an expert Philippine Bar Exam reviewer. Cover all 8 Bar subjects. Always cite G.R. numbers, articles, rule provisions. Be concise and exam-focused. 250 words max unless more is needed.';
    const raw=await callAPI({messages:chatHistory,max_tokens:700,system:sys,mode:'chat'});
    ai.innerHTML='‚öñÔ∏è '+raw.replace(/\n/g,'<br>');chatHistory.push({role:'assistant',content:raw});
  }catch(err){
    if(err.overloaded){
      const safeMsg=JSON.stringify(msg);
      ai.innerHTML=`‚ö†Ô∏è API busy ‚Äî Claude is overloaded. <button onclick="this.closest('.msg-ai').remove();sendChat(${safeMsg})" style="margin-left:8px;background:rgba(201,168,76,.15);border:1px solid var(--gold);color:var(--gold-l);border-radius:6px;padding:3px 10px;cursor:pointer;font-size:11px;">‚Ü∫ Retry</button>`;
      if(!retryMsg)chatHistory.pop(); // remove the unanswered user msg from history
    }else{
      ai.innerHTML='‚ö†Ô∏è '+h(err.message);
    }
  }
  btn.disabled=false;box.scrollTop=box.scrollHeight;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function callAPI(payload){
  const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const d=await r.json();
  if(d.overloaded){const e=new Error('API busy ‚Äî Claude is overloaded. Please try again in a moment.');e.overloaded=true;throw e;}
  if(d.error)throw new Error(d.error.message||JSON.stringify(d.error));
  return d.content.map(c=>c.text||'').join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function h(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
</script>
</body>
</html>
