<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BarBuddy — Philippine Bar Exam Companion</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#0d1117;--ink2:#111827;--ink3:#1c2840;
  --gold:#c9a84c;--gold-l:#e2c97e;--gold-d:#7a6128;
  --crim:#9b2335;--crim-l:#c43a4e;--blue:#0038a8;--blue-l:#1a52d4;--teal:#14b4a0;
  --white:#f8f6f1;--muted:#6b7fa0;--card:#131e30;--card2:#0f1924;
  --bdr:rgba(201,168,76,.13);--bdr2:rgba(255,255,255,.07);
  --sw:220px;--fd:'Cormorant Garamond',Georgia,serif;--fb:'DM Sans',sans-serif;--fm:'DM Mono',monospace;
  --c-civil:#4a9eff;--c-criminal:#e07080;--c-political:#50d090;--c-labor:#f0a040;--c-commercial:#a070e0;--c-taxation:#40c0b0;--c-remedial:#e0c050;--c-ethics:#c0a080;--c-custom:#8899aa;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:var(--fb);background:var(--ink);color:var(--white);min-height:100vh;display:flex;overflow-x:hidden;}
/* SIDEBAR — subject-first navigation */
.sidebar{width:var(--sw);background:var(--card2);border-right:1px solid var(--bdr);display:flex;flex-direction:column;align-items:stretch;padding:0 0 16px;position:fixed;inset:0 auto 0 0;z-index:300;overflow-y:auto;overflow-x:hidden;}
.sidebar::-webkit-scrollbar{width:3px;}.sidebar::-webkit-scrollbar-thumb{background:rgba(201,168,76,.15);border-radius:3px;}
.sb-logo-section{display:flex;align-items:center;gap:10px;padding:16px 16px 12px;border-bottom:1px solid var(--bdr);flex-shrink:0;}
.s-logo{width:36px;height:36px;background:linear-gradient(145deg,var(--gold),var(--gold-d));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;box-shadow:0 3px 12px rgba(201,168,76,.3);}
.sb-logo-title{font-family:var(--fd);font-size:17px;font-weight:700;color:var(--gold);line-height:1.1;}
.sb-logo-sub{font-size:9px;color:var(--muted);letter-spacing:.04em;margin-top:2px;}
.sb-divider{border:none;border-top:1px solid rgba(248,246,241,.08);margin:6px 12px;}
.sb-section-label{font-size:10px;font-weight:800;letter-spacing:.12em;color:rgba(248,246,241,.3);text-transform:uppercase;padding:10px 20px 4px;}
.sb-overview-btn{display:flex;align-items:center;gap:9px;padding:10px 16px;margin:2px 8px;border-radius:10px;cursor:pointer;font-family:var(--fd);font-size:14px;font-weight:600;color:rgba(248,246,241,.75);border:none;background:transparent;text-align:left;transition:all .2s;width:calc(100% - 16px);}
.sb-overview-btn:hover{background:rgba(255,255,255,.06);color:rgba(248,246,241,1);}
.sb-overview-btn.active{background:rgba(201,168,76,.1);color:var(--gold);border-left:3px solid var(--gold);padding-left:13px;}
/* Sidebar subject items — single-click, no expand/collapse */
.sb-subject{display:flex;align-items:center;gap:9px;padding:9px 14px;margin:1px 8px;border-radius:10px;cursor:pointer;font-family:var(--fd);font-size:13px;font-weight:600;color:rgba(248,246,241,.75);border:none;border-left:3px solid transparent;background:transparent;text-align:left;transition:all .2s;width:calc(100% - 16px);}
.sb-subject:hover{background:rgba(255,255,255,.06);color:rgba(248,246,241,1);}
.sb-subject.active{background:rgba(201,168,76,.08);color:var(--gold-l);border-left-color:var(--gold)!important;}
/* Material dot + question count */
.sb-subj-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;transition:opacity .2s;}
.sb-subj-qcount{font-size:10px;font-family:var(--fm);color:var(--muted);margin-left:auto;flex-shrink:0;}
.sb-lock-icon{font-size:10px;margin-left:auto;opacity:.5;flex-shrink:0;}
/* Subject page internal tabs */
.subject-page-header{display:flex;align-items:center;gap:14px;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid rgba(248,246,241,.08);}
.subject-color-bar{width:5px;height:48px;border-radius:3px;flex-shrink:0;}
.subject-page-title{font-family:var(--fd);font-size:24px;font-weight:800;color:var(--gold-l);margin:0 0 4px;}
.subject-page-meta{font-size:12px;color:var(--muted);}
.subject-tab-bar{display:flex;gap:4px;border-bottom:2px solid rgba(248,246,241,.08);margin-bottom:24px;padding-bottom:0;}
.subject-tab{padding:10px 20px;font-family:var(--fd);font-size:14px;font-weight:600;color:rgba(248,246,241,.45);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s;border-radius:8px 8px 0 0;display:flex;align-items:center;gap:7px;background:none;border-left:none;border-right:none;border-top:none;}
.subject-tab:hover{color:rgba(248,246,241,.75);background:rgba(255,255,255,.04);}
.subject-tab.active{color:var(--gold-l);border-bottom-color:var(--gold);background:rgba(201,168,76,.06);}
.subject-tab.tab-disabled{opacity:.3;pointer-events:none;text-decoration:line-through;}
/* General ref warning */
.general-ref-warning{background:rgba(201,168,76,.08);border:1px solid rgba(201,168,76,.2);border-radius:8px;padding:8px 12px;font-size:11px;color:rgba(201,168,76,.8);margin-top:6px;display:none;}
/* legacy s-btn kept for JS compat, hidden */
.s-btn{display:none;}.s-div{display:none;}
/* Topbar breadcrumb */
.tb-breadcrumb{flex:1;font-size:12px;color:var(--muted);padding:0 16px;display:flex;align-items:center;gap:6px;}
.tb-bc-sep{opacity:.4;}
.tb-bc-subj{font-weight:600;color:rgba(248,246,241,.75);}
.tb-bc-mode{color:var(--gold-l);}
/* Tab ctrl styles */
.tab-ctrl-row{display:flex;align-items:center;justify-content:space-between;padding:6px 0 6px 16px;}
.tab-ctrl-label{font-size:12px;color:rgba(248,246,241,.7);}
.tab-ctrl-btns{display:flex;border-radius:8px;overflow:hidden;border:1px solid rgba(248,246,241,.1);}
.tct-on,.tct-off{padding:4px 12px;font-size:11px;font-weight:700;border:none;cursor:pointer;font-family:var(--fb);background:rgba(255,255,255,.04);color:rgba(248,246,241,.35);transition:all .15s;}
.tct-on.tct-active{background:rgba(20,180,160,.25);color:#14b4a0;}
.tct-off.tct-active{background:rgba(155,35,53,.25);color:#e07080;}
.tct-on:hover{background:rgba(20,180,160,.1);color:#14b4a0;}
.tct-off:hover{background:rgba(155,35,53,.1);color:#e07080;}
.tab-ctrl-subject-header{display:flex;align-items:center;gap:8px;padding:10px 0 4px;font-family:var(--fd);font-size:13px;font-weight:700;color:rgba(248,246,241,.9);border-top:1px solid rgba(248,246,241,.07);margin-top:6px;}
.tab-ctrl-subject-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0;}
.tab-global-btn{padding:5px 10px;font-size:11px;font-weight:600;border-radius:7px;border:1px solid rgba(248,246,241,.15);background:rgba(255,255,255,.05);color:rgba(248,246,241,.6);cursor:pointer;font-family:var(--fb);transition:all .15s;margin:2px;}
.tab-global-btn:hover{background:rgba(255,255,255,.1);color:rgba(248,246,241,.9);}
/* Mock bar setup */
.mb-setup-card{background:var(--card);border:1px solid var(--bdr2);border-radius:14px;padding:20px;margin-bottom:14px;}
.mb-section-label{font-family:var(--fd);font-size:11px;font-weight:800;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;}
.mb-btn-row{display:flex;gap:6px;flex-wrap:wrap;}
.mb-preset-btn{padding:8px 16px;border-radius:9px;border:1px solid rgba(248,246,241,.12);background:rgba(255,255,255,.05);color:rgba(248,246,241,.7);font-family:var(--fb);font-size:13px;font-weight:600;cursor:pointer;transition:all .18s;}
.mb-preset-btn:hover{border-color:rgba(201,168,76,.3);color:rgba(248,246,241,.95);}
.mb-preset-btn.active{background:rgba(201,168,76,.12);border-color:var(--gold);color:var(--gold-l);}
.mb-subj-tag{padding:6px 12px;border-radius:8px;border:1px solid rgba(248,246,241,.1);background:rgba(255,255,255,.04);color:rgba(248,246,241,.6);font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;}
.mb-subj-tag.on{color:#fff;border-color:transparent;}
.mb-source-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(248,246,241,.06);}
.mb-source-row:last-child{border-bottom:none;}
.mb-source-check{width:16px;height:16px;accent-color:var(--gold);cursor:pointer;flex-shrink:0;}
.mb-source-label{font-size:13px;color:rgba(248,246,241,.8);flex:1;}
.mb-source-count{font-size:11px;color:var(--muted);font-family:var(--fm);}
.mb-preview{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:12px 14px;font-size:12px;color:var(--muted);line-height:1.6;}
.mb-warn-banner{background:rgba(240,160,64,.08);border:1px solid rgba(240,160,64,.3);border-radius:10px;padding:11px 14px;font-size:12px;color:#f0a040;margin-bottom:12px;display:none;}
/* Source picker */
.sources-group-label{font-size:10px;font-weight:800;letter-spacing:.1em;color:rgba(248,246,241,.35);text-transform:uppercase;margin:14px 0 6px;}
.source-item{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;border:1px solid rgba(248,246,241,.08);background:rgba(255,255,255,.03);cursor:pointer;transition:all .18s;margin-bottom:6px;user-select:none;}
.source-item:hover{background:rgba(255,255,255,.06);border-color:rgba(248,246,241,.15);}
.source-item.source-checked{background:rgba(201,168,76,.08);border-color:rgba(201,168,76,.3);}
.source-check-icon{font-size:18px;color:rgba(248,246,241,.4);flex-shrink:0;width:22px;line-height:1;}
.source-item.source-checked .source-check-icon{color:var(--gold);}
.source-item-info{flex:1;min-width:0;}
.source-item-name{font-size:13px;font-weight:600;color:rgba(248,246,241,.88);margin-bottom:3px;}
.source-item.source-checked .source-item-name{color:var(--gold-l);}
.source-item-meta{font-size:11px;color:var(--muted);font-family:var(--fm);}
.source-ctrl-btn{padding:5px 12px;font-size:11px;font-weight:600;border-radius:7px;border:1px solid rgba(248,246,241,.12);background:rgba(255,255,255,.04);color:rgba(248,246,241,.5);cursor:pointer;font-family:var(--fb);transition:all .15s;}
.source-ctrl-btn:hover{background:rgba(255,255,255,.09);color:rgba(248,246,241,.8);}
/* Overview grid */
.overview-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
@media(max-width:1100px){.overview-grid{grid-template-columns:repeat(2,1fr);}}
@media(max-width:600px){.overview-grid{grid-template-columns:1fr;}}
.ov-card{background:var(--card);border:1px solid var(--bdr2);border-radius:14px;padding:16px;display:flex;flex-direction:column;gap:8px;border-top:3px solid transparent;}
.ov-card-name{font-family:var(--fd);font-size:16px;font-weight:700;color:rgba(248,246,241,.9);}
.ov-card-stats{font-size:11px;color:var(--muted);line-height:1.7;}
.ov-card-btns{display:flex;gap:5px;margin-top:4px;flex-wrap:wrap;}
.ov-card-btn{padding:5px 10px;border-radius:7px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid rgba(248,246,241,.1);background:rgba(255,255,255,.04);color:rgba(248,246,241,.65);transition:all .15s;font-family:var(--fb);}
.ov-card-btn:hover{background:rgba(255,255,255,.1);color:rgba(248,246,241,.95);}
/* Subject overview in admin */
.subj-ov-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:18px;}
@media(max-width:900px){.subj-ov-grid{grid-template-columns:repeat(2,1fr);}}
.subj-ov-card{background:var(--card);border:1px solid var(--bdr2);border-radius:12px;padding:14px;border-top:3px solid transparent;}
.subj-ov-name{font-family:var(--fd);font-size:14px;font-weight:700;color:rgba(248,246,241,.9);margin-bottom:6px;display:flex;align-items:center;gap:7px;}
.subj-ov-stats{font-size:11px;color:var(--muted);line-height:1.8;}
.subj-ov-btns{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap;}
.subj-ov-btn{padding:4px 9px;border-radius:6px;font-size:10px;font-weight:600;cursor:pointer;border:1px solid rgba(248,246,241,.1);background:rgba(255,255,255,.04);color:rgba(248,246,241,.6);transition:all .15s;font-family:var(--fb);}
.subj-ov-btn:hover{background:rgba(255,255,255,.1);color:rgba(248,246,241,.9);}
/* TOPBAR */
.topbar{position:sticky;top:0;z-index:200;background:var(--card2);border-bottom:1px solid var(--bdr);height:58px;display:flex;align-items:center;padding:0 22px;}
.tb-brand h1{font-family:var(--fd);font-size:24px;font-weight:700;color:var(--gold);line-height:1;}
.tb-brand h1 em{font-style:italic;color:var(--gold-l);}
.tb-sub{font-size:10px;color:var(--muted);letter-spacing:.04em;}
.ph-flag{display:flex;gap:2px;margin-left:5px;}
.pf-b{width:11px;height:6px;background:var(--blue);border-radius:2px 0 0 2px;}
.pf-r{width:11px;height:6px;background:var(--crim);border-radius:0 2px 2px 0;}
.tb-tabs{display:flex;gap:2px;margin:0 20px;flex:1;}
.tb-tab{display:flex;align-items:center;gap:6px;padding:7px 15px;border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;color:var(--muted);transition:all .2s;border:1px solid transparent;background:transparent;font-family:var(--fb);}
.tb-tab:hover{color:var(--white);background:rgba(255,255,255,.05);}
.tb-tab.on{color:var(--gold);background:rgba(201,168,76,.1);border-color:rgba(201,168,76,.2);}
.tb-tab.mock.on{color:#ff8c42;background:rgba(255,140,66,.1);border-color:rgba(255,140,66,.2);}
.tb-right{display:flex;align-items:center;gap:10px;flex-shrink:0;}
.exam-pill{background:rgba(155,35,53,.2);border:1px solid rgba(155,35,53,.4);color:#e07080;font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;font-family:var(--fm);}
/* KB indicator */
.kb-ind{display:flex;align-items:center;gap:5px;font-size:11px;padding:4px 10px;border-radius:8px;font-family:var(--fm);cursor:pointer;border:1px solid;transition:all .2s;}
.kb-ind.loaded{color:var(--teal);background:rgba(20,180,160,.08);border-color:rgba(20,180,160,.2);}
.kb-ind.empty{color:var(--muted);background:rgba(255,255,255,.04);border-color:var(--bdr2);}
.kb-ind.generating{color:#ff8c42;background:rgba(255,140,66,.08);border-color:rgba(255,140,66,.2);}
.kb-dot{width:6px;height:6px;border-radius:50%;}
.kb-ind.loaded .kb-dot{background:var(--teal);animation:pulse 2s infinite;}
/* API status banner */
#apiBanner{display:none;position:fixed;top:0;left:0;right:0;z-index:500;background:rgba(155,35,53,.92);backdrop-filter:blur(4px);color:#fff;font-size:12px;font-weight:600;text-align:center;padding:7px 16px;letter-spacing:.02em;}
#apiBanner button{margin-left:12px;background:transparent;border:1px solid rgba(255,255,255,.45);color:#fff;border-radius:5px;padding:2px 9px;cursor:pointer;font-size:11px;}
.kb-ind.generating .kb-dot{background:#ff8c42;animation:pulse .6s infinite;}
.kb-ind.empty .kb-dot{background:var(--muted);}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}
.avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--crim),var(--blue));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;border:2px solid var(--bdr);}
/* MAIN */
.main{margin-left:var(--sw);flex:1;display:flex;flex-direction:column;min-height:100vh;}
.page{display:none;flex:1;} .page.on{display:block;}
/* PREGEN BANNER */
.pregen-banner{background:linear-gradient(135deg,#1a1000,#2a1800);border-bottom:1px solid rgba(255,140,66,.25);padding:11px 22px;display:none;align-items:center;gap:14px;position:sticky;top:58px;z-index:190;}
.pregen-banner.on{display:flex;}
.pb-label{font-size:12px;font-weight:600;color:#ff8c42;white-space:nowrap;}
.pb-prog-wrap{flex:1;max-width:300px;}
.pb-track{height:5px;background:rgba(255,255,255,.08);border-radius:3px;overflow:hidden;}
.pb-fill{height:100%;background:linear-gradient(90deg,#d4621a,#ff8c42);border-radius:3px;transition:width .4s;}
.pb-meta{font-size:11px;color:#a08060;font-family:var(--fm);margin-top:4px;}
.pb-cur{font-size:11px;color:#a08060;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.pb-done-badge{font-size:11px;font-weight:700;color:var(--teal);background:rgba(20,180,160,.1);border:1px solid rgba(20,180,160,.3);border-radius:6px;padding:3px 9px;white-space:nowrap;}
/* LAYOUT */
.pg-inner{padding:24px 26px 60px;max-width:1300px;width:100%;}
.two-col{display:grid;grid-template-columns:1fr 278px;gap:20px;}
.left-col{display:flex;flex-direction:column;gap:16px;}
.right-col{display:flex;flex-direction:column;gap:14px;}
/* BUTTONS */
.btn-gold{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,var(--gold),var(--gold-d));color:var(--ink);padding:9px 17px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;border:none;transition:all .2s;font-family:var(--fb);box-shadow:0 4px 14px rgba(201,168,76,.25);}
.btn-gold:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(201,168,76,.35);}
.btn-gold:disabled{opacity:.45;cursor:not-allowed;transform:none;}
.btn-og{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(201,168,76,.5);color:var(--gold-l);padding:7px 14px;border-radius:10px;font-size:12px;font-weight:600;cursor:pointer;background:transparent;transition:all .2s;font-family:var(--fb);}
.btn-og:hover{background:rgba(201,168,76,.1);}
.btn-og:disabled{opacity:.4;cursor:not-allowed;}
.btn-ghost{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.06);color:var(--white);padding:8px 16px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid var(--bdr2);transition:all .2s;font-family:var(--fb);}
.btn-ghost:hover{background:rgba(255,255,255,.1);}
.btn-mock{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#ff8c42,#d4621a);color:#fff;padding:9px 17px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;border:none;transition:all .2s;font-family:var(--fb);box-shadow:0 4px 14px rgba(255,140,66,.3);}
.btn-mock:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(255,140,66,.45);}
.btn-mock:disabled{opacity:.45;cursor:not-allowed;transform:none;}
/* CARDS */
.card{background:var(--card);border:1px solid var(--bdr2);border-radius:18px;overflow:hidden;}
.card-h{padding:14px 20px 12px;border-bottom:1px solid var(--bdr2);display:flex;align-items:center;justify-content:space-between;}
.card-title{font-family:var(--fd);font-size:18px;font-weight:700;color:var(--gold-l);display:flex;align-items:center;gap:8px;}
.card-b{padding:16px 20px;}
/* HERO */
.hero{background:linear-gradient(125deg,var(--ink3),#1a2540,#0f1a30);border:1px solid var(--bdr);border-radius:20px;padding:26px 30px;display:flex;align-items:center;gap:22px;position:relative;overflow:hidden;}
.hero::before{content:'⚖';position:absolute;right:-8px;top:50%;transform:translateY(-50%);font-size:150px;opacity:.04;pointer-events:none;}
.hero::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--blue),var(--gold),var(--crim));}
.hero-txt h2{font-family:var(--fd);font-size:25px;font-weight:700;line-height:1.25;margin-bottom:7px;}
.hero-txt h2 em{font-style:italic;color:var(--gold-l);}
.hero-txt p{font-size:13px;color:var(--muted);line-height:1.55;margin-bottom:16px;}
.hero-btns{display:flex;gap:8px;flex-wrap:wrap;}
.hero-stats{margin-left:auto;display:flex;gap:10px;flex-shrink:0;}
.hst{text-align:center;background:rgba(201,168,76,.08);border:1px solid rgba(201,168,76,.2);border-radius:13px;padding:13px 16px;min-width:72px;}
.hst-n{font-family:var(--fd);font-size:28px;font-weight:700;color:var(--gold-l);line-height:1;}
.hst-l{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-top:3px;}
/* STAT ROW */
.stat-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
.stt{background:var(--card);border:1px solid var(--bdr2);border-radius:13px;padding:14px;display:flex;align-items:center;gap:10px;}
.stt-ic{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.ic-g{background:rgba(201,168,76,.15);}.ic-b{background:rgba(0,56,168,.2);}.ic-r{background:rgba(155,35,53,.2);}.ic-t{background:rgba(20,180,160,.15);}
.stt-n{font-family:var(--fd);font-size:24px;font-weight:700;color:var(--gold-l);line-height:1;}
.stt-l{font-size:11px;color:var(--muted);margin-top:2px;}
/* SUBJECT BADGES */
.sbg{font-size:10px;font-weight:700;padding:2px 8px;border-radius:5px;font-family:var(--fm);letter-spacing:.03em;white-space:nowrap;}
.sg-civ{background:rgba(201,168,76,.15);color:var(--gold);}.sg-cri{background:rgba(155,35,53,.2);color:#e07080;}
.sg-pol{background:rgba(0,56,168,.2);color:#6b9af8;}.sg-lab{background:rgba(20,180,160,.15);color:#14b4a0;}
.sg-com{background:rgba(160,100,200,.15);color:#c080f0;}.sg-tax{background:rgba(200,120,40,.15);color:#e09050;}
.sg-rem{background:rgba(40,160,100,.15);color:#50d090;}.sg-eth{background:rgba(120,120,180,.15);color:#9090d0;}
.sg-gen{background:rgba(100,100,120,.15);color:#a0a0c0;}
/* RECENT ITEMS */
.r-item{display:flex;align-items:center;gap:10px;padding:11px 13px;background:rgba(255,255,255,.03);border:1px solid var(--bdr2);border-radius:12px;cursor:pointer;transition:all .2s;margin-bottom:7px;}
.r-item:last-child{margin-bottom:0;}
.r-item:hover{background:rgba(201,168,76,.06);border-color:rgba(201,168,76,.25);transform:translateX(2px);}
.r-ic{width:34px;height:34px;border-radius:9px;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.2);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
.r-info{flex:1;min-width:0;}
.r-title{font-size:13px;font-weight:600;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.r-sub{font-size:11px;color:var(--muted);}
.tag{font-size:10px;font-weight:700;padding:2px 7px;border-radius:5px;font-family:var(--fm);}
.tg-l{background:rgba(201,168,76,.15);color:var(--gold);}.tg-q{background:rgba(0,56,168,.2);color:#6b9af8;}
.tg-e{background:rgba(20,180,160,.15);color:#14b4a0;}.tg-m{background:rgba(255,140,66,.15);color:#ff8c42;}
/* SUBJECT TRACKER */
.sub-row{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--bdr2);cursor:pointer;transition:all .18s;}
.sub-row:last-child{border-bottom:none;}
.sub-row:hover{opacity:.82;}
.sub-num{width:24px;height:24px;border-radius:6px;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.2);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:var(--gold);font-family:var(--fm);flex-shrink:0;}
.bar-track{height:4px;background:rgba(255,255,255,.07);border-radius:2px;overflow:hidden;width:70px;}
.bar-fill{height:100%;border-radius:2px;transition:width .6s;}
.bf-g{background:linear-gradient(90deg,var(--gold-d),var(--gold));}.bf-r{background:linear-gradient(90deg,var(--crim),var(--crim-l));}
.bf-b{background:linear-gradient(90deg,var(--blue),var(--blue-l));}.bf-t{background:linear-gradient(90deg,#0d8a7a,var(--teal));}
/* WARN */
.warn{background:linear-gradient(135deg,#2a1a06,#1e1406);border:1px solid rgba(201,168,76,.28);border-radius:14px;padding:14px 18px;display:flex;align-items:center;gap:12px;}
.warn strong{font-size:13px;font-weight:600;color:var(--gold-l);display:block;margin-bottom:2px;}
.warn span{font-size:12px;color:#a08040;}
/* RIGHT SIDEBAR */
.rc{background:var(--card);border:1px solid var(--bdr2);border-radius:16px;overflow:hidden;}
.rc-h{padding:13px 16px 11px;border-bottom:1px solid var(--bdr2);font-family:var(--fd);font-size:16px;font-weight:700;color:var(--gold-l);}
.rc-b{padding:10px 12px;}
.act{display:flex;align-items:center;gap:9px;padding:9px 10px;border-radius:9px;cursor:pointer;transition:background .18s;font-size:13px;font-weight:500;border:none;width:100%;text-align:left;background:transparent;color:var(--white);font-family:var(--fb);margin-bottom:2px;}
.act:last-child{margin-bottom:0;}
.act:hover{background:rgba(201,168,76,.08);}
/* KB CARD */
.kb-card{background:linear-gradient(145deg,#081410,#0d1f16);border:1px solid rgba(20,180,160,.2);border-radius:16px;padding:16px;}
.kb-item{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.05);font-size:12px;}
.kb-item:last-child{border-bottom:none;}
/* ─── SPLIT LAYOUT (Learn + Practice + Mock) ─── */
.split-layout{display:grid;grid-template-columns:258px 1fr;height:calc(100vh - 58px);overflow:hidden;}
.panel-l{background:var(--card2);border-right:1px solid var(--bdr);display:flex;flex-direction:column;overflow:hidden;}
.pl-head{padding:16px 14px 13px;border-bottom:1px solid var(--bdr);}
.pl-head h3{font-family:var(--fd);font-size:17px;font-weight:700;color:var(--gold-l);margin-bottom:8px;}
.sp-search{width:100%;background:rgba(255,255,255,.05);border:1px solid var(--bdr2);border-radius:9px;padding:7px 11px;color:var(--white);font-family:var(--fb);font-size:12px;outline:none;transition:border-color .2s;}
.sp-search:focus{border-color:rgba(201,168,76,.4);}
.prog-mini{margin-top:8px;}
.prog-row{display:flex;justify-content:space-between;margin-bottom:4px;}
.prog-pct{font-size:11px;font-weight:700;color:var(--gold);font-family:var(--fm);}
.prog-lbl{font-size:10px;color:var(--muted);}
.prog-track{height:3px;background:rgba(255,255,255,.08);border-radius:2px;overflow:hidden;}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--gold-d),var(--gold));border-radius:2px;transition:width .5s;}
.tree{flex:1;overflow-y:auto;padding:6px 0;}
.tree::-webkit-scrollbar{width:3px;}
.tree::-webkit-scrollbar-thumb{background:rgba(201,168,76,.2);border-radius:3px;}
.up-btn{margin:8px 10px;padding:9px;border-radius:9px;background:rgba(201,168,76,.07);border:1px dashed rgba(201,168,76,.28);color:var(--gold-l);font-size:12px;font-weight:600;cursor:pointer;text-align:center;transition:all .2s;font-family:var(--fb);}
.up-btn:hover{background:rgba(201,168,76,.15);}
/* TREE NODES */
.subj-hdr{display:flex;align-items:center;gap:7px;padding:8px 12px;cursor:pointer;transition:background .18s;user-select:none;}
.subj-hdr:hover{background:rgba(255,255,255,.03);}
.chev{color:var(--muted);font-size:10px;transition:transform .2s;}
.subj-hdr.open .chev{transform:rotate(90deg);}
.subj-label{font-size:12px;font-weight:700;flex:1;color:var(--white);}
.subj-cnt{font-size:10px;color:var(--muted);font-family:var(--fm);}
.topic-list{display:none;} .topic-list.open{display:block;}
.topic-item{display:flex;align-items:center;gap:7px;padding:7px 12px 7px 26px;cursor:pointer;transition:all .18s;font-size:12px;color:var(--muted);position:relative;}
.topic-item:hover{color:var(--white);background:rgba(255,255,255,.03);}
.topic-item.active{color:var(--gold-l);background:rgba(201,168,76,.08);}
.topic-item.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:var(--gold);}
.t-chk{font-size:10px;flex-shrink:0;color:rgba(255,255,255,.15);}
.topic-item.done .t-chk{color:var(--teal);}
.t-lbl{flex:1;line-height:1.4;}
/* HIERARCHICAL TOPIC TREE */
.topic-group-header{display:flex;align-items:center;gap:8px;padding:8px 12px 5px 16px;cursor:pointer;user-select:none;font-size:11px;font-weight:700;letter-spacing:.04em;color:rgba(248,246,241,.45);text-transform:uppercase;}
.topic-group-header:hover{color:rgba(248,246,241,.7);}
.topic-expand-icon{font-size:8px;transition:transform .18s;display:inline-block;color:rgba(248,246,241,.3);}
.topic-group-header.open .topic-expand-icon{transform:rotate(90deg);}
.topic-group-children{display:none;padding-left:10px;}
.topic-group-children.open{display:block;}
.topic-parent-row{display:flex;align-items:center;gap:7px;padding:6px 12px 6px 20px;cursor:pointer;font-size:12px;font-weight:600;color:rgba(248,246,241,.6);position:relative;transition:all .15s;}
.topic-parent-row:hover{color:rgba(248,246,241,.9);background:rgba(255,255,255,.03);}
.topic-parent-row.open .topic-expand-icon{transform:rotate(90deg);}
.topic-parent-children{display:none;padding-left:10px;}
.topic-parent-children.open{display:block;}
.topic-leaf-item{display:flex;align-items:center;gap:7px;padding:6px 12px 6px 24px;cursor:pointer;transition:all .18s;font-size:12px;color:var(--muted);position:relative;}
.topic-leaf-item:hover{color:var(--white);background:rgba(255,255,255,.03);}
.topic-leaf-item.active{color:var(--gold-l);background:rgba(201,168,76,.08);}
.topic-leaf-item.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:var(--gold);}
.topic-leaf-item.done .t-chk{color:var(--teal);}
.topic-badge-cached{font-size:9px;padding:1px 5px;border-radius:3px;font-family:var(--fm);flex-shrink:0;background:rgba(20,180,160,.15);color:var(--teal);}
/* SYLLABUS WARNINGS PANEL */
.syllabus-warnings{margin-top:10px;border:1px solid rgba(255,160,64,.25);border-radius:10px;overflow:hidden;}
.sw-header{display:flex;align-items:center;gap:8px;padding:10px 14px;cursor:pointer;background:rgba(255,160,64,.06);font-size:12px;color:#f0a040;}
.sw-header:hover{background:rgba(255,160,64,.1);}
.sw-body{display:none;padding:10px 14px;border-top:1px solid rgba(255,160,64,.15);}
.sw-body.open{display:block;}
.sw-item{font-size:11px;color:rgba(248,246,241,.55);padding:4px 0;border-bottom:1px solid rgba(248,246,241,.05);}
.sw-item:last-child{border-bottom:none;}
/* READY BADGE — shows pre-generated content is cached */
.ready-badge{font-size:9px;padding:1px 5px;border-radius:3px;font-family:var(--fm);flex-shrink:0;}
.rb-cached{background:rgba(20,180,160,.15);color:var(--teal);}
.rb-gen{background:rgba(255,140,66,.12);color:#ff8c42;animation:genFlash 1s ease infinite;}
@keyframes genFlash{0%,100%{opacity:1;}50%{opacity:.4;}}
/* LESSON PANEL */
.panel-r{display:flex;flex-direction:column;overflow:hidden;}
.pr-top{padding:13px 24px;border-bottom:1px solid var(--bdr2);display:flex;align-items:center;gap:12px;background:var(--ink2);}
.pr-bc{font-size:12px;color:var(--muted);flex:1;} .pr-bc strong{color:var(--gold-l);}
.pr-content{flex:1;overflow-y:auto;padding:28px 38px;background:var(--ink);}
.pr-content::-webkit-scrollbar{width:5px;}
.pr-content::-webkit-scrollbar-thumb{background:rgba(201,168,76,.15);border-radius:4px;}
.pr-foot{padding:13px 24px;border-top:1px solid var(--bdr2);display:flex;align-items:center;justify-content:space-between;background:var(--ink2);}
/* WELCOME / GEN STATES */
.welcome-st{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;padding:36px;color:var(--muted);}
.welcome-st .big-ic{font-size:60px;margin-bottom:16px;opacity:.35;}
.welcome-st h3{font-family:var(--fd);font-size:25px;font-weight:700;color:var(--gold-l);margin-bottom:8px;opacity:.7;}
.welcome-st p{font-size:14px;line-height:1.6;max-width:380px;margin-bottom:18px;}
.gen-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:13px;}
.spin{width:36px;height:36px;border:3px solid rgba(201,168,76,.2);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
/* LESSON CONTENT */
.lc h2{font-family:var(--fd);font-size:26px;font-weight:700;color:var(--gold-l);margin-bottom:8px;line-height:1.2;}
.lc-meta{display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap;}
.lc h3{font-family:var(--fd);font-size:20px;font-weight:700;color:var(--gold-l);margin:22px 0 9px;}
.lc h4{font-size:15px;font-weight:700;color:#a8bfdf;margin:16px 0 7px;}
.lc p{font-size:14px;line-height:1.85;color:rgba(248,246,241,.82);margin-bottom:11px;}
.lc ul,.lc ol{padding-left:20px;margin-bottom:11px;}
.lc li{font-size:14px;line-height:1.8;color:rgba(248,246,241,.8);}
.lc strong{color:var(--white);} .lc em{color:var(--gold-l);font-style:italic;}
.definition-box{background:rgba(201,168,76,.07);border-left:3px solid var(--gold);border-radius:0 10px 10px 0;padding:13px 15px;margin:13px 0;font-size:14px;line-height:1.7;}
.case-box{background:rgba(0,56,168,.1);border:1px solid rgba(0,56,168,.25);border-radius:11px;padding:13px 15px;margin:13px 0;font-size:14px;line-height:1.7;}
.case-box strong{color:#6b9af8;display:block;margin-bottom:4px;}
.codal-box{background:rgba(155,35,53,.08);border:1px solid rgba(155,35,53,.25);border-radius:11px;padding:13px 15px;margin:13px 0;font-size:13px;line-height:1.7;font-family:var(--fm);color:#e07080;}
.rule-box{background:rgba(20,180,160,.07);border-left:3px solid var(--teal);border-radius:0 10px 10px 0;padding:13px 15px;margin:13px 0;font-size:14px;line-height:1.7;color:#80ddd0;}
.tip-box{background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:11px;padding:13px 15px;margin:13px 0;font-size:13px;line-height:1.7;color:var(--gold-l);}
.kb-ref-note{background:rgba(20,180,160,.06);border:1px solid rgba(20,180,160,.18);border-radius:9px;padding:8px 12px;margin-bottom:14px;font-size:12px;color:var(--teal);display:flex;align-items:center;gap:7px;}
/* PRACTICE */
.qn-list{flex:1;overflow-y:auto;padding:6px 0;}
.qn-list::-webkit-scrollbar{width:3px;}
.qn-list::-webkit-scrollbar-thumb{background:rgba(201,168,76,.2);border-radius:3px;}
.qn-item{display:flex;align-items:center;gap:9px;padding:9px 12px;cursor:pointer;transition:all .18s;position:relative;}
.qn-item:hover{background:rgba(255,255,255,.03);}
.qn-item.active{background:rgba(201,168,76,.08);}
.qn-item.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:var(--gold);}
.qn-icon{font-size:15px;flex-shrink:0;}
.qn-info{flex:1;min-width:0;}
.qn-title{font-size:12px;font-weight:600;color:var(--white);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:1px;}
.qn-sub{font-size:10px;color:var(--muted);}
.q-type-tabs{display:flex;gap:5px;margin-top:10px;}
.qtt{flex:1;padding:7px 5px;border-radius:8px;border:1px solid var(--bdr2);text-align:center;cursor:pointer;font-size:11px;font-weight:600;color:var(--muted);transition:all .2s;}
.qtt.on{border-color:rgba(201,168,76,.4);background:rgba(201,168,76,.08);color:var(--gold-l);}
.qtt:hover:not(.on){color:var(--white);border-color:rgba(255,255,255,.12);}
.qtt-ic{font-size:16px;display:block;margin-bottom:2px;}
/* QUIZ ELEMENTS */
.qm-body{flex:1;overflow-y:auto;padding:24px 32px;background:var(--ink);}
.qm-body::-webkit-scrollbar{width:5px;}
.qm-body::-webkit-scrollbar-thumb{background:rgba(201,168,76,.15);border-radius:4px;}
.q-prog-track{height:4px;background:rgba(255,255,255,.07);border-radius:2px;overflow:hidden;margin-bottom:7px;}
.q-prog-fill{height:100%;background:linear-gradient(90deg,var(--gold-d),var(--gold));border-radius:2px;transition:width .4s;}
.q-prog-meta{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);font-family:var(--fm);margin-bottom:18px;}
.q-question{font-size:15px;font-weight:500;line-height:1.75;margin-bottom:16px;color:var(--white);}
.q-opts{display:flex;flex-direction:column;gap:8px;}
.q-opt{padding:12px 16px;background:rgba(255,255,255,.04);border:1px solid var(--bdr2);border-radius:11px;cursor:pointer;font-size:14px;line-height:1.5;transition:all .2s;}
.q-opt:hover:not(.correct):not(.wrong){border-color:rgba(201,168,76,.4);background:rgba(201,168,76,.06);}
.q-opt.correct{border-color:var(--teal)!important;background:rgba(20,180,160,.1)!important;color:#80ddd0;}
.q-opt.wrong{border-color:var(--crim-l)!important;background:rgba(155,35,53,.1)!important;color:#e07080;}
.q-feedback{margin-top:12px;padding:13px 15px;border-radius:11px;font-size:14px;line-height:1.65;display:none;}
.q-feedback.show{display:block;}
.q-feedback.ok{background:rgba(20,180,160,.1);border:1px solid rgba(20,180,160,.3);color:#80ddd0;}
.q-feedback.no{background:rgba(155,35,53,.1);border:1px solid rgba(155,35,53,.3);color:#e07080;}
/* ESSAY */
.essay-prompt{font-size:15px;font-weight:600;line-height:1.75;margin-bottom:10px;color:var(--white);}
.facts-box,.essay-ctx{background:rgba(248,246,241,.07);border-left:4px solid var(--gold);border-radius:0 12px 12px 0;padding:20px 22px;margin-bottom:22px;}
.facts-label{font-family:var(--fd);font-size:11px;font-weight:800;letter-spacing:.12em;color:var(--gold);text-transform:uppercase;margin-bottom:12px;display:flex;align-items:center;gap:7px;}
.facts-label::before{content:'';display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--gold);}
.facts-text{font-size:16px;font-style:normal;font-weight:400;line-height:1.85;color:rgba(248,246,241,.95);font-family:var(--fb);}
.question-label{font-family:var(--fd);font-size:11px;font-weight:800;letter-spacing:.12em;color:var(--og);text-transform:uppercase;margin-bottom:10px;margin-top:20px;display:flex;align-items:center;gap:7px;}
.question-label::before{content:'';display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--og);}
.question-text{font-size:15px;font-weight:700;line-height:1.75;color:rgba(248,246,241,1);font-family:var(--fb);}
.q-label{font-size:10px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:.09em;margin-bottom:5px;display:block;}
.alac-table{width:100%;border-collapse:collapse;font-size:13px;margin:10px 0;}
.alac-table th{text-align:left;padding:6px 10px;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;border-bottom:1px solid var(--bdr2);}
.alac-table td{padding:7px 10px;vertical-align:top;border-bottom:1px solid rgba(255,255,255,.04);}
.alac-score{font-family:var(--fm);font-weight:700;font-size:13px;white-space:nowrap;padding:2px 8px;border-radius:5px;display:inline-block;}
.alac-score.hi{color:#14b4a0;background:rgba(20,180,160,.15);}
.alac-score.mid{color:#c9a84c;background:rgba(201,168,76,.15);}
.alac-score.lo{color:#e07080;background:rgba(155,35,53,.15);}
.alac-total-row td{border-top:1px solid var(--bdr2);font-weight:700;padding:8px 10px;}
.alac-model{white-space:pre-line;font-size:13px;line-height:1.8;}
.model-answer-section{margin-bottom:2px;}
.ma-label{color:var(--gold);font-weight:700;text-transform:uppercase;font-size:11px;letter-spacing:.08em;margin-bottom:4px;}
.ma-text{font-size:14px;line-height:1.75;color:rgba(248,246,241,.88);margin-bottom:14px;white-space:pre-line;}
.essay-box{width:100%;min-height:190px;background:rgba(255,255,255,.04);border:1px solid var(--bdr2);border-radius:11px;padding:13px 15px;color:var(--white);font-family:var(--fb);font-size:14px;line-height:1.75;outline:none;resize:vertical;transition:border-color .2s;}
.essay-box:focus{border-color:rgba(201,168,76,.4);}
.ai-fb{background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:13px;padding:16px;margin-top:14px;display:none;}
.ai-fb.show{display:block;}
.ai-fb-head{font-size:12px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:.06em;margin-bottom:9px;display:flex;align-items:center;gap:7px;flex-wrap:wrap;}
.ai-fb-score{background:rgba(201,168,76,.15);border-radius:5px;padding:2px 7px;font-family:var(--fm);}
.ai-fb-content{font-size:14px;line-height:1.75;color:rgba(248,246,241,.85);}
/* QUIZ RESULTS */
.quiz-results{text-align:center;padding:18px 0;}
.qr-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:18px 0;}
.qr-stat{background:rgba(255,255,255,.04);border:1px solid var(--bdr2);border-radius:11px;padding:13px;text-align:center;}
.qr-stat .n{font-family:var(--fd);font-size:26px;font-weight:700;color:var(--gold-l);}
.qr-stat .l{font-size:11px;color:var(--muted);margin-top:2px;}
/* ─── MOCK BAR ─── */
.mock-hero{background:linear-gradient(125deg,#1a0a00,#2a1400,#1a0800);border:1px solid rgba(255,140,66,.2);border-radius:20px;padding:26px 30px;position:relative;overflow:hidden;}
.mock-hero::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#ff8c42,var(--gold),#ff8c42);}
.mock-hero h2{font-family:var(--fd);font-size:26px;font-weight:700;margin-bottom:6px;color:#ff8c42;}
.mock-hero h2 em{font-style:italic;color:var(--gold-l);}
.mock-hero p{font-size:13px;color:#a08060;line-height:1.6;margin-bottom:18px;max-width:600px;}
.mock-config-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;}
.mc-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,140,66,.15);border-radius:13px;padding:14px;}
.mc-label{font-size:11px;color:#a08060;font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px;}
.mc-select{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,140,66,.25);border-radius:8px;padding:8px 10px;color:var(--white);font-family:var(--fb);font-size:13px;outline:none;}
.mc-subj-tag{font-size:10px;font-weight:700;padding:3px 8px;border-radius:5px;cursor:pointer;transition:all .2s;border:1px solid transparent;font-family:var(--fm);}
.mc-subj-tag.on{background:rgba(255,140,66,.2);border-color:rgba(255,140,66,.4);color:#ff8c42;}
.mc-subj-tag:not(.on){background:rgba(255,255,255,.04);border-color:var(--bdr2);color:var(--muted);}
/* SESSION */
.mock-session{display:none;} .mock-session.on{display:block;}
.ms-header{background:linear-gradient(135deg,#1a0a00,#2a1400);border:1px solid rgba(255,140,66,.2);border-radius:13px;padding:15px 20px;display:flex;align-items:center;gap:16px;margin-bottom:18px;}
.ms-q-num{font-family:var(--fd);font-size:22px;font-weight:700;color:#ff8c42;}
.ms-of{font-size:12px;color:#a08060;font-family:var(--fm);}
.ms-timer{display:flex;align-items:center;gap:6px;font-size:22px;font-weight:700;color:#ff8c42;font-family:var(--fm);margin-left:auto;}
.ms-timer.warn{color:#e07080;animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.4;}}
.ms-source{font-size:10px;color:#a08060;background:rgba(255,140,66,.1);border-radius:5px;padding:2px 7px;font-family:var(--fm);}
.q-markers{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:16px;}
.q-marker{width:26px;height:26px;border-radius:6px;border:1px solid var(--bdr2);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;cursor:pointer;transition:all .18s;color:var(--muted);}
.q-marker.done{background:rgba(255,140,66,.15);border-color:rgba(255,140,66,.4);color:#ff8c42;}
.q-marker.current{background:rgba(255,140,66,.25);border-color:#ff8c42;color:#ff8c42;}
/* MOCK RESULTS */
.mock-results{background:linear-gradient(145deg,#1a0a00,#0d0800);border:1px solid rgba(255,140,66,.2);border-radius:20px;padding:32px;text-align:center;}
.mr-grade{font-family:var(--fd);font-size:64px;font-weight:700;color:#ff8c42;line-height:1;margin:10px 0;}
.mr-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:22px 0;}
.mr-stat{background:rgba(255,255,255,.04);border:1px solid rgba(255,140,66,.15);border-radius:11px;padding:12px;text-align:center;}
.mr-stat .n{font-family:var(--fd);font-size:22px;font-weight:700;color:#ff8c42;}
.mr-stat .l{font-size:11px;color:#a08060;margin-top:2px;}
.q-review-item{background:rgba(255,255,255,.03);border:1px solid var(--bdr2);border-radius:12px;padding:13px;margin-bottom:9px;text-align:left;}
.q-score-badge{display:inline-flex;align-items:center;gap:5px;font-size:11px;font-weight:700;padding:3px 9px;border-radius:6px;font-family:var(--fm);}
.qsb-high{background:rgba(20,180,160,.15);color:var(--teal);}
.qsb-mid{background:rgba(201,168,76,.15);color:var(--gold);}
.qsb-low{background:rgba(155,35,53,.15);color:#e07080;}
/* MOCK SOURCE STATS */
.source-stats{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;}
.src-badge{font-size:11px;padding:4px 10px;border-radius:7px;font-family:var(--fm);font-weight:600;}
.sb-real{background:rgba(155,35,53,.15);color:#e07080;border:1px solid rgba(155,35,53,.25);}
.sb-pregen{background:rgba(20,180,160,.1);color:var(--teal);border:1px solid rgba(20,180,160,.2);}
.sb-ai{background:rgba(255,140,66,.1);color:#ff8c42;border:1px solid rgba(255,140,66,.2);}
/* MANUAL ENTRY DIVIDER */
.manual-divider{display:flex;align-items:center;gap:10px;font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.05em;margin:20px 0 14px;text-transform:uppercase;}
.manual-divider::before,.manual-divider::after{content:'';flex:1;height:1px;background:var(--bdr);}
.mn-note{background:rgba(20,180,160,.07);border:1px solid rgba(20,180,160,.2);border-radius:10px;padding:10px 13px;font-size:12px;color:var(--teal);line-height:1.55;margin-bottom:14px;}
.mn-preview{display:flex;flex-direction:column;gap:5px;margin:12px 0;}
.mn-prev-item{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.04);border:1px solid var(--bdr2);border-radius:8px;padding:7px 11px;font-size:12px;color:var(--white);}
.mn-prev-item .mn-rm{margin-left:auto;background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;line-height:1;padding:0 2px;}
.mn-prev-item .mn-rm:hover{color:#e07080;}
.mn-radio-group{display:flex;gap:14px;margin-bottom:10px;}
.mn-radio-group label{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--white);cursor:pointer;}
/* ─── ADMIN ─── */
.admin-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;}
.admin-panel{background:var(--card);border:1px solid var(--bdr2);border-radius:16px;padding:20px;}
.admin-panel h3{font-family:var(--fd);font-size:18px;font-weight:700;color:var(--gold-l);margin-bottom:5px;}
.admin-panel p{font-size:12px;color:var(--muted);margin-bottom:14px;line-height:1.55;}
.form-label{font-size:11px;font-weight:600;color:var(--gold-l);display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.04em;}
.form-input{width:100%;background:rgba(255,255,255,.05);border:1px solid var(--bdr2);border-radius:9px;padding:9px 12px;color:var(--white);font-family:var(--fb);font-size:13px;outline:none;transition:border-color .2s;margin-bottom:10px;}
.form-input:focus{border-color:rgba(201,168,76,.4);}
.form-select{width:100%;background:rgba(255,255,255,.05);border:1px solid var(--bdr2);border-radius:9px;padding:9px 12px;color:var(--white);font-family:var(--fb);font-size:13px;outline:none;margin-bottom:10px;}
.form-select option{background:var(--card2);}
.kb-list-item{display:flex;align-items:center;gap:9px;padding:8px 10px;background:rgba(255,255,255,.03);border:1px solid var(--bdr2);border-radius:9px;margin-bottom:6px;}
.kl-name{font-size:12px;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.kl-sub{font-size:10px;color:var(--muted);}
.kl-del{font-size:11px;color:#e07080;cursor:pointer;padding:3px 7px;border-radius:5px;background:rgba(155,35,53,.1);border:none;transition:background .18s;}
.kl-del:hover{background:rgba(155,35,53,.25);}
.kl-dl{font-size:11px;color:var(--gold);cursor:pointer;padding:3px 7px;border-radius:5px;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.3);margin-right:4px;transition:background .18s;}
.kl-dl:hover{background:rgba(201,168,76,.2);}
.tab-toggle-btn{padding:7px 14px;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer;border:1px solid;font-family:var(--fm);transition:all .2s;white-space:nowrap;}
.tt-on{background:rgba(20,180,160,.15);border-color:rgba(20,180,160,.4);color:#14b4a0;}
.tt-off{background:rgba(155,35,53,.15);border-color:rgba(155,35,53,.4);color:#e07080;}
.dl-picker{display:none;align-items:center;gap:6px;flex-wrap:wrap;padding:7px 10px 10px 40px;background:rgba(255,255,255,.03);border:1px solid var(--bdr2);border-top:none;border-radius:0 0 9px 9px;margin-top:-6px;margin-bottom:6px;}
/* Auth wall */
@keyframes authBgShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
#authWall{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;background:rgba(8,12,24,.85);backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);background-image:radial-gradient(ellipse at 20% 50%,rgba(120,40,40,.15) 0%,transparent 60%),radial-gradient(ellipse at 80% 20%,rgba(201,168,76,.08) 0%,transparent 50%);}
.auth-card{background:rgba(16,22,42,.97);border:1px solid rgba(201,168,76,.25);border-radius:20px;width:100%;max-width:440px;padding:36px 32px;position:relative;box-shadow:0 32px 80px rgba(0,0,0,.6),0 0 0 1px rgba(201,168,76,.08),inset 0 1px 0 rgba(255,255,255,.06);}
.auth-card::before{content:'';position:absolute;top:0;left:10%;right:10%;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);}
.auth-logo{font-family:var(--fd);font-size:28px;font-weight:800;color:var(--gold-l);text-align:center;margin-bottom:4px;letter-spacing:.02em;}
.auth-sub{font-size:13px;color:var(--muted);text-align:center;margin-bottom:28px;}
.auth-tabs{display:flex;gap:6px;margin-bottom:22px;background:rgba(255,255,255,.04);border-radius:11px;padding:4px;}
.auth-tab-btn{flex:1;padding:8px;border:none;border-radius:8px;cursor:pointer;font-family:var(--fm);font-size:13px;font-weight:700;background:transparent;color:var(--muted);transition:all .2s;}
.auth-tab-btn.active{background:rgba(201,168,76,.18);color:var(--gold-l);}
.auth-field{margin-bottom:14px;}
.auth-field label{display:block;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px;}
.auth-field input{width:100%;box-sizing:border-box;background:rgba(255,255,255,.05);border:1px solid var(--bdr2);border-radius:9px;padding:11px 14px;color:var(--white);font-family:var(--fb);font-size:14px;outline:none;transition:border-color .2s;}
.auth-field input:focus{border-color:rgba(201,168,76,.5);}
.auth-err{font-size:12px;color:#e07080;margin-bottom:10px;min-height:16px;text-align:center;}
.auth-btn{width:100%;padding:13px;background:linear-gradient(135deg,#b8932a,#d4a843);border:none;border-radius:11px;color:#0a0e1a;font-family:var(--fm);font-size:15px;font-weight:800;cursor:pointer;transition:opacity .2s;letter-spacing:.03em;}
.auth-btn:hover{opacity:.88;}
.auth-btn:disabled{opacity:.5;cursor:not-allowed;}
/* Topbar user display */
#userNameDisplay{font-size:12px;font-weight:700;color:var(--gold);background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.25);border-radius:8px;padding:5px 10px;white-space:nowrap;}
/* Results detail modal */
.res-detail-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:18px;}
.res-dstat{background:rgba(255,255,255,.04);border:1px solid var(--bdr2);border-radius:10px;padding:12px;text-align:center;}
.res-dstat-val{font-family:var(--fd);font-size:22px;font-weight:800;color:var(--gold-l);}
.res-dstat-lbl{font-size:11px;color:var(--muted);margin-top:2px;}
/* Admin user/results panels */
.ur-row{display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(255,255,255,.03);border:1px solid var(--bdr2);border-radius:10px;margin-bottom:7px;flex-wrap:wrap;}
.ur-name{font-weight:700;font-size:14px;flex:1;min-width:120px;}
.ur-meta{font-size:11px;color:var(--muted);}
.ur-badge{font-size:10px;font-weight:700;padding:2px 7px;border-radius:5px;background:rgba(20,180,160,.15);color:#14b4a0;}
.ur-badge.off{background:rgba(155,35,53,.15);color:#e07080;}
.ur-act{font-size:11px;padding:4px 9px;border-radius:7px;cursor:pointer;border:1px solid;font-family:var(--fm);font-weight:700;transition:all .18s;}
.ur-act.enable{color:#14b4a0;border-color:rgba(20,180,160,.4);background:rgba(20,180,160,.1);}
.ur-act.disable{color:#e07080;border-color:rgba(155,35,53,.4);background:rgba(155,35,53,.1);}
.ur-act.del{color:#e07080;border-color:rgba(155,35,53,.4);background:transparent;}
.ur-act.view{color:var(--gold);border-color:rgba(201,168,76,.4);background:rgba(201,168,76,.1);}
.admin-locked{text-align:center;padding:48px;color:var(--muted);}
/* Gen progress panel */
.gen-prog-panel{background:linear-gradient(135deg,#0a1000,#141800);border:1px solid rgba(255,140,66,.25);border-radius:14px;padding:18px;margin-top:14px;}
.gpp-head{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.gpp-title{font-family:var(--fd);font-size:17px;font-weight:700;color:#ff8c42;}
.gpp-track{height:6px;background:rgba(255,255,255,.08);border-radius:3px;overflow:hidden;margin-bottom:7px;}
.gpp-fill{height:100%;background:linear-gradient(90deg,#d4621a,#ff8c42);border-radius:3px;transition:width .4s;}
.gpp-meta{font-size:12px;color:#a08060;font-family:var(--fm);}
.gpp-cur{font-size:11px;color:#a08060;margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
/* MODALS */
.overlay{display:none;position:fixed;inset:0;background:rgba(5,10,18,.85);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(8px);}
.overlay.on{display:flex;}
.modal{background:var(--card);border:1px solid rgba(201,168,76,.2);border-radius:20px;width:92%;max-width:620px;max-height:88vh;overflow-y:auto;padding:30px;position:relative;animation:mIn .28s cubic-bezier(.22,.68,0,1.35);box-shadow:0 32px 80px rgba(0,0,0,.65);}
.modal::before{content:'';position:absolute;top:0;left:10%;right:10%;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);}
@keyframes mIn{from{transform:scale(.91) translateY(22px);opacity:0;}to{transform:scale(1) translateY(0);opacity:1;}}
.modal-x{position:absolute;top:16px;right:16px;width:30px;height:30px;background:rgba(255,255,255,.07);border:none;border-radius:8px;color:var(--muted);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .18s;}
.modal-x:hover{background:rgba(255,255,255,.14);color:var(--white);}
.modal-t{font-family:var(--fd);font-size:24px;font-weight:700;color:var(--gold-l);margin-bottom:6px;}
.modal-s{font-size:13px;color:var(--muted);margin-bottom:20px;line-height:1.55;}
/* ANIMS */
.fade{opacity:0;animation:fadeUp .4s ease forwards;}
.fade:nth-child(1){animation-delay:.04s;}.fade:nth-child(2){animation-delay:.09s;}.fade:nth-child(3){animation-delay:.14s;}.fade:nth-child(4){animation-delay:.19s;}.fade:nth-child(5){animation-delay:.23s;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
::-webkit-scrollbar{width:6px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:rgba(201,168,76,.14);border-radius:4px;}
@media(max-width:900px){.two-col{grid-template-columns:1fr;}.right-col{display:none;}.stat-row{grid-template-columns:repeat(2,1fr);}.split-layout{grid-template-columns:1fr;}.panel-l{display:none;}.mock-config-grid{grid-template-columns:1fr;}.admin-grid{grid-template-columns:1fr;}.mr-stats{grid-template-columns:repeat(2,1fr);}}
</style>
</head>
<body>

<!-- AUTH WALL -->
<div id="authWall">
  <div class="auth-card">
    <div class="auth-logo">⚖️ BarBuddy</div>
    <div class="auth-sub">Philippine Bar Exam AI Companion</div>
    <div class="auth-tabs" id="authTabRow">
      <button class="auth-tab-btn active" onclick="switchAuthTab('login')">Log In</button>
      <button class="auth-tab-btn" onclick="switchAuthTab('register')">Register</button>
    </div>
    <!-- Login form -->
    <div id="authFormLogin">
      <div class="auth-field"><label>Email</label><input type="email" id="loginEmail" placeholder="you@email.com" autocomplete="email"></div>
      <div class="auth-field"><label>Password</label><input type="password" id="loginPassword" placeholder="••••••••" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <div style="text-align:right;margin-top:-8px;margin-bottom:14px;"><button onclick="showForgotPassword()" style="background:none;border:none;color:var(--gold-l);font-size:12px;cursor:pointer;text-decoration:underline;font-family:var(--fb);opacity:.8;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=.8">Forgot password?</button></div>
      <div class="auth-err" id="loginErr"></div>
      <button class="auth-btn" id="loginBtn" onclick="doLogin()">Log In</button>
    </div>
    <!-- Register form -->
    <div id="authFormRegister" style="display:none;">
      <div class="auth-field"><label>Full Name</label><input type="text" id="regName" placeholder="Juan dela Cruz" autocomplete="name"></div>
      <div class="auth-field"><label>Email</label><input type="email" id="regEmail" placeholder="you@email.com" autocomplete="email"></div>
      <div class="auth-field"><label>Password</label><input type="password" id="regPassword" placeholder="••••••••" autocomplete="new-password"></div>
      <div class="auth-err" id="regErr"></div>
      <button class="auth-btn" id="regBtn" onclick="doRegister()">Create Account</button>
    </div>
    <!-- Forgot password form -->
    <div id="authFormForgot" style="display:none;">
      <div style="text-align:center;margin-bottom:20px;">
        <div style="font-size:36px;margin-bottom:8px;">🔑</div>
        <div style="font-family:var(--fd);font-size:20px;font-weight:700;color:var(--gold-l);margin-bottom:6px;">Reset Password</div>
        <div style="font-size:13px;color:var(--muted);line-height:1.55;">Enter your email address. Your reset request will be sent to the administrator who will provide you with a new temporary password.</div>
      </div>
      <div class="auth-field"><label>Email Address</label><input type="email" id="forgotEmail" placeholder="your@email.com" onkeydown="if(event.key==='Enter')doForgotPassword()"></div>
      <div id="forgotError" style="color:#e07080;font-size:12px;margin-bottom:10px;display:none;"></div>
      <div id="forgotSuccess" style="display:none;background:rgba(20,180,160,.1);border:1px solid rgba(20,180,160,.3);border-radius:10px;padding:14px;margin-bottom:14px;font-size:13px;color:#14b4a0;line-height:1.6;">✅ Reset request submitted. The administrator has been notified and will contact you with a temporary password. Check back later or contact your instructor directly.</div>
      <button class="auth-btn" id="forgotBtn" onclick="doForgotPassword()" style="margin-bottom:10px;">📨 Submit Reset Request</button>
      <button onclick="showForgotPassword(false)" style="width:100%;background:none;border:none;color:var(--muted);font-size:13px;cursor:pointer;padding:8px;font-family:var(--fb);">← Back to Login</button>
    </div>
  </div>
</div>

<div id="apiBanner">⚠️ Claude API is currently overloaded — some features may be slow or unavailable. <button onclick="document.getElementById('apiBanner').style.display='none'">Dismiss</button></div>
<aside class="sidebar" id="mainSidebar">
  <div class="sb-logo-section">
    <div class="s-logo">⚖️</div>
    <div>
      <div class="sb-logo-title">BarBuddy</div>
      <div class="sb-logo-sub">Philippine Bar 2025</div>
    </div>
  </div>

  <button class="sb-overview-btn" id="sb-overview" onclick="navToOverview()">🏛 <span>Overview</span></button>

  <hr class="sb-divider">
  <div class="sb-section-label">SUBJECTS</div>
  <div id="sbSubjectList"></div>

  <hr class="sb-divider">
  <button class="sb-subject" id="sb-subj-custom" style="border-left-color:var(--c-custom);" onclick="navToCustom()">
    <span class="sb-arrow" style="visibility:hidden;">▶</span>
    <span>📁 Custom Subject</span>
    <span class="sb-custom-count" id="sbCustomCount" style="display:none;margin-left:auto;font-size:10px;opacity:.6;font-family:var(--fm);"></span>
    <span class="sb-lock-icon" style="display:none;">🔒</span>
  </button>

  <hr class="sb-divider" style="margin-top:auto;">
  <button class="sb-subject" id="sb-admin" style="display:none;" onclick="navToAdmin()">
    <span style="visibility:hidden;width:8px;">▶</span>
    <span>⚙️ Admin</span>
  </button>

  <div id="accessControlBadge" style="display:none;margin:8px 12px;padding:8px 12px;background:rgba(155,35,53,0.15);border:1px solid rgba(155,35,53,0.3);border-radius:10px;font-size:11px;color:#e07080;cursor:pointer;" onclick="scrollToTabControl()">
    🔒 Some sections disabled — <u>Manage access</u>
  </div>
</aside>

<div class="main">
<header class="topbar">
  <div class="tb-brand" style="margin-right:10px;">
    <div><h1>Bar<em>Buddy</em></h1><div class="tb-sub">Philippine Bar Exam Companion</div></div>
    <div class="ph-flag"><div class="pf-b"></div><div class="pf-r"></div></div>
  </div>
  <div class="tb-breadcrumb" id="breadcrumb"></div>
  <div class="tb-right">
    <span class="exam-pill">PH BAR 2025</span>
    <div class="kb-ind empty" id="kbInd" onclick="navToAdmin()">
      <div class="kb-dot"></div><span id="kbIndTxt">No KB</span>
    </div>
    <span id="userNameDisplay" style="display:none;"></span>
    <button class="btn-og" id="logoutBtn" style="display:none;font-size:11px;padding:5px 10px;" onclick="doLogout()">Log Out</button>
    <div class="avatar">BB</div>
  </div>
</header>

<!-- PRE-GEN PROGRESS BANNER (sticky, shows during generation) -->
<div class="pregen-banner" id="pregenBanner">
  <div class="pb-label">⚙️ Generating content…</div>
  <div class="pb-prog-wrap">
    <div class="pb-track"><div class="pb-fill" id="pbFill" style="width:0%"></div></div>
    <div class="pb-meta"><span id="pbDone">0</span>/<span id="pbTotal">0</span> topics</div>
  </div>
  <div class="pb-cur" id="pbCur"></div>
</div>

<!-- ═══ OVERVIEW ═══ -->
<div class="page on" id="page-dashboard">
<div class="pg-inner">
  <div class="hero fade" style="margin-bottom:20px;">
    <div><div class="hero-txt">
      <h2 id="overviewWelcome">Welcome back.</h2>
      <p>Your Philippine Bar Exam study hub. Select a subject to begin learning, practice quizzes, or run a mock bar session.</p>
    </div>
    <div class="hero-btns">
      <button class="btn-mock" onclick="navToSubject(null,'mockbar')">⏱ Mock Bar (All Subjects)</button>
      <button class="btn-og" onclick="navToAdmin()">⚙️ Manage KB</button>
    </div></div>
    <div class="hero-stats">
      <div class="hst"><div class="hst-n" id="h-ready">0</div><div class="hst-l">Ready Topics</div></div>
      <div class="hst"><div class="hst-n" id="h-done">0</div><div class="hst-l">Qs Done</div></div>
      <div class="hst"><div class="hst-n" id="h-mock">0</div><div class="hst-l">Mock Sessions</div></div>
    </div>
  </div>
  <!-- Subject grid -->
  <div id="overviewSubjectGrid" class="overview-grid"></div>
  <!-- Quick stats + recent -->
  <div class="two-col" style="margin-top:0;">
    <div class="left-col">
      <div class="stat-row fade">
        <div class="stt"><div class="stt-ic ic-g">📚</div><div><div class="stt-n" id="st-topics">0</div><div class="stt-l">Pre-gen Topics</div></div></div>
        <div class="stt"><div class="stt-ic ic-b">✍️</div><div><div class="stt-n" id="st-refs">0</div><div class="stt-l">References</div></div></div>
        <div class="stt"><div class="stt-ic ic-r">⚖️</div><div><div class="stt-n" id="st-score">—</div><div class="stt-l">Avg Score</div></div></div>
        <div class="stt"><div class="stt-ic ic-t">📜</div><div><div class="stt-n" id="st-pb">0</div><div class="stt-l">Past Bar Qs</div></div></div>
      </div>
      <div class="card fade">
        <div class="card-h"><div class="card-title">📖 Recently Studied</div></div>
        <div class="card-b" id="recent-list">
          <div style="text-align:center;padding:24px 0;color:var(--muted);">
            <div style="font-size:28px;margin-bottom:8px;opacity:.4;">📖</div>
            <div style="font-size:12px;">Select a subject from the sidebar to start studying.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="right-col">
      <div class="kb-card" id="kb-dash-card">
        <div style="font-family:var(--fd);font-size:16px;font-weight:700;color:var(--teal);margin-bottom:10px;">📚 Knowledge Base</div>
        <div id="kb-dash-list"><div style="font-size:12px;color:var(--muted);">No materials loaded.</div></div>
        <button class="btn-og" style="width:100%;justify-content:center;margin-top:10px;font-size:11px;" onclick="navToAdmin()">⚙️ Manage KB</button>
      </div>
      <div class="card fade">
        <div class="card-h"><div class="card-title">🏛 Bar Subjects Coverage</div></div>
        <div class="card-b" id="sub-tracker"></div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ═══ SUBJECT PAGE (shared template for all 9 subjects) ═══ -->
<div class="page" id="page-subject">
<div class="pg-inner">
  <div id="subject-page-header-area"></div>
  <div id="subject-tab-bar" class="subject-tab-bar"></div>
  <div id="subject-tab-content"></div>
</div>
</div>

<!-- ═══ LEARN / PRACTICE — now rendered inside page-subject tabs ═══ -->
<!-- These wrappers kept for legacy nav() fallback; content lives in renderLearnTab/renderQuizTab -->
<div class="page" id="page-learn"></div>
<div class="page" id="page-practice"></div>

<!-- ═══ MOCK BAR ═══ -->
<div class="page" id="page-mockbar">
<div class="pg-inner">
  <div id="mockConfig">
    <!-- Warning banner (shown when pool smaller than requested count) -->
    <div class="mb-warn-banner" id="mbWarnBanner"></div>

    <!-- Header — updated by initMockBarSetup() -->
    <div id="mbSetupHeader" style="margin-bottom:18px;">
      <div style="font-size:28px;margin-bottom:8px;">⏱🏛</div>
      <h2 style="font-family:var(--fd);font-size:28px;font-weight:700;color:var(--gold-l);margin-bottom:8px;">Mock <em>Bar Examination</em></h2>
      <p style="font-size:13px;color:var(--muted);line-height:1.65;max-width:640px;">Simulate the Philippine Bar Exam. Questions drawn from your uploaded past bar materials and pre-generated question bank.</p>
    </div>

    <!-- QUESTION COUNT -->
    <div class="mb-setup-card">
      <div class="mb-section-label">Question Count</div>
      <div class="mb-btn-row" id="mbCountRow">
        <button class="mb-preset-btn" data-count="5" onclick="setMbCount(5,this)">5 — Quick</button>
        <button class="mb-preset-btn" data-count="10" onclick="setMbCount(10,this)">10 — Standard</button>
        <button class="mb-preset-btn active" data-count="20" onclick="setMbCount(20,this)">20 — Full</button>
        <button class="mb-preset-btn" data-count="0" onclick="setMbCount(0,this)">Custom</button>
      </div>
      <input type="number" id="mbCustomCount" min="1" max="50" placeholder="Enter count…" oninput="updateMockBarPreview()"
        style="display:none;margin-top:10px;background:rgba(255,255,255,.05);border:1px solid var(--bdr2);border-radius:9px;padding:8px 12px;color:var(--white);font-family:var(--fm);font-size:14px;outline:none;width:140px;">
    </div>

    <!-- TIME LIMIT -->
    <div class="mb-setup-card">
      <div class="mb-section-label">Time Limit</div>
      <div class="mb-btn-row">
        <button class="mb-preset-btn active" data-min="0"   onclick="setMbTime(0,this)">No limit</button>
        <button class="mb-preset-btn" data-min="30"  onclick="setMbTime(30,this)">30 min</button>
        <button class="mb-preset-btn" data-min="60"  onclick="setMbTime(60,this)">1 hr</button>
        <button class="mb-preset-btn" data-min="120" onclick="setMbTime(120,this)">2 hr</button>
        <button class="mb-preset-btn" data-min="180" onclick="setMbTime(180,this)">3 hr</button>
      </div>
    </div>

    <!-- QUESTION SOURCES -->
    <div class="mb-setup-card">
      <div class="mb-section-label">Question Sources</div>
      <div class="mb-source-row">
        <input type="checkbox" class="mb-source-check" id="mbSrcPastBar" checked onchange="updateMockBarPreview()">
        <label class="mb-source-label" for="mbSrcPastBar">📜 Past Bar Questions</label>
        <span class="mb-source-count" id="mbCountPastBar">0 available</span>
      </div>
      <div class="mb-source-row">
        <input type="checkbox" class="mb-source-check" id="mbSrcPreGen" checked onchange="updateMockBarPreview()">
        <label class="mb-source-label" for="mbSrcPreGen">📚 Pre-generated Topics</label>
        <span class="mb-source-count" id="mbCountPreGen">0 available</span>
      </div>
      <div class="mb-source-row">
        <input type="checkbox" class="mb-source-check" id="mbSrcAI" onchange="updateMockBarPreview()">
        <label class="mb-source-label" for="mbSrcAI">🤖 AI Fill <span style="font-size:11px;color:var(--muted);">(if pool insufficient)</span></label>
      </div>
    </div>

    <!-- SUBJECT FILTER -->
    <div class="mb-setup-card" id="mbSubjectFilterCard">
      <div class="mb-section-label">Subject Filter</div>
      <div class="mb-btn-row" id="mbSubjectTags" style="flex-wrap:wrap;gap:6px;">
        <button class="mb-subj-tag on" data-key="all" onclick="toggleMbSubj(this)" style="background:rgba(201,168,76,.15);border-color:var(--gold);color:var(--gold-l);">✓ All</button>
        <button class="mb-subj-tag" data-key="civil"      onclick="toggleMbSubj(this)" style="--sc:var(--c-civil);">Civil</button>
        <button class="mb-subj-tag" data-key="criminal"   onclick="toggleMbSubj(this)" style="--sc:var(--c-criminal);">Criminal</button>
        <button class="mb-subj-tag" data-key="political"  onclick="toggleMbSubj(this)" style="--sc:var(--c-political);">Political</button>
        <button class="mb-subj-tag" data-key="labor"      onclick="toggleMbSubj(this)" style="--sc:var(--c-labor);">Labor</button>
        <button class="mb-subj-tag" data-key="commercial" onclick="toggleMbSubj(this)" style="--sc:var(--c-commercial);">Commercial</button>
        <button class="mb-subj-tag" data-key="taxation"   onclick="toggleMbSubj(this)" style="--sc:var(--c-taxation);">Taxation</button>
        <button class="mb-subj-tag" data-key="remedial"   onclick="toggleMbSubj(this)" style="--sc:var(--c-remedial);">Remedial</button>
        <button class="mb-subj-tag" data-key="ethics"     onclick="toggleMbSubj(this)" style="--sc:var(--c-ethics);">Ethics</button>
      </div>
    </div>

    <!-- TOPIC FILTER (single-subject only) -->
    <div class="mb-setup-card" id="mbTopicFilter" style="display:none;">
      <div class="mb-section-label">Topic Filter <span style="font-size:10px;font-weight:400;color:var(--muted);text-transform:none;letter-spacing:0;">(filters pre-generated questions)</span></div>
      <div style="display:flex;gap:8px;margin-bottom:10px;">
        <button class="tab-global-btn" onclick="setAllMbTopics(true)">Select All</button>
        <button class="tab-global-btn" onclick="setAllMbTopics(false)">Deselect All</button>
      </div>
      <div id="mbTopicCheckboxes" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:4px;"></div>
    </div>

    <!-- DIFFICULTY -->
    <div class="mb-setup-card">
      <div class="mb-section-label">Difficulty Focus</div>
      <div class="mb-btn-row">
        <button class="mb-preset-btn active" data-diff="balanced"    onclick="setMbDiff('balanced',this)">⚖ Balanced</button>
        <button class="mb-preset-btn" data-diff="situational"  onclick="setMbDiff('situational',this)">📋 More Situational</button>
        <button class="mb-preset-btn" data-diff="conceptual"   onclick="setMbDiff('conceptual',this)">💡 More Conceptual</button>
      </div>
    </div>

    <!-- PREVIEW + START -->
    <div class="mb-setup-card" style="border-color:rgba(255,140,66,.2);">
      <div class="mb-section-label">Preview</div>
      <div class="mb-preview" id="mbPreview">Calculating available questions…</div>
      <div style="margin-top:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <button class="btn-mock" onclick="startMockBar()" id="startMockBtn">🚀 Begin Mock Bar</button>
        <div id="mockSourceStats" class="source-stats" style="display:none;"></div>
      </div>
      <div id="mockStartError" style="display:none;margin-top:10px;padding:10px 14px;background:rgba(224,112,128,.12);border:1px solid rgba(224,112,128,.35);border-radius:10px;color:#e07080;font-size:13px;"></div>
    </div>

    <!-- Past bar status card -->
    <div class="card fade" style="margin-top:14px;">
      <div class="card-h"><div class="card-title">📜 Past Bar Materials</div><button class="btn-og" style="font-size:11px;" onclick="navToAdmin()">+ Upload Past Bar</button></div>
      <div class="card-b" id="pb-list"><div style="font-size:13px;color:var(--muted);text-align:center;padding:14px 0;">No past bar materials uploaded.</div></div>
    </div>
  </div>
  <!-- Active session -->
  <div class="mock-session" id="mockSession">
    <div class="ms-header">
      <div><div class="ms-q-num" id="ms-qnum">Q1</div><div class="ms-of" id="ms-of">of 20</div></div>
      <div style="flex:1;max-width:220px;padding:0 18px;">
        <div class="pb-track" style="height:4px;"><div class="pb-fill" id="ms-prog" style="width:0%;background:linear-gradient(90deg,#d4621a,#ff8c42);"></div></div>
      </div>
      <div id="ms-src"></div>
      <div class="ms-timer" id="ms-timer" style="display:none;">⏱ <span id="timer-val"></span></div>
      <button class="btn-og" onclick="endMockSession()" style="font-size:11px;border-color:rgba(255,140,66,.4);color:#ff8c42;">End &amp; Score</button>
    </div>
    <div class="q-markers" id="qMarkers"></div>
    <div id="mockQArea"></div>
  </div>
  <div id="mockResults" style="display:none;"></div>
</div>
</div>

<!-- ═══ CUSTOM SUBJECT ═══ -->
<div class="page" id="page-custom">
<div class="pg-inner">
  <div style="background:linear-gradient(135deg,rgba(136,153,170,.06),rgba(136,153,170,.02));border:1px solid rgba(136,153,170,.2);border-radius:16px;padding:22px;margin-bottom:20px;">
    <div style="font-size:28px;margin-bottom:8px;">📁</div>
    <h2 style="font-family:var(--fd);font-size:24px;font-weight:700;color:var(--gold-l);margin-bottom:6px;">Custom Subject Mock Bar</h2>
    <p style="font-size:13px;color:var(--muted);line-height:1.65;max-width:580px;">Questions drawn exclusively from your uploaded custom subject materials. Use this for school exams, midterms, special topics, or any subject outside the 8 bar subjects.</p>
  </div>
  <!-- Empty state (shown when no custom materials) -->
  <div id="customEmptyState">
    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:50vh;text-align:center;padding:32px;">
      <div style="font-size:56px;margin-bottom:14px;">📁</div>
      <div style="font-family:var(--fd);font-size:22px;font-weight:700;color:var(--gold-l);margin-bottom:8px;">No Custom Materials Yet</div>
      <div style="font-size:14px;color:var(--muted);max-width:320px;line-height:1.7;margin-bottom:24px;">Upload references or past exam questions for your custom subject in the Admin panel to get started.</div>
      <button class="btn-gold" onclick="navToAdmin()" style="font-size:13px;padding:10px 20px;">⚙️ Go to Admin</button>
    </div>
  </div>
  <!-- Mock setup (shown when custom materials exist) -->
  <div id="customMockSetup" style="display:none;"></div>
</div>
</div>

<!-- ═══ ADMIN ═══ -->
<div class="page" id="page-admin">
<div class="pg-inner">
  <div style="margin-bottom:18px;">
    <h2 style="font-family:var(--fd);font-size:28px;font-weight:700;color:var(--gold-l);margin-bottom:5px;">⚙️ Knowledge Base Admin</h2>
    <p style="font-size:13px;color:var(--muted);line-height:1.6;">Upload materials once — stored server-side, cached in your browser for speed. Uploading the syllabus automatically pre-generates all lessons and quizzes in the background.</p>
  </div>
  <div style="display:flex;gap:8px;margin-bottom:18px;align-items:center;">
    <input type="password" id="adminKeyInput" placeholder="Admin key" style="flex:1;background:rgba(255,255,255,.05);border:1px solid var(--bdr2);border-radius:9px;padding:9px 12px;color:var(--white);font-family:var(--fm);font-size:13px;outline:none;max-width:320px;">
    <button class="btn-gold" onclick="unlockAdmin()">Unlock</button>
    <span id="adminStatus" style="font-size:12px;color:var(--muted);"></span>
  </div>
  <div id="adminLocked" class="admin-locked"><div style="font-size:48px;margin-bottom:14px;">🔒</div><div style="font-family:var(--fd);font-size:20px;color:var(--gold-l);margin-bottom:6px;">Admin Access Required</div><div style="font-size:13px;">Enter your admin key above.</div></div>
  <div id="adminUnlocked" style="display:none;">
    <!-- Pre-gen status -->
    <div id="adminGenPanel" style="display:none;" class="gen-prog-panel">
      <div class="gpp-head"><div class="spin" style="width:20px;height:20px;border-width:2px;border-top-color:#ff8c42;border-color:rgba(255,140,66,.2);"></div><div class="gpp-title">Pre-generating all lessons &amp; quizzes…</div></div>
      <div class="gpp-track"><div class="gpp-fill" id="gppFill" style="width:0%"></div></div>
      <div class="gpp-meta"><span id="gppDone">0</span>/<span id="gppTotal">0</span> topics complete</div>
      <div class="gpp-cur" id="gppCur"></div>
    </div>
    <div id="adminGenDone" style="display:none;" class="gen-prog-panel" style="border-color:rgba(20,180,160,.25);background:linear-gradient(135deg,#040e08,#081410);">
      <div class="gpp-head">✅ <div class="gpp-title" style="color:var(--teal);">All content pre-generated!</div></div>
      <div class="gpp-meta" id="adminGenDoneMeta">All topics ready. Lessons and quizzes load instantly.</div>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="btn-gold" onclick="navToSubject(null,'learn')" style="font-size:12px;padding:7px 14px;">📖 Go to Learn</button>
        <button class="btn-og" style="font-size:11px;" onclick="retriggerGen()">↺ Regenerate All</button>
      </div>
    </div>
    <!-- SUBJECT OVERVIEW GRID -->
    <div id="subjectOverviewGrid" style="display:none;margin-bottom:18px;">
      <h3 style="font-family:var(--fd);font-size:18px;font-weight:700;color:var(--gold-l);margin-bottom:5px;">📊 Subject Overview</h3>
      <p style="font-size:12px;color:var(--muted);margin-bottom:14px;">Quick view of uploaded materials per subject.</p>
      <div class="subj-ov-grid" id="subjOvGridContent"></div>
    </div>

    <!-- TAB ACCESS CONTROL -->
    <div id="tabAccessControlPanel" style="background:var(--card);border:1px solid var(--bdr2);border-radius:16px;padding:20px;margin-bottom:18px;">
      <h3 style="font-family:var(--fd);font-size:18px;font-weight:700;color:var(--gold-l);margin-bottom:5px;">🔒 Tab Access Control</h3>
      <p style="font-size:12px;color:var(--muted);margin-bottom:12px;line-height:1.55;">Enable or disable sections for students. Changes take effect immediately for all logged-in users on their next navigation.</p>
      <!-- Global controls -->
      <div style="margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid var(--bdr2);">
        <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px;">Global Controls</div>
        <div style="display:flex;flex-wrap:wrap;gap:4px;">
          <button class="tab-global-btn" onclick="setAllTabs(true)">✓ Enable All</button>
          <button class="tab-global-btn" onclick="setAllTabs(false)">✗ Disable All</button>
          <button class="tab-global-btn" onclick="setAllOfMode('learn',true)">📖 All Learn ▲</button>
          <button class="tab-global-btn" onclick="setAllOfMode('learn',false)">📖 All Learn ▼</button>
          <button class="tab-global-btn" onclick="setAllOfMode('quiz',true)">✏️ All Quiz ▲</button>
          <button class="tab-global-btn" onclick="setAllOfMode('quiz',false)">✏️ All Quiz ▼</button>
          <button class="tab-global-btn" onclick="setAllOfMode('mockbar',true)">⏱ All Mock ▲</button>
          <button class="tab-global-btn" onclick="setAllOfMode('mockbar',false)">⏱ All Mock ▼</button>
        </div>
      </div>
      <!-- Per-subject controls rendered by JS -->
      <div id="tabToggleList"></div>
      <div style="display:flex;gap:8px;margin-top:14px;">
        <button class="btn-gold" id="saveTabBtn" onclick="saveTabSettings()" style="font-size:12px;padding:8px 16px;">💾 Save All Changes</button>
        <button class="btn-og" onclick="resetTabSettings()" style="font-size:12px;">↺ Reset to Default</button>
      </div>
    </div>
    <div class="admin-grid">
      <!-- SYLLABUS -->
      <div class="admin-panel">
        <h3>📋 Bar Exam Syllabus</h3>
        <p>Upload once. Claude parses all subjects and topics, populates the Learn sidebar, and <strong>immediately kicks off pre-generation</strong> of all lessons and quizzes in the background.</p>
        <div id="syllabusStatus" style="padding:10px;background:rgba(255,255,255,.04);border-radius:8px;margin-bottom:12px;font-size:12px;color:var(--muted);">No syllabus uploaded yet.</div>
        <label class="form-label">Name</label>
        <input class="form-input" id="syl-name" placeholder="e.g. 2025 Bar Exam Syllabus">
        <label class="form-label">Content (paste or upload file)</label>
        <textarea class="form-input" id="syl-content" rows="5" placeholder="Paste syllabus text here…" style="resize:vertical;"></textarea>
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <input type="file" id="syl-file" accept=".txt,.md,.pdf,.doc,.docx" style="display:none;" onchange="readFile(this,'syl-content')">
          <button class="btn-og" onclick="document.getElementById('syl-file').click()">📄 Upload File</button>
        </div>
        <div id="syl-status"></div>
        <div id="syl-breakdown" style="display:none;margin-bottom:12px;"></div>
        <button class="btn-gold" onclick="uploadSyllabus()" style="width:100%;justify-content:center;">📋 Save &amp; Pre-generate</button>
      </div>
      <!-- REFERENCES -->
      <div class="admin-panel">
        <h3>📂 Reference Materials</h3>
        <p>Upload reviewers, codals, digests, lecture notes. Stored server-side, used as context when generating lessons and quiz questions. Adding a reference re-generates the affected subject.</p>
        <label class="form-label">Name</label>
        <input class="form-input" id="ref-name" placeholder="e.g. Civil Code Reviewer">
        <label class="form-label">Subject</label>
        <select class="form-select" id="ref-subject" onchange="showRefGeneralWarning(this.value)">
          <option value="civil">Civil Law</option><option value="criminal">Criminal Law</option>
          <option value="political">Political Law</option><option value="labor">Labor Law</option>
          <option value="commercial">Commercial Law</option><option value="taxation">Taxation</option>
          <option value="remedial">Remedial Law</option><option value="ethics">Legal Ethics</option>
          <option disabled>──────────────</option>
          <option value="general">🌐 General (all subjects — use sparingly)</option>
          <option value="custom">📁 Custom Subject (non-bar topics)</option>
        </select>
        <div id="refGeneralWarning" class="general-ref-warning">⚠️ General materials appear in ALL subject contexts. Tag to a specific subject for better isolation.</div>
        <label class="form-label">Type</label>
        <select class="form-select" id="ref-type">
          <option value="reviewer">Reviewer book</option><option value="codal">Codal / statutes</option>
          <option value="digest">Case digest</option><option value="notes">Lecture notes</option><option value="other">Other</option>
        </select>
        <label class="form-label">Content</label>
        <textarea class="form-input" id="ref-content" rows="4" placeholder="Paste or upload…" style="resize:vertical;"></textarea>
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <input type="file" id="ref-file" accept=".txt,.md,.pdf,.doc,.docx" style="display:none;" onchange="readFile(this,'ref-content')">
          <button class="btn-og" onclick="document.getElementById('ref-file').click()">📄 Upload File</button>
        </div>
        <div id="ref-status"></div>
        <button class="btn-gold" onclick="uploadReference()" style="width:100%;justify-content:center;">📂 Save Reference</button>
      </div>
      <!-- PAST BAR -->
      <div class="admin-panel">
        <h3>📜 Past Bar Questions</h3>
        <p>Upload past bar exams with suggested answers. Claude extracts structured Q&A. Questions appear in Mock Bar sessions as authentic past bar items with source attribution.</p>
        <label class="form-label">Name</label>
        <input class="form-input" id="pb-name" placeholder="e.g. 2023 Bar — Civil Law">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <div>
            <label class="form-label">Subject</label>
            <select class="form-select" id="pb-subject" onchange="showPbGeneralWarning(this.value)">
              <option value="civil">Civil Law</option><option value="criminal">Criminal Law</option>
              <option value="political">Political Law</option><option value="labor">Labor Law</option>
              <option value="commercial">Commercial Law</option><option value="taxation">Taxation</option>
              <option value="remedial">Remedial Law</option><option value="ethics">Legal Ethics</option>
              <option disabled>──────────────</option>
              <option value="general">🌐 General (all subjects — use sparingly)</option>
              <option value="custom">📁 Custom Subject (non-bar topics)</option>
            </select>
            <div id="pbGeneralWarning" class="general-ref-warning">⚠️ General materials appear in ALL subject contexts. Tag to a specific subject for better isolation.</div>
          </div>
          <div><label class="form-label">Year</label><input class="form-input" id="pb-year" placeholder="e.g. 2023"></div>
        </div>
        <label class="form-label">Content</label>
        <textarea class="form-input" id="pb-content" rows="4" placeholder="Paste bar exam Q&A or upload file…" style="resize:vertical;"></textarea>
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <input type="file" id="pb-file" accept=".txt,.md,.pdf,.doc,.docx" style="display:none;" onchange="readFile(this,'pb-content')">
          <button class="btn-og" onclick="document.getElementById('pb-file').click()">📄 Upload File</button>
        </div>
        <div id="pb-status"></div>
        <button class="btn-gold" onclick="uploadPastBar()" style="width:100%;justify-content:center;">📜 Save Past Bar</button>

        <div class="manual-divider">Or Add Questions Manually</div>
        <div class="mn-note">💡 Manual entry saves instantly with no AI processing — use this to add questions one by one with full control over the fact pattern, suggested answer, and key points.</div>

        <label class="form-label">Question Number</label>
        <input class="form-input" id="mn-num" type="number" value="1" min="1">
        <label class="form-label">Question Type</label>
        <div class="mn-radio-group">
          <label><input type="radio" name="mn-type" value="situational" checked onchange="toggleManualContext()"> Situational (has fact pattern)</label>
          <label><input type="radio" name="mn-type" value="conceptual" onchange="toggleManualContext()"> Conceptual (define/distinguish)</label>
        </div>
        <div id="mn-context-wrap">
          <label class="form-label">Fact Pattern / Context</label>
          <textarea class="form-input" id="mn-context" rows="4" placeholder="Full facts of the case — all parties, events, and circumstances…" style="resize:vertical;"></textarea>
        </div>
        <label class="form-label">Question</label>
        <textarea class="form-input" id="mn-q" rows="3" placeholder="The actual question asked (e.g. Is X liable? What are the rights of Y?)" style="resize:vertical;"></textarea>
        <label class="form-label">Suggested Answer</label>
        <textarea class="form-input" id="mn-answer" rows="5" placeholder="Model answer (ideally in ALAC format)…" style="resize:vertical;"></textarea>
        <label class="form-label">Key Legal Points (one per line)</label>
        <textarea class="form-input" id="mn-points" rows="3" placeholder="Article 94, Labor Code&#10;G.R. No. 12345&#10;Doctrine of…" style="resize:vertical;"></textarea>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <div>
            <label class="form-label">Subject</label>
            <select class="form-select" id="mn-subject" onchange="onMnSubjectChange(this.value)">
              <option value="general">All subjects</option>
              <option value="civil">Civil Law</option><option value="criminal">Criminal Law</option>
              <option value="political">Political Law</option><option value="labor">Labor Law</option>
              <option value="commercial">Commercial Law</option><option value="taxation">Taxation</option>
              <option value="remedial">Remedial Law</option><option value="ethics">Legal Ethics</option>
              <option disabled>──────────────────</option>
              <option value="custom">📁 Custom Subject</option>
            </select>
          </div>
          <div><label class="form-label">Year</label><input class="form-input" id="mn-year" placeholder="e.g. 2023"></div>
        </div>
        <label class="form-label">Batch Name</label>
        <input class="form-input" id="mn-name" placeholder="e.g. 2023 Bar — Civil Law (Manual)">
        <div id="mn-preview" class="mn-preview"></div>
        <div id="mn-status"></div>
        <div style="display:flex;gap:8px;margin-top:4px;">
          <button class="btn-og" onclick="addManualQ()" style="flex:1;justify-content:center;">+ Add to Batch</button>
          <button class="btn-gold" onclick="saveManualBatch()" style="flex:1;justify-content:center;">💾 Save All</button>
        </div>
      </div>
      <!-- CURRENT KB -->
      <div class="admin-panel">
        <h3>📚 Current Knowledge Base</h3>
        <p>All uploaded materials stored on the server. Content is cached in your browser for instant access across sessions.</p>
        <div id="adminKbList"><div style="font-size:12px;color:var(--muted);">Loading…</div></div>
        <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn-og" onclick="retriggerGen()" style="font-size:11px;">↺ Re-generate All</button>
          <button class="btn-og" onclick="clearContent()" style="font-size:11px;border-color:rgba(155,35,53,.4);color:#e07080;">🗑 Clear Content Cache</button>
          <button class="btn-og" onclick="downloadAllQuestions()" style="font-size:11px;border-color:rgba(201,168,76,.4);color:var(--gold);">⬇ Download All Questions (TXT)</button>
        </div>
        <div id="storageIndicator" style="margin-top:14px;padding:10px 13px;border-radius:10px;background:rgba(255,255,255,.04);border:1px solid var(--bdr2);font-size:12px;color:var(--muted);">
          Checking storage…
        </div>
      </div>
    </div>

    <!-- USER MANAGEMENT PANEL -->
    <div id="adminUserPanel" style="background:var(--card);border:1px solid var(--bdr2);border-radius:16px;padding:20px;margin-top:18px;display:none;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <h3 style="font-family:var(--fd);font-size:18px;font-weight:700;color:var(--gold-l);margin:0;">👥 Registered Users</h3>
        <div style="display:flex;gap:8px;">
          <button class="btn-og" onclick="toggleRegistration()" id="regToggleBtn" style="font-size:11px;">Toggle Registration</button>
          <button class="btn-og" onclick="loadAdminUsers()" style="font-size:11px;">↺ Refresh</button>
        </div>
      </div>
      <div id="adminUserList"><div style="font-size:12px;color:var(--muted);">Loading…</div></div>
    </div>

    <!-- RESULTS DASHBOARD PANEL -->
    <div id="adminResultsPanel" style="background:var(--card);border:1px solid var(--bdr2);border-radius:16px;padding:20px;margin-top:18px;display:none;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <h3 style="font-family:var(--fd);font-size:18px;font-weight:700;color:var(--gold-l);margin:0;">📊 Mock Bar Results</h3>
        <div style="display:flex;gap:8px;">
          <button class="btn-og" onclick="exportResultsCSV()" style="font-size:11px;">⬇ Export CSV</button>
          <button class="btn-og" onclick="loadAdminResults()" style="font-size:11px;">↺ Refresh</button>
        </div>
      </div>
      <div id="adminResultsList"><div style="font-size:12px;color:var(--muted);">Loading…</div></div>
    </div>

  </div>
</div>
</div>

</div><!-- .main -->

<!-- RESULTS DETAIL MODAL -->
<div class="overlay" id="resultDetailOverlay">
<div class="modal" style="max-width:680px;">
  <button class="modal-x" onclick="closeModal('resultDetailOverlay')">✕</button>
  <div class="modal-t" id="resultDetailTitle">📊 Result Detail</div>
  <div class="res-detail-grid" id="resultDetailStats"></div>
  <div id="resultDetailBody" style="font-size:13px;color:var(--muted);max-height:400px;overflow-y:auto;"></div>
</div>
</div>

<!-- EMAIL RESULTS MODAL -->
<div class="overlay" id="emailOverlay">
<div class="modal" style="max-width:460px;">
  <button class="modal-x" onclick="closeModal('emailOverlay')">✕</button>
  <div class="modal-t">📧 Email Results</div>
  <p class="modal-s">Send your mock bar results to an email address.</p>
  <label class="form-label" style="margin-top:4px;">Email Address</label>
  <input class="form-input" id="email-to" type="email" placeholder="you@example.com" style="margin-bottom:10px;">
  <label class="form-label">Subject Line</label>
  <input class="form-input" id="email-subject" type="text" style="margin-bottom:10px;">
  <div id="email-status" style="display:none;font-size:13px;padding:8px 12px;border-radius:8px;margin-bottom:10px;"></div>
  <div style="display:flex;gap:8px;margin-top:4px;">
    <button class="btn-gold" id="emailSendBtn" onclick="sendEmailResults()" style="flex:1;justify-content:center;">📧 Send Results</button>
    <button class="btn-ghost" onclick="closeModal('emailOverlay')">Cancel</button>
  </div>
</div>
</div>

<script>
// ══════════════════════════════════
// STATE
// ══════════════════════════════════
let KB = { hasSyllabus:false, syllabusTopics:[], references:[], pastBar:[], contentTopics:0, genState:{} };
let CACHE = {};          // browser-side content cache: { [subj]: { [topic]: {lesson,mcq,essay} } }
const VISITED = [];      // [{subjKey, topicName, title, type}] — recent activity
let totalQDone=0, totalCorrect=0, mockSessions=0;
let curSubj=null, curTopic=null, curPage=0;
let quizPool=[];         // flat list of {type,subject,topic,data} loaded from CACHE for practice panel
let activeQuiz=null, qIdx=0, qScore=0, qMode='mcq';
let mockQs=[], mockIdx=0, mockAnswers=[], mockTimer=null, mockLeft=0;
let mockScores=[], mockSubjectsUsed=[], mockSessionDate=null;
let manualBatch=[], manualQNum=1;
let adminKey='', sseSource=null;
let currentSubject = null;  // active subject key ('civil'|'labor'|...|'custom'|null)
let currentMode    = null;  // active mode ('learn'|'quiz'|'mockbar'|null)
let mbCount = 20, mbTimeMins = 0, mbDifficulty = 'balanced';  // mock bar setup state

const SUBJS=[
  {key:'civil',    name:'Civil Law',               cls:'sg-civ',f:'bf-g', color:'#4a9eff'},
  {key:'criminal', name:'Criminal Law',             cls:'sg-cri',f:'bf-r', color:'#e07080'},
  {key:'political',name:'Political Law',            cls:'sg-pol',f:'bf-b', color:'#50d090'},
  {key:'labor',    name:'Labor & Social Leg.',      cls:'sg-lab',f:'bf-t', color:'#f0a040'},
  {key:'commercial',name:'Commercial Law',          cls:'sg-com',f:'bf-g', color:'#a070e0'},
  {key:'taxation', name:'Taxation',                 cls:'sg-tax',f:'bf-r', color:'#40c0b0'},
  {key:'remedial', name:'Remedial Law',             cls:'sg-rem',f:'bf-t', color:'#e0c050'},
  {key:'ethics',   name:'Legal Ethics',             cls:'sg-eth',f:'bf-b', color:'#c0a080'},
];
const CUSTOM_SUBJ = {key:'custom', name:'Custom Subject', color:'#8899aa'};
const ALL_SUBJS = [...SUBJS, CUSTOM_SUBJ];

// ══════════════════════════════════
// INIT
// ══════════════════════════════════
async function init() {
  loadLocalCache();
  renderSidebar();       // build subject list in sidebar
  renderSubjectTracker();
  await loadKB();
  await applyTabSettings();
  navToOverview();       // start on overview
  subscribeToProgress();
  checkAPIStatus();
}

async function checkAPIStatus(){
  try{
    const r=await fetch('/api/status');
    const d=await r.json();
    document.getElementById('apiBanner').style.display=d.apiOk?'none':'block';
  }catch(e){}
}
window.addEventListener('DOMContentLoaded', async () => {
  const hasSession = await checkExistingSession();
  if (!hasSession) {
    // Auth wall stays visible; app boots once user logs in
    document.getElementById('authWall').style.display = 'flex';
  }
  init();
});

// ══════════════════════════════════
// LOCAL BROWSER CACHE
// ══════════════════════════════════
const LS_KEY = 'barbuddy_cache_v3';
const LS_VISITED = 'barbuddy_visited';

function loadLocalCache() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (raw) { CACHE = JSON.parse(raw); console.log('Cache loaded:', Object.values(CACHE).reduce((a,s)=>a+Object.keys(s).length,0), 'topics'); }
    const vis = localStorage.getItem(LS_VISITED);
    if (vis) VISITED.splice(0,0,...JSON.parse(vis));
  } catch(e) { console.warn('Cache load:', e.message); }
}

function saveLocalCache() {
  try { localStorage.setItem(LS_KEY, JSON.stringify(CACHE)); } catch(e) { console.warn('Cache save:', e.message); }
}

function saveCacheItem(subj, topic, data) {
  if (!CACHE[subj]) CACHE[subj] = {};
  CACHE[subj][topic] = data;
  saveLocalCache();
}

function getCached(subj, topic) {
  return CACHE[subj]?.[topic] || null;
}

async function syncCacheFromServer(subject) {
  try {
    const url = subject ? `/api/content?subject=${encodeURIComponent(subject)}` : '/api/content';
    const r = await fetch(url);
    const serverContent = await r.json();
    let merged = 0;
    Object.entries(serverContent).forEach(([subj, topics]) => {
      Object.entries(topics).forEach(([topic, data]) => {
        if (!getCached(subj, topic)) { saveCacheItem(subj, topic, data); merged++; }
      });
    });
    if (merged > 0) { console.log('Synced', merged, 'topics from server'); buildQuizPool(subject||null); if (!subject) renderSyllabusTree(); }
  } catch(e) { console.warn('Sync:', e.message); }
}

// ══════════════════════════════════
// SERVER STATE
// ══════════════════════════════════
async function loadKB() {
  try {
    const r = await fetch('/api/kb');
    KB = await r.json();
    updateKBIndicator();
    renderSyllabusTree();
    buildQuizPool();
    updateDash();
    renderPastBarList();
    refreshSidebarDots();
    // Sync any server content not in local cache
    if (KB.contentTopics > 0) syncCacheFromServer();
  } catch(e) { console.warn('KB load:', e.message); }
}

function updateKBIndicator() {
  const ind = document.getElementById('kbInd'), txt = document.getElementById('kbIndTxt');
  const gs = KB.genState;
  const n = Object.values(CACHE).reduce((a,s)=>a+Object.keys(s).length, 0);
  if (gs?.running) { ind.className='kb-ind generating'; txt.textContent=`Generating ${gs.done||0}/${gs.total||0}`; }
  else if (n > 0) { ind.className='kb-ind loaded'; txt.textContent=`${n} topics ready`; }
  else if (KB.hasSyllabus) { ind.className='kb-ind generating'; txt.textContent='Generating…'; }
  else { ind.className='kb-ind empty'; txt.textContent='No KB'; }

  // Update stat cards
  document.getElementById('st-topics').textContent = n;
  document.getElementById('st-refs').textContent   = KB.references?.length || 0;
  document.getElementById('st-pb').textContent     = KB.pastBar?.reduce((a,p)=>a+(p.qCount||0),0) || 0;
  document.getElementById('h-ready').textContent   = n;

  // KB dash card
  const all = [
    ...(KB.hasSyllabus ? [{name:KB.syllabusName||'Syllabus',type:'syllabus',subject:'all'}] : []),
    ...(KB.references||[]),
    ...(KB.pastBar||[]),
  ];
  document.getElementById('kb-dash-list').innerHTML = all.length
    ? all.slice(0,6).map(i=>`<div class="kb-item"><span>${i.type==='syllabus'?'📋':i.qCount!==undefined?'📜':'📂'}</span><div><div style="font-size:12px;font-weight:600;">${h(i.name)}</div><div style="font-size:10px;color:var(--muted);">${i.subject||''} ${i.year?'·'+i.year:''} ${i.qCount!==undefined?'·'+i.qCount+' Qs':''}</div></div></div>`).join('')
    : '<div style="font-size:12px;color:var(--muted);">No materials loaded.</div>';

  // Mock source stats
  const pbTotal = KB.pastBar?.reduce((a,p)=>a+(p.qCount||0),0)||0;
  const pgTotal = Object.values(CACHE).reduce((a,s)=>a+Object.keys(s).length,0);
  document.getElementById('mockSourceStats').innerHTML = `
    <span class="src-badge sb-real">📜 ${pbTotal} Past Bar Qs</span>
    <span class="src-badge sb-pregen">📚 ${pgTotal} Pre-gen Topics</span>`;
}

// ══════════════════════════════════
// SSE — LIVE GENERATION PROGRESS
// ══════════════════════════════════
function subscribeToProgress() {
  if (sseSource) sseSource.close();
  sseSource = new EventSource('/api/gen/progress');
  sseSource.onmessage = e => {
    const d = JSON.parse(e.data);
    updateProgressUI(d);
    if (d.finished || (!d.running && d.done > 0)) {
      // Generation done — sync cache
      setTimeout(() => syncCacheFromServer(), 1000);
      KB.genState = d;
      updateKBIndicator();
    }
  };
  sseSource.onerror = () => { sseSource.close(); setTimeout(subscribeToProgress, 5000); };
}

function updateProgressUI(d) {
  const banner = document.getElementById('pregenBanner');
  const adminPanel = document.getElementById('adminGenPanel');
  const adminDone  = document.getElementById('adminGenDone');

  if (d.running) {
    const pct = d.total ? Math.round(d.done/d.total*100) : 0;
    banner.classList.add('on');
    document.getElementById('pbFill').style.width = pct + '%';
    document.getElementById('pbDone').textContent = d.done;
    document.getElementById('pbTotal').textContent = d.total;
    document.getElementById('pbCur').textContent = d.current || '';
    if (adminPanel) { adminPanel.style.display='block'; adminDone.style.display='none'; }
    document.getElementById('gppFill').style.width = pct + '%';
    document.getElementById('gppDone').textContent = d.done;
    document.getElementById('gppTotal').textContent = d.total;
    document.getElementById('gppCur').textContent = d.current || '';
  } else {
    banner.classList.remove('on');
    if (d.finished) {
      if (adminPanel) { adminPanel.style.display='none'; adminDone.style.display='block'; }
      document.getElementById('adminGenDoneMeta').textContent = `${d.done} topics generated. ${d.errors || 0} errors.`;
    }
  }
}

// ══════════════════════════════════
// NAVIGATION
// ══════════════════════════════════

function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('on'));
  document.getElementById('page-' + id)?.classList.add('on');
}

function clearSidebarActive() {
  document.querySelectorAll('.sb-overview-btn,.sb-subject,.sb-sub-item').forEach(el => el.classList.remove('active'));
}

function updateBreadcrumb(subj, mode) {
  const bc = document.getElementById('breadcrumb');
  if (!bc) return;
  if (!subj) { bc.innerHTML = ''; return; }
  const subjInfo = ALL_SUBJS.find(s => s.key === subj);
  const subjName = subjInfo?.name || subj;
  const modeLabel = mode === 'learn' ? '📖 Learn' : mode === 'quiz' ? '✏️ Quiz' : mode === 'mockbar' ? '⏱ Mock Bar' : '';
  bc.innerHTML = `<span class="tb-bc-subj">${h(subjName)}</span>
    ${modeLabel ? `<span class="tb-bc-sep">›</span><span class="tb-bc-mode">${modeLabel}</span>` : ''}`;
}

function navToOverview() {
  currentSubject = null; currentMode = null;
  clearSidebarActive();
  document.getElementById('sb-overview')?.classList.add('active');
  showPage('dashboard');
  updateBreadcrumb(null, null);
  renderOverviewGrid();
}

function navToAdmin() {
  currentSubject = null; currentMode = null;
  clearSidebarActive();
  document.getElementById('sb-admin')?.classList.add('active');
  showPage('admin');
  updateBreadcrumb(null, null);
}

function navToCustom() {
  currentSubject = 'custom'; currentMode = 'mockbar';
  clearSidebarActive();
  document.getElementById('sb-subj-custom')?.classList.add('active');
  showPage('custom');
  updateBreadcrumb('custom', 'mockbar');
  // Show empty state or mock setup depending on custom material availability
  const hasCustom = (KB.customRefs > 0) || (KB.customPastBar > 0);
  document.getElementById('customEmptyState').style.display = hasCustom ? 'none' : 'block';
  const setup = document.getElementById('customMockSetup');
  setup.style.display = hasCustom ? 'block' : 'none';
  if (hasCustom) initMockBarSetup('custom');
}

function navToSubject(subj, mode) {
  if (!subj) { // "All subjects" mock bar from overview
    currentSubject = null; currentMode = 'mockbar';
    clearSidebarActive();
    showPage('mockbar');
    updateBreadcrumb(null, null);
    initMockBarSetup(null);
    return;
  }
  if (subj === 'custom') { navToCustom(); return; }

  // Determine which mode to default to (pick first enabled)
  const ts = window.TAB_SETTINGS;
  const modesInOrder = ['learn','quiz','mockbar'];
  let targetMode = mode || 'learn';
  if (ts?.subjects?.[subj]?.[targetMode] === false) {
    targetMode = modesInOrder.find(m => ts.subjects?.[subj]?.[m] !== false) || 'learn';
  }

  currentSubject = subj; currentMode = targetMode;
  clearSidebarActive();
  document.getElementById('sb-subj-' + subj)?.classList.add('active');
  updateBreadcrumb(subj, targetMode);
  showPage('subject');
  renderSubjectHeader(subj);
  renderSubjectTabs(subj, targetMode);
  switchSubjectTab(subj, targetMode);
}

function renderSubjectHeader(subj) {
  const s = SUBJS.find(x => x.key === subj);
  if (!s) return;
  const refs   = (KB.references||[]).filter(r=>r.subject===subj).length;
  const pbSets = (KB.pastBar||[]).filter(p=>p.subject===subj).length;
  const pbQs   = (KB.pastBar||[]).filter(p=>p.subject===subj).reduce((a,p)=>a+(p.qCount||0),0);
  const cached = Object.keys(CACHE[subj]||{}).length;
  const topicCount = (KB.syllabusTopics||[]).find(st=>st.key===subj)?.topics?.length || 0;
  const metaParts = [];
  if (refs) metaParts.push(`${refs} reference${refs!==1?'s':''}`);
  if (pbSets) metaParts.push(`${pbSets} past bar set${pbSets!==1?'s':''}`);
  if (pbQs) metaParts.push(`${pbQs} questions`);
  if (topicCount) metaParts.push(`${topicCount} topics`);
  if (cached) metaParts.push(`${cached} cached`);
  document.getElementById('subject-page-header-area').innerHTML = `
    <div class="subject-page-header">
      <div class="subject-color-bar" style="background:${s.color};"></div>
      <div>
        <h2 class="subject-page-title">${h(s.name)}</h2>
        <div class="subject-page-meta">${metaParts.length ? metaParts.join(' · ') : 'No materials uploaded yet'}</div>
      </div>
    </div>`;
}

function renderSubjectTabs(subj, activeMode) {
  const ts = window.TAB_SETTINGS?.subjects?.[subj] || {};
  const tabs = [
    { mode:'learn',   icon:'📖', label:'Learn'   },
    { mode:'quiz',    icon:'✏️',  label:'Quiz'    },
    { mode:'mockbar', icon:'⏱',  label:'Mock Bar' },
  ];
  const bar = document.getElementById('subject-tab-bar');
  if (!bar) return;
  bar.innerHTML = tabs.map(t => {
    const enabled = ts[t.mode] !== false;
    const isActive = t.mode === activeMode;
    return `<button id="stab-${t.mode}"
      class="subject-tab${isActive?' active':''}${!enabled?' tab-disabled':''}"
      onclick="switchSubjectTab('${subj}','${t.mode}')"
      ${!enabled?'disabled':''}>
      ${t.icon} ${t.label}${!enabled?' 🔒':''}
    </button>`;
  }).join('');
}

function switchSubjectTab(subj, mode) {
  // If disabled, auto-pick first enabled
  const ts = window.TAB_SETTINGS?.subjects?.[subj] || {};
  if (ts[mode] === false) {
    const first = ['learn','quiz','mockbar'].find(m => ts[m] !== false);
    if (first) { switchSubjectTab(subj, first); return; }
  }
  currentMode = mode;
  document.querySelectorAll('.subject-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('stab-' + mode)?.classList.add('active');
  updateBreadcrumb(subj, mode);
  const content = document.getElementById('subject-tab-content');
  if (!content) return;
  if (mode === 'learn')    renderLearnTab(subj, content);
  if (mode === 'quiz')     renderQuizTab(subj, content);
  if (mode === 'mockbar')  renderMockBarTab(subj, content);
}

function renderLearnTab(subj, container) {
  container.innerHTML = `
    <div class="split-layout">
      <aside class="panel-l">
        <div class="pl-head">
          <h3>📖 Topics</h3>
          <input class="sp-search" type="text" placeholder="Search topics…" oninput="filterTopics(this.value)" id="topicSearch">
        </div>
        <div class="tree" id="syllabusTree"></div>
        <div class="up-btn" onclick="navToAdmin()">⚙️ Manage KB</div>
      </aside>
      <div class="panel-r">
        <div class="pr-top" id="lpTopbar" style="display:none;">
          <div class="pr-bc" id="lpBC"></div>
          <div style="display:flex;gap:7px;">
            <button class="btn-og" style="font-size:11px;" onclick="markDone()">✓ Mark Done</button>
            <button class="btn-og" style="font-size:11px;" onclick="switchSubjectTab(currentSubject,'quiz')">Take Quiz →</button>
          </div>
        </div>
        <div class="pr-content" id="lpContent">
          <div class="welcome-st"><div class="big-ic">📖</div><h3>${h(SUBJS.find(s=>s.key===subj)?.name||subj)}</h3><p>Click a topic on the left to view its lesson content.</p></div>
        </div>
        <div id="lpFooter" style="display:none;" class="pr-foot">
          <div style="font-size:12px;color:var(--muted);font-family:var(--fm);" id="lpPgInfo">Page 1 of 1</div>
          <div style="display:flex;gap:8px;">
            <button class="btn-ghost" id="lpPrev" onclick="chgPage(-1)">← Prev</button>
            <button class="btn-gold" id="lpNext" onclick="chgPage(1)">Next →</button>
          </div>
        </div>
      </div>
    </div>`;
  renderSyllabusTree('', subj);
}

function renderQuizTab(subj, container) {
  curSubj = subj;
  container.innerHTML = `
    <div class="split-layout">
      <aside class="panel-l">
        <div class="pl-head">
          <h3>✍️ Practice</h3>
          <div class="q-type-tabs">
            <div class="qtt on" id="qmode-mcq" onclick="setQMode('mcq')"><span class="qtt-ic">🔘</span>MCQ</div>
            <div class="qtt" id="qmode-essay" onclick="setQMode('essay')"><span class="qtt-ic">✍️</span>Essay</div>
          </div>
        </div>
        <div class="qn-list" id="quizList"></div>
      </aside>
      <div style="display:flex;flex-direction:column;overflow:hidden;">
        <div id="qmHead" style="display:none;padding:13px 24px;align-items:center;gap:10px;background:var(--ink2);border-bottom:1px solid var(--bdr2);">
          <div style="font-family:var(--fd);font-size:19px;font-weight:700;color:var(--gold-l);flex:1;" id="qmTitle">Quiz</div>
          <div style="font-size:11px;color:var(--muted);font-family:var(--fm);" id="qmMeta"></div>
          <button class="btn-og" style="font-size:11px;" onclick="resetQuiz()">↺ Restart</button>
        </div>
        <div class="qm-body" id="qmBody">
          <div class="welcome-st"><div class="big-ic">✍️</div><h3>${h(SUBJS.find(s=>s.key===subj)?.name||subj)}</h3><p>Select a topic from the left panel to practice.</p></div>
        </div>
      </div>
    </div>`;
  buildQuizPool(subj);
}

function renderMockBarTab(subj, container) {
  const s = SUBJS.find(x => x.key === subj);
  const presets = [[5,'5'],[10,'10'],[20,'20']];
  const timeOpts = [[0,'No limit'],[30,'30 min'],[60,'1 hr'],[120,'2 hr'],[180,'3 hr']];
  const diffOpts = [['balanced','⚖️ Balanced'],['situational','📋 Situational'],['conceptual','💡 Conceptual']];
  container.innerHTML = `
    <div style="max-width:580px;">
      <div class="mb-setup-card">
        <div class="mb-section-label">Number of Questions</div>
        <div class="mb-btn-row" id="stMbCountRow">
          ${presets.map(([n,l])=>`<button class="mb-preset-btn${mbCount===n?' active':''}" onclick="stSetMbCount(${n},this)">${l}</button>`).join('')}
          <input type="number" id="stMbCustomCount" min="1" max="100" placeholder="Custom"
            value="${![5,10,20].includes(mbCount)?mbCount:''}"
            style="width:64px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:7px 10px;color:var(--white);font-size:13px;font-family:var(--fb);"
            oninput="stSetMbCount(parseInt(this.value)||20)">
        </div>
      </div>
      <div class="mb-setup-card">
        <div class="mb-section-label">Time Limit</div>
        <div class="mb-btn-row" id="stMbTimeRow">
          ${timeOpts.map(([m,l])=>`<button class="mb-preset-btn${mbTimeMins===m?' active':''}" onclick="stSetMbTime(${m},this)">${l}</button>`).join('')}
        </div>
      </div>
      ${renderSourcesSection(subj)}
      <div class="mb-setup-card">
        <div class="mb-section-label">Difficulty Preference</div>
        <div class="mb-btn-row" id="stMbDiffRow">
          ${diffOpts.map(([d,l])=>`<button class="mb-preset-btn${mbDifficulty===d?' active':''}" onclick="stSetMbDiff('${d}',this)">${l}</button>`).join('')}
        </div>
      </div>
      <div class="mb-preview" id="mockbar-preview">Loading…</div>
      <div id="stMbWarnBanner" class="mb-warn-banner" style="display:none;"></div>
      <button class="btn-gold" id="stStartMockBtn" onclick="startSubjectMockBar('${subj}')"
        style="width:100%;justify-content:center;font-size:15px;padding:14px;margin-top:8px;">
        ⚡ Start ${h(s?.name||subj)} Mock Bar
      </button>
    </div>`;
  updateMockPreview();
}

function stSetMbCount(n, btn) {
  mbCount = n || 20;
  document.querySelectorAll('#stMbCountRow .mb-preset-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  updateMockPreview();
}
function stSetMbTime(mins, btn) {
  mbTimeMins = mins;
  document.querySelectorAll('#stMbTimeRow .mb-preset-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
}
function stSetMbDiff(diff, btn) {
  mbDifficulty = diff;
  document.querySelectorAll('#stMbDiffRow .mb-preset-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
}

// ── SOURCE PICKER ────────────────────────────────────────────
// Builds the sources section HTML and initialises window.mockSources
function renderSourcesSection(subj) {
  window.mockSources = {};

  const subjPastBar   = (KB.pastBar||[]).filter(pb => pb.subject === subj);
  const subjContent   = CACHE[subj] || {};
  const preGenTopics  = Object.keys(subjContent).filter(t => subjContent[t]?.essay?.questions?.length);
  const preGenCount   = preGenTopics.reduce((a,t) => a + (subjContent[t].essay.questions.length), 0);

  // Populate state
  subjPastBar.forEach(pb => {
    window.mockSources[pb.id] = { type:'pastbar', id:pb.id, name:pb.name, subject:pb.subject, year:pb.year, count:pb.qCount||0, selected:true };
  });
  if (preGenTopics.length > 0) {
    window.mockSources['pregen'] = { type:'pregen', id:'pregen', name:'Pre-Generated Topic Questions', subject:subj, count:preGenCount, topics:preGenTopics, selected:true };
  }

  const makeItem = (id, icon, name, meta, checked) =>
    `<label class="source-item${checked?' source-checked':''}" id="src-item-${id}" onclick="toggleSource('${id}')">
      <input type="checkbox" id="src-${id}"${checked?' checked':''} style="display:none;">
      <div class="source-check-icon">${checked?'☑':'☐'}</div>
      <div class="source-item-info">
        <div class="source-item-name">${icon} ${h(name)}</div>
        <div class="source-item-meta">${meta}</div>
      </div>
    </label>`;

  let html = `<div class="mb-setup-card">
    <div class="mb-section-label">Question Sources</div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:12px;">Select which uploaded materials to draw questions from.</div>`;

  if (subjPastBar.length > 0) {
    html += `<div class="sources-group-label">Past Bar &amp; Exam Materials</div>`;
    subjPastBar.forEach(pb => {
      const meta = `${h(pb.subject)}${pb.year?' · '+pb.year:''} · <strong>${pb.qCount||0} questions</strong>`;
      html += makeItem(pb.id, '📜', pb.name, meta, true);
    });
  }

  if (preGenTopics.length > 0) {
    html += `<div class="sources-group-label"${subjPastBar.length?' style="margin-top:12px;"':''}>Pre-Generated Content</div>`;
    html += makeItem('pregen', '📚', 'Pre-Generated Topic Questions', `${preGenTopics.length} topics · <strong>${preGenCount} questions</strong>`, true);
  }

  if (subjPastBar.length === 0 && preGenTopics.length === 0) {
    html += `<div style="text-align:center;padding:24px 12px;color:var(--muted);font-size:13px;line-height:1.7;">
      <div style="font-size:32px;margin-bottom:10px;">📂</div>
      No materials uploaded for this subject yet.<br>
      Go to <button class="source-ctrl-btn" onclick="navToAdmin()" style="vertical-align:middle;">⚙️ Admin</button> to upload past bar questions or reference materials.
    </div>`;
  }

  const totalItems = subjPastBar.length + (preGenTopics.length > 0 ? 1 : 0);
  if (totalItems > 1) {
    html += `<div style="display:flex;gap:8px;margin-top:12px;">
      <button class="source-ctrl-btn" onclick="selectAllSources(true)">✓ Select All</button>
      <button class="source-ctrl-btn" onclick="selectAllSources(false)">✗ Deselect All</button>
    </div>`;
  }

  html += `</div>`;
  return html;
}

function toggleSource(id) {
  if (!window.mockSources?.[id]) return;
  window.mockSources[id].selected = !window.mockSources[id].selected;
  updateSourcesDisplay();
  updateMockPreview();
}

function selectAllSources(val) {
  if (!window.mockSources) return;
  Object.keys(window.mockSources).forEach(id => { window.mockSources[id].selected = val; });
  updateSourcesDisplay();
  updateMockPreview();
}

function updateSourcesDisplay() {
  if (!window.mockSources) return;
  Object.keys(window.mockSources).forEach(id => {
    const src  = window.mockSources[id];
    const item = document.getElementById('src-item-' + id);
    const icon = item?.querySelector('.source-check-icon');
    if (!item) return;
    item.classList.toggle('source-checked', src.selected);
    if (icon) icon.textContent = src.selected ? '☑' : '☐';
  });
}

function updateMockPreview() {
  const sel   = Object.values(window.mockSources || {}).filter(s => s.selected);
  const avail = sel.reduce((a,s) => a + (s.count||0), 0);
  const want  = mbCount || 5;
  let text;
  if (sel.length === 0) {
    text = '⚠️ No sources selected. Select at least one source to begin.';
  } else if (avail === 0) {
    text = '⚠️ Selected sources have 0 questions available.';
  } else if (avail < want) {
    text = `⚠️ Only ${avail} question${avail!==1?'s':''} available — will generate ${avail}.`;
  } else {
    text = `✓ ${avail} questions available from ${sel.length} source${sel.length!==1?'s':''} · Will draw ${want}`;
  }
  const prev = document.getElementById('mockbar-preview');
  if (prev) prev.textContent = text;
  const btn = document.getElementById('stStartMockBtn');
  if (btn) { const off = sel.length === 0 || avail === 0; btn.disabled = off; btn.style.opacity = off ? '0.4' : '1'; }
}

async function startSubjectMockBar(subj) {
  const btn = document.getElementById('stStartMockBtn');
  if (btn) { btn.disabled = true; btn.textContent = '⏳ Preparing…'; }
  const sel          = Object.values(window.mockSources || {}).filter(s => s.selected);
  const pastBarIds   = sel.filter(s => s.type === 'pastbar').map(s => s.id);
  const includePreGen = sel.some(s => s.type === 'pregen');
  try {
    const r = await fetch('/api/mockbar/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ subjects: [subj], count: mbCount, pastBarIds, includePreGen, aiGenerate: false, difficulty: mbDifficulty, timeMins: mbTimeMins || 0 }),
    });
    const d = await r.json();
    if (d.error) throw new Error(d.error);
    if (d.warning) {
      const warn = document.getElementById('stMbWarnBanner');
      if (warn) { warn.textContent = '⚠️ ' + d.warning; warn.style.display = ''; }
    }
    startMockSession(d.questions, mbTimeMins);
  } catch(e) {
    const s = SUBJS.find(x=>x.key===subj)?.name || subj;
    if (btn) { btn.disabled = false; btn.textContent = '⚡ Start ' + s + ' Mock Bar'; }
    alert('Error: ' + e.message);
  }
}

function showLockedMessage(subj, mode) {
  const subjInfo = ALL_SUBJS.find(s => s.key === subj);
  showPage('mockbar'); // reuse a blank area
  document.getElementById('mockConfig').innerHTML = `
    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:65vh;text-align:center;padding:32px;">
      <div style="font-size:56px;margin-bottom:14px;">🔒</div>
      <div style="font-family:var(--fd);font-size:24px;font-weight:700;color:var(--gold-l);margin-bottom:8px;">Section Unavailable</div>
      <div style="font-size:14px;color:var(--muted);max-width:320px;line-height:1.7;margin-bottom:24px;">This section has been temporarily disabled by the administrator.</div>
      <button class="btn-gold" onclick="navToOverview()" style="font-size:13px;padding:10px 20px;">🏛 Go to Overview</button>
    </div>`;
}

// Sidebar no longer uses expand/collapse — subjects are single-click items.
// Kept as no-op for any legacy call sites.
function toggleSbSubject(subj, forceOpen) { /* no-op — sidebar uses direct navToSubject */ }

function loadLearnForSubject(subj) {
  // Delegate to subject page learn tab
  navToSubject(subj, 'learn');
}

function loadQuizForSubject(subj) {
  navToSubject(subj, 'quiz');
}

function loadMockBarForSubject(subj) {
  navToSubject(subj, 'mockbar');
}

// Legacy nav() — bridged to new system for backward compat (used inside admin HTML)
function nav(id, btn) {
  if (id === 'dashboard' || id === 'overview') { navToOverview(); return; }
  if (id === 'admin')   { navToAdmin(); return; }
  if (id === 'learn')   { navToSubject(currentSubject || SUBJS[0].key, 'learn'); return; }
  if (id === 'practice'){ navToSubject(currentSubject || SUBJS[0].key, 'quiz'); return; }
  if (id === 'mockbar') { navToSubject(currentSubject, 'mockbar'); return; }
  // Generic fallback
  showPage(id);
}

// ══════════════════════════════════
// SIDEBAR RENDERER
// ══════════════════════════════════
function renderSidebar() {
  const list = document.getElementById('sbSubjectList');
  if (!list) return;
  list.innerHTML = SUBJS.map(s => {
    const hasMaterials = (KB.references||[]).some(r=>r.subject===s.key) || (KB.pastBar||[]).some(p=>p.subject===s.key);
    const qCount = (KB.pastBar||[]).filter(p=>p.subject===s.key).reduce((a,p)=>a+(p.qCount||0),0);
    return `<button class="sb-subject" id="sb-subj-${s.key}" style="border-left-color:${s.color};" onclick="navToSubject('${s.key}')">
      <span class="sb-subj-dot" style="background:${hasMaterials?s.color:'rgba(248,246,241,.2)'};"></span>
      <span style="flex:1;">${h(s.name)}</span>
      ${qCount>0?`<span class="sb-subj-qcount">${qCount}q</span>`:''}
      <span class="sb-lock-icon" style="display:none;">🔒</span>
    </button>`;
  }).join('');
}

function refreshSidebarDots() {
  SUBJS.forEach(s => {
    const el = document.getElementById('sb-subj-' + s.key);
    if (!el) return;
    const hasMaterials = (KB.references||[]).some(r=>r.subject===s.key) || (KB.pastBar||[]).some(p=>p.subject===s.key);
    const dot = el.querySelector('.sb-subj-dot');
    if (dot) dot.style.background = hasMaterials ? s.color : 'rgba(248,246,241,.2)';
    const qCount = (KB.pastBar||[]).filter(p=>p.subject===s.key).reduce((a,p)=>a+(p.qCount||0),0);
    let countEl = el.querySelector('.sb-subj-qcount');
    if (qCount > 0) {
      if (!countEl) { countEl = document.createElement('span'); countEl.className='sb-subj-qcount'; el.insertBefore(countEl, el.querySelector('.sb-lock-icon')); }
      countEl.textContent = qCount + 'q';
    } else if (countEl) { countEl.remove(); }
  });
  // Custom subject count badge
  const customQCount = (KB.pastBar||[]).filter(p=>p.subject==='custom').reduce((a,p)=>a+(p.qCount||0),0);
  const customCountEl = document.getElementById('sbCustomCount');
  if (customCountEl) {
    customCountEl.textContent = customQCount > 0 ? customQCount + 'q' : '';
    customCountEl.style.display = customQCount > 0 ? '' : 'none';
  }
}

// ══════════════════════════════════
// OVERVIEW GRID
// ══════════════════════════════════
function renderOverviewGrid() {
  const grid = document.getElementById('overviewSubjectGrid');
  if (!grid) return;
  const cacheCount = subj => Object.keys(CACHE[subj] || {}).length;
  const pbCount = subj => (KB.pastBar||[]).filter(p=>p.subject===subj).reduce((a,p)=>a+(p.qCount||0),0);
  const topicCount = subj => (KB.syllabusTopics||[]).find(s=>s.key===subj)?.topics?.length || 0;
  grid.innerHTML = SUBJS.map(s => `
    <div class="ov-card" style="border-top-color:${s.color};">
      <div class="ov-card-name" style="color:${s.color};">${h(s.name)}</div>
      <div class="ov-card-stats">
        ${topicCount(s.key)} topics · ${cacheCount(s.key)} pre-gen · ${pbCount(s.key)} past bar Qs
      </div>
      <div class="ov-card-btns">
        <button class="ov-card-btn" onclick="navToSubject('${s.key}','learn')">📖 Learn</button>
        <button class="ov-card-btn" onclick="navToSubject('${s.key}','quiz')">✏️ Quiz</button>
        <button class="ov-card-btn" onclick="navToSubject('${s.key}','mockbar')">⏱ Mock</button>
      </div>
    </div>`).join('');
  // Also update welcome message
  const wc = document.getElementById('overviewWelcome');
  if (wc && currentUser) wc.textContent = `Welcome back, ${currentUser.name.split(' ')[0]}.`;
}
const openModal  = id => document.getElementById(id).classList.add('on');
const closeModal = id => document.getElementById(id).classList.remove('on');
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('on');}));

// ══════════════════════════════════
// SYLLABUS TREE
// ══════════════════════════════════

// Recursively extract all testable (non-group) topics from hierarchical structure
function flattenLeafTopics(topics) {
  const result = [];
  function walk(items) {
    (items||[]).forEach(t => {
      if (!t.isGroup) result.push(t);
      walk(t.subtopics); walk(t.children);
    });
  }
  walk(topics);
  return result;
}

// Toggle expand/collapse on a tree group or parent node
function toggleTopicGroup(el) {
  el.classList.toggle('open');
  const next = el.nextElementSibling;
  if (next) next.classList.toggle('open');
}

// Toggle just the children container via expand icon click (without triggering parent onclick)
function toggleTopicChildren(iconEl) {
  const row = iconEl.closest('.topic-parent-row');
  const childDiv = row && row.nextElementSibling;
  if (!childDiv) return;
  iconEl.classList.toggle('open');
  childDiv.classList.toggle('open');
}

// Recursive tree renderer — returns HTML string
function renderTopicTree(topics, subjKey, depth) {
  depth = depth || 0;
  if (!topics || !topics.length) return '';
  let html = '';
  topics.forEach(t => {
    const sub = [...(t.subtopics||[]), ...(t.children||[])];
    if (t.isGroup) {
      // Non-testable section header — expand/collapse only
      html += `<div class="topic-group-header" onclick="toggleTopicGroup(this)">
        <span class="topic-expand-icon">▶</span>
        <span class="t-lbl">${h(t.name)}</span>
      </div>
      <div class="topic-group-children">
        ${renderTopicTree(sub, subjKey, depth+1)}
      </div>`;
    } else if (sub.length) {
      // Testable topic that also has subtopics — clicking row loads lesson;
      // expand icon separately collapses children
      const cached = getCached(subjKey, t.name);
      const genNow = KB.genState?.running && KB.genState?.current?.includes(t.name);
      html += `<div class="topic-parent-row${cached?' done':''}" onclick="clickTopic('${h(subjKey)}','${h(t.name)}')">
        <span class="t-chk">${cached?'✓':'○'}</span>
        <span class="t-lbl">${h(t.name)}</span>
        ${genNow?'<span class="ready-badge rb-gen">gen…</span>':cached?'<span class="topic-badge-cached">cached</span>':''}
        <span class="topic-expand-icon" onclick="event.stopPropagation();toggleTopicChildren(this)">▶</span>
      </div>
      <div class="topic-parent-children">
        ${renderTopicTree(sub, subjKey, depth+1)}
      </div>`;
    } else {
      // Pure leaf topic
      const cached = getCached(subjKey, t.name);
      const genNow = KB.genState?.running && KB.genState?.current?.includes(t.name);
      html += `<div class="topic-leaf-item${cached?' done':''}" onclick="clickTopic('${h(subjKey)}','${h(t.name)}')">
        <span class="t-chk">${cached?'✓':'○'}</span>
        <span class="t-lbl">${h(t.name)}</span>
        ${genNow?'<span class="ready-badge rb-gen">gen…</span>':cached?'<span class="topic-badge-cached">cached</span>':''}
      </div>`;
    }
  });
  return html;
}

function renderSyllabusTree(filter, subjFilter) {
  filter = filter || '';
  subjFilter = subjFilter || null;
  const tree = document.getElementById('syllabusTree');
  if (!tree) return;  // element only exists while Learn tab is active
  if (!KB.hasSyllabus && !KB.syllabusTopics?.length) {
    tree.innerHTML=`<div style="padding:20px 12px;text-align:center;color:var(--muted);font-size:12px;line-height:1.6;"><div style="font-size:28px;margin-bottom:8px;opacity:.4;">📋</div>Upload Bar Syllabus in Admin.</div>`;
    return;
  }
  const fl = filter.toLowerCase();
  let html = '', tAll = 0, tDone = 0;
  (KB.syllabusTopics||[]).forEach(subj => {
    if (subjFilter && subj.key !== subjFilter) return;
    const sub = SUBJS.find(s=>s.key===subj.key)||{name:subj.name||subj.key,cls:'sg-gen'};
    const allLeaves = flattenLeafTopics(subj.topics||[]);
    tAll += allLeaves.length;
    tDone += allLeaves.filter(t=>getCached(subj.key,t.name)).length;
    const hasRef = KB.references?.some(r=>r.subject===subj.key);

    if (fl) {
      // Flat filtered list — search across all descendants
      const matches = allLeaves.filter(t=>t.name.toLowerCase().includes(fl));
      if (!matches.length) return;
      html += `<div>
        <div class="subj-hdr open" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
          <span class="chev">▶</span><span class="subj-label">${h(sub.name)}</span>
          ${hasRef?'<span style="font-size:9px;color:var(--teal);" title="References loaded">📚</span>':''}
          <span class="subj-cnt">${matches.filter(t=>getCached(subj.key,t.name)).length}/${matches.length}</span>
        </div>
        <div class="topic-list open">
          ${matches.map(t => {
            const cached = getCached(subj.key,t.name);
            const genNow = KB.genState?.running && KB.genState?.current?.includes(t.name);
            return `<div class="topic-leaf-item${cached?' done':''}" onclick="clickTopic('${h(subj.key)}','${h(t.name)}')">
              <span class="t-chk">${cached?'✓':'○'}</span>
              <span class="t-lbl">${h(t.name)}</span>
              ${genNow?'<span class="ready-badge rb-gen">gen…</span>':cached?'<span class="topic-badge-cached">cached</span>':''}
            </div>`;
          }).join('')}
        </div>
      </div>`;
    } else {
      // Hierarchical tree display
      const treeHtml = renderTopicTree(subj.topics||[], subj.key, 0);
      if (!treeHtml) return;
      html += `<div>
        <div class="subj-hdr open" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
          <span class="chev">▶</span><span class="subj-label">${h(sub.name)}</span>
          ${hasRef?'<span style="font-size:9px;color:var(--teal);" title="References loaded">📚</span>':''}
          <span class="subj-cnt">${allLeaves.filter(t=>getCached(subj.key,t.name)).length}/${allLeaves.length}</span>
        </div>
        <div class="topic-list open">${treeHtml}</div>
      </div>`;
    }
  });
  tree.innerHTML = html || `<div style="padding:18px;text-align:center;color:var(--muted);font-size:12px;">No topics match.</div>`;
  const pct = tAll ? Math.round(tDone/tAll*100) : 0;
  const pctEl = document.getElementById('learn-pct'); if(pctEl) pctEl.textContent = pct+'%';
  const fillEl = document.getElementById('learn-fill'); if(fillEl) fillEl.style.width = pct+'%';
}
function filterTopics(v){renderSyllabusTree(v, currentSubject);}

// ══════════════════════════════════
// LESSON VIEWER
// ══════════════════════════════════
async function clickTopic(subjKey, topicName) {
  document.querySelectorAll('.topic-item,.topic-leaf-item,.topic-parent-row').forEach(t=>{
    t.classList.remove('active');
    const oc=t.getAttribute('onclick')||'';
    if(oc.includes(topicName)&&oc.includes(subjKey)) t.classList.add('active');
  });
  curSubj=subjKey; curTopic=topicName; curPage=0;
  const sub=SUBJS.find(s=>s.key===subjKey)||{name:subjKey,cls:'sg-gen'};
  const lpBC=document.getElementById('lpBC');if(lpBC)lpBC.innerHTML=`<span class="sbg ${sub.cls}">${h(sub.name)}</span> &nbsp;›&nbsp; <strong>${h(topicName)}</strong>`;
  const lpTB=document.getElementById('lpTopbar');if(lpTB)lpTB.style.display='flex';

  // 1) Check browser cache first
  let data = getCached(subjKey, topicName);
  if (data) { renderLesson(data, topicName, subjKey, 'cache'); return; }

  // 2) Try server
  const _lpc=document.getElementById('lpContent'),_lpf=document.getElementById('lpFooter');
  if(_lpc)_lpc.innerHTML=`<div class="gen-state"><div class="spin"></div><div style="font-size:14px;color:var(--gold-l);">Loading from server…</div></div>`;
  if(_lpf)_lpf.style.display='none';
  try {
    const r = await fetch(`/api/content/${subjKey}/${encodeURIComponent(topicName)}`);
    const d = await r.json();
    if (d.found) {
      if (d.status === 'no_materials') { renderNoMaterials(subjKey, topicName); return; }
      saveCacheItem(subjKey, topicName, d); renderLesson(d, topicName, subjKey, 'server'); return;
    }
  } catch(e){}

  // 3) Check if subject has no references at all — skip AI gen, show no_materials
  const hasRefs = (KB.references||[]).some(r => r.subject === subjKey);
  if (!hasRefs) { renderNoMaterials(subjKey, topicName); return; }

  // 4) On-demand generation (fallback if pre-gen hasn't reached this yet)
  await genOnDemand(subjKey, topicName);
}

function renderNoMaterials(subjKey, topicName) {
  const subjInfo = SUBJS.find(s => s.key === subjKey);
  const lpContent = document.getElementById('lpContent');
  if (!lpContent) return;
  lpContent.innerHTML = `
    <div style="text-align:center;padding:40px 20px;">
      <div style="font-size:40px;margin-bottom:12px;">📂</div>
      <div style="font-family:var(--fd);font-size:18px;font-weight:700;color:var(--gold-l);margin-bottom:8px;">No Materials for This Subject</div>
      <div style="font-size:13px;color:var(--muted);line-height:1.7;max-width:300px;margin:0 auto 20px;">
        Upload reference materials tagged to <strong>${h(subjInfo?.name||subjKey)}</strong> in the Admin panel to generate lesson content for "${h(topicName)}".
      </div>
      <button class="btn-gold" onclick="navToAdmin()" style="font-size:12px;">⚙️ Go to Admin</button>
    </div>`;
  const lpFooter=document.getElementById('lpFooter');if(lpFooter)lpFooter.style.display='none';
}

function renderLesson(data, topicName, subjKey, source) {
  if (data?.status === 'no_materials') { renderNoMaterials(subjKey, topicName); return; }
  const lpContent = document.getElementById('lpContent');
  if (!lpContent) return; // tab no longer active (async race)
  const pages = data.lesson?.pages;
  if (!pages?.length) { lpContent.innerHTML=`<div style="padding:30px;text-align:center;color:#e07080;">⚠️ No lesson content found. Try regenerating.</div>`; return; }
  const page = pages[curPage], total=pages.length;
  const sub=SUBJS.find(s=>s.key===subjKey)||{cls:'sg-gen',name:subjKey};
  const hasRef=KB.references?.some(r=>r.subject===subjKey);
  lpContent.innerHTML=`<div class="lc">
    ${hasRef?`<div class="kb-ref-note">📚 Grounded in uploaded reference materials. ${source==='cache'?'Loaded from browser cache.':'Loaded from server.'}</div>`:''}
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
      <span class="sbg ${sub.cls}">${h(sub.name)}</span><span class="tag tg-l">Lesson</span>
      <span style="font-size:10px;color:var(--muted);margin-left:auto;font-family:var(--fm);">${source==='cache'?'💾 cached':'🖥 server'}</span>
    </div>
    <h2>${h(topicName)}</h2>
    <div class="lc-meta">
      <span style="font-size:12px;color:var(--muted);font-family:var(--fm);">Page ${curPage+1} of ${total}</span>
      <div style="height:4px;width:110px;background:rgba(255,255,255,.07);border-radius:2px;overflow:hidden;">
        <div style="height:100%;width:${((curPage+1)/total)*100}%;background:linear-gradient(90deg,var(--gold-d),var(--gold));border-radius:2px;"></div>
      </div>
    </div>
    <h3>${h(page.title)}</h3>
    ${page.content}
  </div>`;
  const pgInfo=document.getElementById('lpPgInfo');if(pgInfo)pgInfo.textContent=`Page ${curPage+1} of ${total}`;
  const prev=document.getElementById('lpPrev');if(prev)prev.disabled=curPage===0;
  const footer=document.getElementById('lpFooter');if(footer)footer.style.display='flex';
  const nxt=document.getElementById('lpNext');
  if (nxt){if(curPage<total-1){nxt.textContent='Next →';nxt.onclick=()=>chgPage(1);}
  else{nxt.textContent='Done ✓';nxt.onclick=()=>{markDone();goToPractice();};}}
  // Track visit
  const existing=VISITED.findIndex(v=>v.subjKey===subjKey&&v.topicName===topicName);
  if(existing>=0)VISITED.splice(existing,1);
  VISITED.unshift({subjKey,topicName,title:topicName,type:'lesson'});
  if(VISITED.length>12)VISITED.length=12;
  try{localStorage.setItem(LS_VISITED,JSON.stringify(VISITED));}catch(e){}
  updateDash();
}

async function callAPI({ messages, max_tokens = 4096 }) {
  const r = await fetch('/api/generate-content', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ messages, max_tokens }),
  });
  const d = await r.json();
  if (d.error) throw new Error(d.error);
  return d.content;
}

async function genOnDemand(subjKey, topicName) {
  const lpContent=()=>document.getElementById('lpContent');
  const lpFooter=()=>document.getElementById('lpFooter');
  if(lpContent())lpContent().innerHTML=`<div class="gen-state"><div class="spin"></div><div style="font-size:14px;color:var(--gold-l);">Generating "${h(topicName)}"…</div><div style="font-size:12px;color:var(--muted);text-align:center;max-width:280px;">Pre-generation hasn't reached this topic yet. Generating now and caching for next time.</div></div>`;
  if(lpFooter())lpFooter().style.display='none';
  const prompt=`Generate a complete Philippine Bar Exam study package for: "${topicName}" (${subjKey} law)

Respond ONLY with valid JSON (no markdown):
{
  "lesson":{"pages":[{"title":"Page 1: Overview","content":"Rich HTML with definition-box, case-box, codal-box, rule-box, tip-box divs"},{"title":"Page 2: Applications","content":"More cases and bar tips"}]},
  "mcq":{"questions":[{"q":"Bar MCQ","options":["A.","B.","C.","D."],"answer":0,"explanation":"Cite Art./G.R."},{"q":"...","options":["A.","B.","C.","D."],"answer":1,"explanation":"..."},{"q":"...","options":["A.","B.","C.","D."],"answer":2,"explanation":"..."},{"q":"...","options":["A.","B.","C.","D."],"answer":0,"explanation":"..."},{"q":"...","options":["A.","B.","C.","D."],"answer":3,"explanation":"..."}]},
  "essay":{"questions":[{"prompt":"Full bar essay question","context":"","modelAnswer":"Answer with citations","keyPoints":["Point 1","Point 2"]},{"prompt":"...","context":"","modelAnswer":"...","keyPoints":["..."]},{"prompt":"...","context":"","modelAnswer":"...","keyPoints":["..."]}]}
}`;
  try{
    const raw=await callAPI({messages:[{role:'user',content:prompt}],max_tokens:4096,subject:subjKey,topicName,mode:'lesson'});
    const data=JSON.parse(raw.replace(/^```json\s*/i,'').replace(/```$/,'').trim());
    saveCacheItem(subjKey,topicName,data);
    buildQuizPool();
    renderSyllabusTree(document.getElementById('topicSearch')?.value||'');
    renderLesson(data,topicName,subjKey,'generated');
  }catch(err){
    if(lpContent())lpContent().innerHTML=`<div style="padding:36px;text-align:center;color:#e07080;"><div style="font-size:36px;margin-bottom:10px;">⚠️</div><p style="margin-bottom:14px;">${h(err.message)}</p><button class="btn-gold" onclick="genOnDemand('${subjKey}','${h(topicName)}')">Retry</button></div>`;
  }
}

function chgPage(d){
  const data=getCached(curSubj,curTopic);if(!data)return;
  curPage+=d;renderLesson(data,curTopic,curSubj,'cache');
}
function markDone(){document.querySelector('.topic-item.active,.topic-leaf-item.active,.topic-parent-row.active')?.classList.add('done');}
function goToPractice(){
  if (currentSubject) {
    switchSubjectTab(currentSubject, 'quiz');
    // After tab renders, jump to matching quiz item
    setTimeout(() => {
      const qi=quizPool.findIndex(q=>q.type===qMode&&q.subject===curSubj&&q.topic===curTopic);
      if(qi>=0)openQuizItem(qi);else renderQuizList();
    }, 50);
  } else {
    nav('practice', null);
    const qi=quizPool.findIndex(q=>q.type===qMode&&q.subject===curSubj&&q.topic===curTopic);
    if(qi>=0)openQuizItem(qi);else renderQuizList();
  }
}

// ══════════════════════════════════
// QUIZ POOL (from cache)
// ══════════════════════════════════
function buildQuizPool(subjFilter) {
  quizPool=[];
  Object.entries(CACHE).forEach(([subj,topics])=>{
    if (subjFilter && subj !== subjFilter) return;
    Object.entries(topics).forEach(([topic,data])=>{
      if(data.mcq?.questions?.length) quizPool.push({type:'mcq',subject:subj,topic,data:data.mcq});
      if(data.essay?.questions?.length) quizPool.push({type:'essay',subject:subj,topic,data:data.essay});
    });
  });
  renderQuizList();
  updateDash();
}

function setQMode(m){qMode=m;['mcq','essay'].forEach(x=>{const el=document.getElementById('qmode-'+x);if(el)el.classList.toggle('on',x===m);});renderQuizList();}
function renderQuizList(){
  const list=document.getElementById('quizList');
  if(!list) return;  // element only exists while Quiz tab is active
  const items=quizPool.filter(q=>q.type===qMode);
  if(!items.length){list.innerHTML=`<div style="padding:16px 12px;text-align:center;color:var(--muted);font-size:12px;line-height:1.6;">No ${qMode} quizzes cached yet.</div>`;return;}
  list.innerHTML=items.map((q,i)=>{const sub=SUBJS.find(s=>s.key===q.subject)||{cls:'sg-gen',name:q.subject};
    return `<div class="qn-item${activeQuiz===i?' active':''}" onclick="openQuizItem(${i})"><div class="qn-icon">${qMode==='mcq'?'🔘':'✍️'}</div><div class="qn-info"><div class="qn-title">${h(q.topic)}</div><div class="qn-sub"><span class="sbg ${sub.cls}" style="font-size:9px;">${sub.name}</span> ${q.data.questions?.length||0} Qs</div></div></div>`;
  }).join('');
}
function openQuizItem(i){activeQuiz=i;qIdx=0;qScore=0;renderQuizList();const qh=document.getElementById('qmHead');if(qh)qh.style.display='flex';const qt=document.getElementById('qmTitle');if(qt)qt.textContent=quizPool[i]?.topic||'Quiz';const qm=document.getElementById('qmMeta');if(qm)qm.textContent=`${quizPool[i]?.data?.questions?.length||0} questions`;renderQuizQ();}
function resetQuiz(){if(activeQuiz!==null){qIdx=0;qScore=0;renderQuizQ();}}

function renderQuizQ(){
  const pool=quizPool[activeQuiz];if(!pool)return;
  const qs=pool.data.questions,body=document.getElementById('qmBody');
  if(!body)return;
  if(qIdx>=qs.length){showQuizResults();return;}
  const cur=qs[qIdx],sub=SUBJS.find(s=>s.key===pool.subject)||{cls:'sg-gen',name:pool.subject};
  if(pool.type==='mcq'){
    body.innerHTML=`<div style="display:flex;gap:7px;margin-bottom:14px;flex-wrap:wrap;"><span class="sbg ${sub.cls}">${sub.name}</span><span class="tag tg-q">Bar MCQ</span></div>
      <div class="q-prog-track"><div class="q-prog-fill" style="width:${(qIdx/qs.length)*100}%"></div></div>
      <div class="q-prog-meta"><span>Q${qIdx+1} of ${qs.length}</span><span>Score: ${qScore}/${qIdx}</span></div>
      <div class="q-question">${h(cur.q)}</div>
      <div class="q-opts">${cur.options.map((o,i)=>`<div class="q-opt" id="qo${i}" onclick="pickMCQ(${i})">${h(o)}</div>`).join('')}</div>
      <div class="q-feedback" id="qfb"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:14px;"><button class="btn-gold" id="qnxt" style="display:none;" onclick="nextQ()">Next →</button></div>`;
  }else{
    body.innerHTML=`<div style="display:flex;gap:7px;margin-bottom:14px;flex-wrap:wrap;"><span class="sbg ${sub.cls}">${sub.name}</span><span class="tag tg-e">Essay</span></div>
      <div class="q-prog-track"><div class="q-prog-fill" style="width:${(qIdx/qs.length)*100}%"></div></div>
      <div class="q-prog-meta"><span>Q${qIdx+1} of ${qs.length}</span><span>Write answer → AI feedback</span></div>
      ${(cur.type==='situational'&&cur.context&&cur.context.trim())
        ? `<div class="facts-box"><div class="facts-label">📋 Facts</div><div class="facts-text">${h(cur.context)}</div></div>
           <div class="question-label">❓ Question</div>
           <div class="question-text">${h(cur.prompt||cur.q||'')}</div>`
        : `<div class="question-text" style="font-size:17px;">${h(cur.prompt||cur.q||'')}</div>`
      }
      <textarea class="essay-box" id="essayBox" placeholder="Write your answer…"></textarea>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="btn-gold" id="essFB" onclick="submitEssay()">🤖 Get AI Feedback</button>
        <button class="btn-ghost" onclick="nextQ()">Skip →</button>
      </div>
      <div class="ai-fb" id="aiFB"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:8px;"><button class="btn-gold" id="essNext" style="display:none;" onclick="nextQ()">Next →</button></div>`;
  }
}
function pickMCQ(i){
  const pool=quizPool[activeQuiz],cur=pool.data.questions[qIdx];
  const ok=i===cur.answer;if(ok){qScore++;totalCorrect++;}totalQDone++;
  document.querySelectorAll('.q-opt').forEach((el,j)=>{if(j===cur.answer)el.classList.add('correct');else if(j===i)el.classList.add('wrong');});
  const fb=document.getElementById('qfb');fb.className='q-feedback show '+(ok?'ok':'no');
  fb.innerHTML=(ok?'✅ <strong>Correct!</strong> ':'❌ <strong>Incorrect.</strong> ')+h(cur.explanation);
  document.getElementById('qnxt').style.display='block';updateDash();
}
// ── Eval format badge ──────────────────────────────────────
function evalFormatBadge(format){
  const map={
    essay:       ['📝 ALAC Scoring',       '#ff8c42','rgba(255,140,66,.12)'],
    truefalse:   ['✓/✗ T/F Scoring',       '#5b9bd5','rgba(91,155,213,.12)'],
    mcq:         ['🔘 MCQ Scoring',         '#5b9bd5','rgba(91,155,213,.12)'],
    enumeration: ['📋 Enumeration Scoring', '#14b4a0','rgba(20,180,160,.12)'],
    definition:  ['📖 Definition Scoring',  '#c9a84c','rgba(201,168,76,.12)'],
  };
  const [label,color,bg]=map[format]||map.essay;
  return `<span style="font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;background:${bg};color:${color};letter-spacing:.04em;margin-right:6px;">${label}</span>`;
}
// ── Dispatcher ─────────────────────────────────────────────
function renderEvalCard(ev){
  if(!ev) return '';
  const fmt=ev.format||'essay';
  if(fmt==='truefalse'||fmt==='mcq') return renderTFMCQCard(ev);
  if(fmt==='enumeration') return renderEnumCard(ev);
  if(fmt==='definition')  return renderDefCard(ev);
  return renderAlacCard(ev);
}
// ── True/False & MCQ card ──────────────────────────────────
function renderTFMCQCard(ev){
  const gc=ev.grade==='Excellent'?'#14b4a0':ev.grade==='Good'?'#50d090':ev.grade==='Satisfactory'?'#c9a84c':ev.grade==='Needs Improvement'?'#e09050':'#e07080';
  const ok=ev.isCorrect;
  return `<div class="ai-fb-head">${evalFormatBadge(ev.format)}<span class="ai-fb-score">${h(ev.score||'?/10')}</span><span style="background:rgba(255,255,255,.08);border-radius:5px;padding:2px 7px;font-family:var(--fm);color:${gc};">${h(ev.grade||'')}</span></div>
  <div class="ai-fb-content">
    <div style="font-size:18px;font-weight:700;margin-bottom:12px;color:${ok?'#14b4a0':'#e07080'};">${ok?'✅ CORRECT':'❌ INCORRECT'}</div>
    ${ev.whyCorrect?`<p style="margin-bottom:6px;"><strong>Why this is correct:</strong></p><p style="color:rgba(248,246,241,.85);line-height:1.7;margin-bottom:10px;">${h(ev.whyCorrect)}</p>`:''}
    ${ev.whyOthersWrong?`<p style="margin-bottom:4px;"><strong>Why other options are wrong:</strong></p><p style="color:rgba(248,246,241,.7);font-size:13px;line-height:1.7;margin-bottom:10px;">${h(ev.whyOthersWrong)}</p>`:''}
    ${ev.overallFeedback&&!ev.whyCorrect?`<p style="color:rgba(248,246,241,.85);line-height:1.7;">${h(ev.overallFeedback)}</p>`:''}
    <details style="margin-top:12px;"><summary style="cursor:pointer;color:var(--gold);font-weight:600;font-size:13px;">📖 Correct Answer</summary>
    <div style="margin-top:8px;padding:12px;background:rgba(255,255,255,.03);border-radius:9px;">${renderModelAnswer(ev.modelAnswer||ev.correctAnswer||'')}</div></details>
  </div>`;
}
// ── Enumeration card ──────────────────────────────────────
function renderEnumCard(ev){
  const gc=ev.grade==='Excellent'?'#14b4a0':ev.grade==='Good'?'#50d090':ev.grade==='Satisfactory'?'#c9a84c':ev.grade==='Needs Improvement'?'#e09050':'#e07080';
  return `<div class="ai-fb-head">${evalFormatBadge(ev.format)}<span class="ai-fb-score">${h(ev.score||'?/10')}</span><span style="background:rgba(255,255,255,.08);border-radius:5px;padding:2px 7px;font-family:var(--fm);color:${gc};">${h(ev.grade||'')}</span></div>
  <div class="ai-fb-content">
    <div style="font-size:16px;font-weight:700;margin-bottom:12px;color:${gc};">Items Correct: ${ev.itemsCorrect??'?'} / ${ev.itemsRequired??'?'}</div>
    ${ev.itemsMissed?.length?`<p style="margin-bottom:6px;"><strong>❌ Items you missed:</strong></p><ul>${ev.itemsMissed.map(s=>`<li>${h(s)}</li>`).join('')}</ul>`:'<p style="color:#14b4a0;font-weight:600;">✅ All items covered!</p>'}
    ${ev.itemsWrong?.length?`<p style="margin-top:8px;margin-bottom:4px;"><strong>⚠️ Incorrect items stated:</strong></p><ul>${ev.itemsWrong.map(s=>`<li>${h(s)}</li>`).join('')}</ul>`:''}
    ${ev.overallFeedback?`<p style="margin-top:10px;color:rgba(248,246,241,.8);line-height:1.7;">${h(ev.overallFeedback)}</p>`:''}
    <details style="margin-top:12px;"><summary style="cursor:pointer;color:var(--gold);font-weight:600;font-size:13px;">📖 Complete Answer</summary>
    <div style="margin-top:8px;padding:12px;background:rgba(255,255,255,.03);border-radius:9px;">${renderModelAnswer(ev.modelAnswer||'')}</div></details>
  </div>`;
}
// ── Definition / Distinction card ─────────────────────────
function renderDefCard(ev){
  const gc=ev.grade==='Excellent'?'#14b4a0':ev.grade==='Good'?'#50d090':ev.grade==='Satisfactory'?'#c9a84c':ev.grade==='Needs Improvement'?'#e09050':'#e07080';
  const bd=ev.breakdown||{};
  const cls=(s,max)=>s>=max*.8?'hi':s>=max*.5?'mid':'lo';
  const defRows=[['Accuracy',bd.accuracy,4],['Completeness',bd.completeness,3],['Clarity',bd.clarity,3]].filter(([,c])=>c);
  const tableRows=defRows.map(([label,c,max])=>`<tr>
    <td style="color:var(--white);font-weight:600;">${label}</td>
    <td><span class="alac-score ${cls(c.score??0,max)}">${c.score!=null?c.score:'—'}</span></td>
    <td style="color:var(--muted);font-size:12px;white-space:nowrap;">/${max}</td>
    <td style="color:rgba(248,246,241,.8);">${h(c.feedback||'')}</td>
  </tr>`).join('');
  return `<div class="ai-fb-head">${evalFormatBadge(ev.format)}<span class="ai-fb-score">${h(ev.score||'?/10')}</span><span style="background:rgba(255,255,255,.08);border-radius:5px;padding:2px 7px;font-family:var(--fm);color:${gc};">${h(ev.grade||'')}</span></div>
  <div class="ai-fb-content">
    <table class="alac-table">
      <thead><tr><th>Component</th><th>Score</th><th>Max</th><th>Feedback</th></tr></thead>
      <tbody>${tableRows}<tr class="alac-total-row"><td style="color:${gc};">Total</td><td style="color:${gc};">${h(ev.score||'?/10')}</td><td style="color:var(--muted);font-size:12px;">/10</td><td style="color:rgba(248,246,241,.6);font-size:12px;">${h(ev.overallFeedback||'')}</td></tr></tbody>
    </table>
    ${ev.keyMissed?.length?`<p style="margin-top:10px;"><strong>📚 Missed:</strong></p><ul>${ev.keyMissed.map(s=>`<li>${h(s)}</li>`).join('')}</ul>`:''}
    <details style="margin-top:12px;"><summary style="cursor:pointer;color:var(--gold);font-weight:600;font-size:13px;">📖 Model Answer</summary>
    <div style="margin-top:8px;padding:12px;background:rgba(255,255,255,.03);border-radius:9px;">${renderModelAnswer(ev.modelAnswer||'')}</div></details>
  </div>`;
}
// ALAC color thresholds per component
function alacScoreCls(score, key){
  if(key==='answer')      return score>=1.2?'hi':score>=0.7?'mid':'lo';
  if(key==='legalBasis')  return score>=2.0?'hi':score>=1.0?'mid':'lo';
  if(key==='application') return score>=2.8?'hi':score>=1.75?'mid':'lo';
  if(key==='conclusion')  return score>=1.2?'hi':score>=0.7?'mid':'lo';
  return score>=2?'hi':score>=1?'mid':'lo';
}
// Parse "ANSWER: ... LEGAL BASIS: ... APPLICATION: ... CONCLUSION: ..." into sections
function renderModelAnswer(text){
  if(!text) return '';
  const markers=['ANSWER','LEGAL BASIS','APPLICATION','CONCLUSION'];
  const hasAny=markers.some(m=>text.includes(m+':'));
  if(!hasAny) return `<span class="alac-model">${h(text)}</span>`;
  const positions=[];
  markers.forEach(m=>{const idx=text.indexOf(m+':');if(idx!==-1)positions.push({label:m,idx,end:idx+m.length+1});});
  positions.sort((a,b)=>a.idx-b.idx);
  const parts=positions.map((p,i)=>{
    const nextIdx=positions[i+1]?positions[i+1].idx:text.length;
    return {label:p.label,text:text.slice(p.end,nextIdx).trim()};
  });
  return parts.map(p=>`<div class="model-answer-section"><div class="ma-label">${h(p.label)}</div><div class="ma-text">${h(p.text)}</div></div>`).join('');
}
function renderAlacCard(ev){
  const gc=ev.grade==='Excellent'?'#14b4a0':ev.grade==='Good'?'#50d090':ev.grade==='Satisfactory'?'#c9a84c':ev.grade==='Needs Improvement'?'#e09050':'#e07080';
  const al=ev.alac||{};
  const rows=[
    ['A — Answer',      'answer',      al.answer,      1.5],
    ['L — Legal Basis', 'legalBasis',  al.legalBasis,  3.0],
    ['A — Application', 'application', al.application, 4.0],
    ['C — Conclusion',  'conclusion',  al.conclusion,  1.5],
  ];
  const tableRows=rows.map(([label,key,c,maxPts])=>c?`<tr>
    <td style="color:var(--white);font-weight:600;">${label}</td>
    <td><span class="alac-score ${alacScoreCls(c.score??0,key)}">${c.score!=null?c.score:'—'}</span></td>
    <td style="color:var(--muted);font-size:12px;white-space:nowrap;">/${maxPts}</td>
    <td style="color:rgba(248,246,241,.8);">${h(c.feedback||'')}</td>
  </tr>`:''
  ).join('');
  return `<div class="ai-fb-head">${evalFormatBadge('essay')}<span class="ai-fb-score">${h(ev.score||'?/10')}</span><span style="background:rgba(255,255,255,.08);border-radius:5px;padding:2px 7px;font-family:var(--fm);color:${gc};">${h(ev.grade||'')}</span></div>
  <div class="ai-fb-content">
    <table class="alac-table">
      <thead><tr><th>Component</th><th>Score</th><th>Max</th><th>Feedback</th></tr></thead>
      <tbody>${tableRows}<tr class="alac-total-row"><td style="color:${gc};">Total</td><td style="color:${gc};">${h(ev.score||'?/10')}</td><td style="color:var(--muted);font-size:12px;">/10</td><td style="color:rgba(248,246,241,.6);font-size:12px;">${h(ev.overallFeedback||'')}</td></tr></tbody>
    </table>
    ${ev.strengths?.length?`<p style="margin-top:10px;"><strong>✅ Strengths:</strong></p><ul>${ev.strengths.map(s=>`<li>${h(s)}</li>`).join('')}</ul>`:''}
    ${ev.improvements?.length?`<p><strong>⚠️ Improve:</strong></p><ul>${ev.improvements.map(s=>`<li>${h(s)}</li>`).join('')}</ul>`:''}
    ${ev.keyMissed?.length?`<p><strong>📚 Missed:</strong></p><ul>${ev.keyMissed.map(s=>`<li>${h(s)}</li>`).join('')}</ul>`:''}
    <details style="margin-top:12px;"><summary style="cursor:pointer;color:var(--gold);font-weight:600;font-size:13px;">📖 Model Answer (ALAC Format)</summary>
    <div style="margin-top:8px;padding:12px;background:rgba(255,255,255,.03);border-radius:9px;">${renderModelAnswer(ev.modelAnswer||'')}</div></details>
  </div>`;
}
async function submitEssay(){
  const ans=document.getElementById('essayBox')?.value.trim();if(!ans){document.getElementById('essayBox')?.focus();return;}
  const btn=document.getElementById('essFB');btn.disabled=true;btn.textContent='⏳ Evaluating…';
  const pool=quizPool[activeQuiz],cur=pool.data.questions[qIdx];
  const fb=document.getElementById('aiFB');fb.className='ai-fb show';
  fb.innerHTML=`<div class="ai-fb-head"><div class="spin" style="width:16px;height:16px;border-width:2px;"></div> Evaluating…</div>`;
  try{
    const r=await fetch('/api/evaluate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:cur.prompt||cur.q,answer:ans,modelAnswer:cur.modelAnswer,keyPoints:cur.keyPoints,subject:pool.subject})});
    const ev=await r.json();if(ev.error)throw new Error(ev.error);
    fb.innerHTML=renderEvalCard(ev);
    document.getElementById('essNext').style.display='block';totalQDone++;updateDash();
  }catch(err){fb.innerHTML=`<div class="ai-fb-head" style="color:#e07080;">⚠️ ${h(err.message)}</div>`;}
  btn.disabled=false;btn.textContent='🤖 Get AI Feedback';
}
function nextQ(){qIdx++;renderQuizQ();}
function showQuizResults(){
  const pct=qIdx>0?Math.round(qScore/qIdx*100):0;
  const body=document.getElementById('qmBody');if(!body)return;
  body.innerHTML=`<div class="quiz-results">
    <div style="font-size:48px;margin-bottom:12px;">${pct>=70?'⚖️':pct>=50?'📖':'💪'}</div>
    <div style="font-family:var(--fd);font-size:26px;font-weight:700;color:var(--gold-l);margin-bottom:5px;">${pct>=70?'Excellent!':pct>=50?'Good Effort!':'Keep Reviewing!'}</div>
    <div class="qr-stats">
      <div class="qr-stat"><div class="n">${qScore}</div><div class="l">Correct</div></div>
      <div class="qr-stat"><div class="n">${qIdx-qScore}</div><div class="l">Wrong</div></div>
      <div class="qr-stat"><div class="n">${pct}%</div><div class="l">Score</div></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
      <button class="btn-gold" onclick="resetQuiz()">↺ Retry</button>
      <button class="btn-ghost" onclick="nav('learn',document.getElementById('tab-learn'))">📖 Learn</button>
      <button class="btn-mock" onclick="nav('mockbar',document.getElementById('tab-mockbar'))">⏱ Mock Bar</button>
    </div>
  </div>`;
}

// ══════════════════════════════════
// DASHBOARD
// ══════════════════════════════════
function updateDash(){
  document.getElementById('st-score').textContent=totalQDone?Math.round(totalCorrect/totalQDone*100)+'%':'—';
  document.getElementById('h-done').textContent=totalQDone;
  document.getElementById('h-mock').textContent=mockSessions;
  updateKBIndicator();
  // Recent list
  if(VISITED.length){
    document.getElementById('recent-list').innerHTML=VISITED.slice(0,6).map(v=>{
      const sub=SUBJS.find(s=>s.key===v.subjKey)||{cls:'sg-gen',name:v.subjKey};
      return `<div class="r-item" onclick="navToSubject('${v.subjKey}','learn');setTimeout(()=>clickTopic('${v.subjKey}','${h(v.topicName)}'),50);">
        <div class="r-ic">📖</div>
        <div class="r-info"><div class="r-title">${h(v.topicName)}</div><div class="r-sub">${sub.name}</div></div>
        <span class="sbg ${sub.cls}">${sub.name}</span><span class="tag tg-l">Lesson</span>
      </div>`;
    }).join('');
  }
  renderSubjectTracker();
}
function renderSubjectTracker(){
  const cachedBySubj={};
  Object.entries(CACHE).forEach(([k,v])=>cachedBySubj[k]=Object.keys(v).length);
  document.getElementById('sub-tracker').innerHTML=SUBJS.map((s,i)=>{
    const total=(KB.syllabusTopics||[]).find(st=>st.key===s.key)?.topics?.length||0;
    const cached=cachedBySubj[s.key]||0;
    const pct=total?Math.round(cached/total*100):0;
    return `<div class="sub-row"><div class="sub-num">${i+1}</div>
      <div style="flex:1;"><div style="font-size:12px;font-weight:600;margin-bottom:1px;">${s.name}</div><div style="font-size:10px;color:var(--muted);">${cached}/${total} topics ready</div></div>
      <div><div class="bar-track"><div class="bar-fill ${s.f}" style="width:${pct}%"></div></div><div style="font-size:10px;color:var(--muted);font-family:var(--fm);">${pct}%</div></div>
    </div>`;
  }).join('');
}

// ══════════════════════════════════
// MOCK BAR
// ══════════════════════════════════
function toggleMockSubj(el){
  if(el.dataset.key==='all'){document.querySelectorAll('.mc-subj-tag').forEach(t=>t.classList.remove('on'));el.classList.add('on');return;}
  document.querySelector('.mc-subj-tag[data-key="all"]').classList.remove('on');
  el.classList.toggle('on');
  if(!document.querySelector('.mc-subj-tag.on'))document.querySelector('.mc-subj-tag[data-key="all"]').classList.add('on');
}

// ══════════════════════════════════
// MOCK BAR SETUP PANEL
// ══════════════════════════════════
function initMockBarSetup(preselectedSubj) {
  // Reset to default state
  mbCount = 20; mbTimeMins = 0; mbDifficulty = 'balanced';
  // Restore panel HTML if it was replaced by locked message
  const cfg = document.getElementById('mockConfig');
  if (cfg && !document.getElementById('mbSetupHeader')) location.reload(); // edge case: panel was destroyed
  // Preset buttons
  document.querySelectorAll('#mbCountRow .mb-preset-btn').forEach(b => b.classList.toggle('active', parseInt(b.dataset.count)===20));
  document.getElementById('mbCustomCount').style.display = 'none';
  document.querySelectorAll('[data-min]').forEach(b => b.classList.toggle('active', parseInt(b.dataset.min)===0));
  document.querySelectorAll('[data-diff]').forEach(b => b.classList.toggle('active', b.dataset.diff==='balanced'));
  // Source checkboxes
  document.getElementById('mbSrcPastBar').checked = true;
  document.getElementById('mbSrcPreGen').checked  = true;
  document.getElementById('mbSrcAI').checked      = false;
  // Subject filter
  const subjectCard = document.getElementById('mbSubjectFilterCard');
  if (preselectedSubj && preselectedSubj !== 'all') {
    // Pre-select specific subject, hide "All" filter card (not needed)
    subjectCard.style.display = 'none';
    // Store selection in data attr
    subjectCard.dataset.forcedSubj = preselectedSubj;
    // Update header
    const subjName = ALL_SUBJS.find(s=>s.key===preselectedSubj)?.name || preselectedSubj;
    document.getElementById('mbSetupHeader').innerHTML = `
      <div style="font-size:24px;margin-bottom:8px;">⏱</div>
      <h2 style="font-family:var(--fd);font-size:26px;font-weight:700;color:var(--gold-l);margin-bottom:8px;">${h(subjName)} — Mock Bar</h2>
      <p style="font-size:13px;color:var(--muted);">Practice questions filtered to ${h(subjName)}.</p>`;
    // Show topic filter for single subject
    updateTopicFilter(preselectedSubj);
  } else {
    subjectCard.style.display = 'block';
    subjectCard.dataset.forcedSubj = '';
    // Select All
    document.querySelectorAll('#mbSubjectTags .mb-subj-tag').forEach(t => t.classList.remove('on'));
    document.querySelector('#mbSubjectTags [data-key="all"]').classList.add('on');
    document.getElementById('mbTopicFilter').style.display = 'none';
    document.getElementById('mbSetupHeader').innerHTML = `
      <div style="font-size:28px;margin-bottom:8px;">⏱🏛</div>
      <h2 style="font-family:var(--fd);font-size:28px;font-weight:700;color:var(--gold-l);margin-bottom:8px;">Mock <em>Bar Examination</em></h2>
      <p style="font-size:13px;color:var(--muted);line-height:1.65;max-width:640px;">Simulate the Philippine Bar Exam. Questions drawn from your uploaded past bar materials and pre-generated question bank.</p>`;
  }
  updateMockBarPreview();
  // Show config panel
  if (cfg) { cfg.style.display=''; }
  document.getElementById('mockSession').classList.remove('on');
  document.getElementById('mockResults').style.display = 'none';
}

function setMbCount(n, btn) {
  document.querySelectorAll('#mbCountRow .mb-preset-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const custom = document.getElementById('mbCustomCount');
  if (n === 0) { custom.style.display='block'; mbCount = parseInt(custom.value)||10; }
  else { custom.style.display='none'; mbCount = n; }
  updateMockBarPreview();
}
function setMbTime(mins, btn) {
  document.querySelectorAll('[data-min]').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  mbTimeMins = mins;
}
function setMbDiff(diff, btn) {
  document.querySelectorAll('[data-diff]').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  mbDifficulty = diff;
}
function toggleMbSubj(btn) {
  const key = btn.dataset.key;
  if (key === 'all') {
    document.querySelectorAll('#mbSubjectTags .mb-subj-tag').forEach(b => b.classList.remove('on'));
    btn.classList.add('on');
    document.getElementById('mbTopicFilter').style.display = 'none';
  } else {
    document.querySelector('#mbSubjectTags [data-key="all"]').classList.remove('on');
    btn.classList.toggle('on');
    const sel = Array.from(document.querySelectorAll('#mbSubjectTags .mb-subj-tag.on')).filter(b=>b.dataset.key!=='all');
    if (sel.length === 0) {
      document.querySelector('#mbSubjectTags [data-key="all"]').classList.add('on');
      document.getElementById('mbTopicFilter').style.display = 'none';
    } else if (sel.length === 1) {
      updateTopicFilter(sel[0].dataset.key);
    } else {
      document.getElementById('mbTopicFilter').style.display = 'none';
    }
  }
  updateMockBarPreview();
}
function updateTopicFilter(subj) {
  const card = document.getElementById('mbTopicFilter');
  const sylSubj = (KB.syllabusTopics||[]).find(s => s.key === subj);
  if (!sylSubj || !sylSubj.topics?.length) { card.style.display='none'; return; }
  card.style.display = 'block';
  document.getElementById('mbTopicCheckboxes').innerHTML = sylSubj.topics.map(t =>
    `<label style="display:flex;align-items:center;gap:7px;font-size:12px;color:rgba(248,246,241,.75);cursor:pointer;padding:3px 0;">
      <input type="checkbox" class="mb-source-check mb-topic-chk" value="${h(t.name)}" checked onchange="updateMockBarPreview()">
      ${h(t.name)}
    </label>`).join('');
}
function setAllMbTopics(checked) {
  document.querySelectorAll('.mb-topic-chk').forEach(c => { c.checked = checked; });
  updateMockBarPreview();
}

function getMbSubjects() {
  const card = document.getElementById('mbSubjectFilterCard');
  const forced = card?.dataset?.forcedSubj;
  if (forced) return [forced];
  const allOn = document.querySelector('#mbSubjectTags [data-key="all"]')?.classList.contains('on');
  if (allOn) return ['all'];
  return Array.from(document.querySelectorAll('#mbSubjectTags .mb-subj-tag.on')).map(b => b.dataset.key);
}
function getMbTopics() {
  return Array.from(document.querySelectorAll('.mb-topic-chk:checked')).map(c => c.value);
}

function updateMockBarPreview() {
  const el = document.getElementById('mbPreview');
  if (!el) return;
  const subjects = getMbSubjects();
  const usePastBar = document.getElementById('mbSrcPastBar')?.checked;
  const usePreGen  = document.getElementById('mbSrcPreGen')?.checked;
  const useAI      = document.getElementById('mbSrcAI')?.checked;
  const topics     = getMbTopics();
  // Count available
  let pbCount = 0;
  if (usePastBar) {
    KB.pastBar?.forEach(pb => {
      const match = subjects.includes('all') || subjects.includes(pb.subject);
      if (match) pbCount += pb.qCount || 0;
    });
  }
  let pgCount = 0;
  if (usePreGen) {
    const targetSubjs = subjects.includes('all') ? Object.keys(CACHE) : subjects;
    targetSubjs.forEach(subj => {
      Object.entries(CACHE[subj]||{}).forEach(([topicName, data]) => {
        if (topics.length > 0 && !topics.includes(topicName)) return;
        pgCount += data.essay?.questions?.length || 0;
      });
    });
  }
  const pool = pbCount + pgCount;
  const custom = parseInt(document.getElementById('mbCustomCount')?.value)||0;
  const actualCount = document.querySelector('#mbCountRow .mb-preset-btn[data-count="0"]')?.classList.contains('active') ? custom||10 : mbCount;

  // Update source count badges
  const pbBadge = document.getElementById('mbCountPastBar');
  const pgBadge = document.getElementById('mbCountPreGen');
  if (pbBadge) pbBadge.textContent = pbCount + ' available';
  if (pgBadge) pgBadge.textContent = pgCount + ' available';

  let preview = `Will draw from: ${pbCount} past bar Q${pbCount!==1?'s':''}, ${pgCount} pre-gen Q${pgCount!==1?'s':''}`;
  if (useAI) preview += ', AI fill: on';
  else {
    if (pool < actualCount) preview += `. ⚠️ Only ${pool} Q${pool!==1?'s':''} available — count will be clamped`;
  }
  preview += `.`;
  el.textContent = preview;
}

async function startMockBar(){
  const customInput = document.getElementById('mbCustomCount');
  const isCustom = document.querySelector('#mbCountRow .mb-preset-btn[data-count="0"]')?.classList.contains('active');
  const count = isCustom ? (parseInt(customInput?.value)||10) : mbCount;
  const timeMin = mbTimeMins;
  const subjects = getMbSubjects();
  const topics   = getMbTopics();
  const sources = {
    pastBar:    document.getElementById('mbSrcPastBar')?.checked !== false,
    preGen:     document.getElementById('mbSrcPreGen')?.checked  !== false,
    aiGenerate: document.getElementById('mbSrcAI')?.checked      === true,
  };
  console.log('Starting mock bar:', {count, subjects, topics, sources, mbDifficulty});
  mockSubjectsUsed = subjects; mockSessionDate = new Date(); mockScores = []; window.mockStartTime = Date.now();
  const btn = document.getElementById('startMockBtn');
  btn.disabled=true; btn.textContent='⏳ Building question set…';
  document.getElementById('mockStartError').style.display='none';
  document.getElementById('mbWarnBanner').style.display='none';
  try{
    const r = await fetch('/api/mockbar/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({subjects,count,sources,topics,difficulty:mbDifficulty})});
    const data = await r.json(); if(data.error) throw new Error(data.error);
    // Show warning if pool was too small
    if (data.warning) {
      const wb = document.getElementById('mbWarnBanner');
      if (wb) { wb.textContent = data.warning; wb.style.display='block'; }
    }
    console.log('Questions received:',data.questions?.length,'requested:',count);
    mockQs=data.questions; mockIdx=0; mockAnswers=Array(mockQs.length).fill('');
    document.getElementById('mockConfig').style.display='none';
    document.getElementById('mockResults').style.display='none';
    document.getElementById('mockSession').classList.add('on');
    document.getElementById('ms-of').textContent=`of ${mockQs.length}`;
    document.getElementById('qMarkers').innerHTML=mockQs.map((_,i)=>`<div class="q-marker" id="qm${i}" onclick="jumpMock(${i})">${i+1}</div>`).join('');
    if(timeMin>0){mockLeft=timeMin*60;document.getElementById('ms-timer').style.display='flex';runTimer();}
    else document.getElementById('ms-timer').style.display='none';
    renderMockQ();
    mockSessions++; updateDash();
  }catch(err){
    const errEl=document.getElementById('mockStartError');
    errEl.textContent='⚠️ '+err.message; errEl.style.display='block';
  }
  btn.disabled=false; btn.textContent='🚀 Begin Mock Bar';
}

// Shared session launcher — used by both startMockBar and startSubjectMockBar
function startMockSession(questions, timeMin) {
  if (!questions?.length) { alert('No questions available. Upload reference materials for this subject in Admin.'); return; }
  mockQs = questions; mockIdx = 0; mockAnswers = Array(mockQs.length).fill('');
  mockScores = []; mockSubjectsUsed = []; mockSessionDate = new Date().toISOString();
  // Navigate to the mock bar page to show the session UI
  showPage('mockbar');
  clearSidebarActive();
  document.getElementById('mockConfig').style.display = 'none';
  document.getElementById('mockResults').style.display = 'none';
  document.getElementById('mockSession').classList.add('on');
  document.getElementById('ms-of').textContent = `of ${mockQs.length}`;
  document.getElementById('qMarkers').innerHTML = mockQs.map((_,i) => `<div class="q-marker" id="qm${i}" onclick="jumpMock(${i})">${i+1}</div>`).join('');
  if (timeMin > 0) { mockLeft = timeMin * 60; document.getElementById('ms-timer').style.display = 'flex'; runTimer(); }
  else document.getElementById('ms-timer').style.display = 'none';
  renderMockQ();
  mockSessions++; updateDash();
}

function runTimer(){
  if(mockTimer)clearInterval(mockTimer);
  mockTimer=setInterval(()=>{
    mockLeft--;
    const m=Math.floor(mockLeft/60),s=mockLeft%60;
    document.getElementById('timer-val').textContent=`${m}:${s.toString().padStart(2,'0')}`;
    document.getElementById('ms-timer').classList.toggle('warn',mockLeft<=300);
    if(mockLeft<=0){clearInterval(mockTimer);endMockSession();}
  },1000);
}

function renderMockQ(){
  const q=mockQs[mockIdx];if(!q)return;
  document.getElementById('ms-qnum').textContent=`Question ${mockIdx+1}`;
  document.getElementById('ms-prog').style.width=`${((mockIdx+1)/mockQs.length)*100}%`;
  const sub=SUBJS.find(s=>s.key===q.subject)||{name:q.subject,cls:'sg-gen'};
  document.getElementById('ms-src').innerHTML=q.isReal
    ?`<span class="ms-source">📜 ${h(q.pastBarName||q.source||'Past Bar')}${q.year?' · '+h(q.year):''}</span>`
    :q.source==='Pre-generated'
      ?`<span class="ms-source">📚 Pre-generated</span>`
      :`<span class="ms-source">🤖 AI Generated</span>`;
  document.querySelectorAll('.q-marker').forEach((m,i)=>{
    m.className='q-marker'+(mockAnswers[i]?.trim()?' done':'')+(i===mockIdx?' current':'');
  });
  const qText = q.prompt || q.q || '';
  const isSituational = (q.type === 'situational') && q.context && q.context.trim();
  document.getElementById('mockQArea').innerHTML=`
    <div style="display:flex;gap:7px;margin-bottom:18px;flex-wrap:wrap;"><span class="sbg ${sub.cls}">${h(sub.name)}</span><span class="tag tg-e">Bar Essay</span></div>
    ${isSituational
      ? `<div class="facts-box"><div class="facts-label">📋 Facts</div><div class="facts-text">${h(q.context)}</div></div>
         <div class="question-label">❓ Question</div>
         <div class="question-text">${h(qText)}</div>`
      : `<div class="question-text" style="font-size:17px;">${h(qText)}</div>`
    }
    <div style="font-size:11px;color:var(--muted);margin:8px 0 10px;">Write a complete bar exam answer. Navigate freely between questions before submitting.</div>
    <textarea class="essay-box" id="mockBox" style="min-height:220px;" placeholder="Write your answer…" oninput="saveMock()">${h(mockAnswers[mockIdx]||'')}</textarea>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;">
      <button class="btn-ghost" onclick="moveMock(-1)" ${mockIdx===0?'disabled':''}>← Prev</button>
      <span style="font-size:12px;color:var(--muted);font-family:var(--fm);">${mockAnswers.filter(a=>a?.trim()).length}/${mockQs.length} answered</span>
      ${mockIdx<mockQs.length-1?`<button class="btn-gold" onclick="moveMock(1)">Next →</button>`:`<button class="btn-mock" onclick="endMockSession()">Submit All &amp; Score</button>`}
    </div>`;
}
function saveMock(){mockAnswers[mockIdx]=document.getElementById('mockBox')?.value||'';}
function moveMock(d){saveMock();mockIdx=Math.max(0,Math.min(mockQs.length-1,mockIdx+d));renderMockQ();}
function jumpMock(i){saveMock();mockIdx=i;renderMockQ();}

async function endMockSession(){
  saveMock();if(mockTimer)clearInterval(mockTimer);
  document.getElementById('mockSession').classList.remove('on');
  const answered=mockAnswers.filter(a=>a?.trim()).length;
  const res=document.getElementById('mockResults');
  res.style.display='block';
  res.innerHTML=`<div class="mock-results"><div style="font-size:40px;margin-bottom:10px;">⏳</div><div style="font-family:var(--fd);font-size:22px;color:var(--gold-l);">Scoring ${answered} answers…</div><div style="font-size:13px;color:var(--muted);">AI is evaluating each answer. This may take a moment.</div></div>`;

  const scores=[];
  for(let i=0;i<mockQs.length;i++){
    const q=mockQs[i],ans=mockAnswers[i]||'';
    if(!ans.trim()){scores.push({score:'0/10',numericScore:0,grade:'Not Answered',overallFeedback:'No answer provided.',keyMissed:[]});continue;}
    try{
      const r=await fetch('/api/evaluate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:q.prompt||q.q,answer:ans,modelAnswer:q.modelAnswer,keyPoints:q.keyPoints,subject:q.subject})});
      scores.push(await r.json());
    }catch(e){scores.push({score:'?/10',numericScore:0,grade:'Error',overallFeedback:e.message,keyMissed:[]});}
  }

  mockScores=scores;
  const total=scores.reduce((a,s)=>a+(s.numericScore||0),0);
  const avg=scores.length?Math.round(total/scores.length*10)/10:0;
  const pct=Math.round(avg/10*100);
  totalQDone+=answered;totalCorrect+=Math.round(pct/100*answered);updateDash();
  saveMockBarResults(scores.map((s,i)=>({q:(mockQs[i]?.prompt||mockQs[i]?.q||'').slice(0,120),score:s.numericScore||0,max:10})));

  // Pre-fill email modal subject
  const emailSubj=`BarBuddy Mock Bar Results — ${new Date().toLocaleDateString('en-PH')} — ${avg}/10`;
  document.getElementById('email-subject').value=emailSubj;

  res.innerHTML=`<div class="mock-results">
    ${currentUser?`<div style="font-size:12px;color:var(--muted);background:rgba(201,168,76,.07);border:1px solid rgba(201,168,76,.18);border-radius:9px;padding:8px 14px;margin-bottom:14px;text-align:left;">🎓 <strong style="color:var(--gold-l);">${h(currentUser.name)}</strong> &nbsp;·&nbsp; ${new Date().toLocaleDateString('en-PH')}</div>`:''}
    <div style="font-size:32px;margin-bottom:8px;">🏛</div>
    <div style="font-family:var(--fd);font-size:20px;font-weight:700;color:#ff8c42;margin-bottom:4px;">Mock Bar Results</div>
    <div class="mr-grade">${avg}/10</div>
    <div style="font-size:16px;font-weight:700;color:${pct>=70?'#14b4a0':pct>=55?'#c9a84c':'#e07080'};margin-bottom:4px;">${pct}% — ${pct>=70?'✅ PASSED':pct>=55?'📖 Keep Studying':'❌ Needs More Review'}</div>
    <div style="font-size:12px;color:var(--muted);font-family:var(--fm);margin-bottom:18px;">Passing score: 7.0/10 (70%)</div>
    <div class="mr-stats">
      <div class="mr-stat"><div class="n">${answered}</div><div class="l">Answered</div></div>
      <div class="mr-stat"><div class="n">${mockQs.length-answered}</div><div class="l">Skipped</div></div>
      <div class="mr-stat"><div class="n">${avg}/10</div><div class="l">Avg Score</div></div>
      <div class="mr-stat"><div class="n">${pct}%</div><div class="l">Overall</div></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-bottom:22px;flex-wrap:wrap;">
      <button class="btn-mock" onclick="document.getElementById('mockConfig').style.display='block';res.style.display='none';">⏱ New Session</button>
      <button class="btn-ghost" onclick="nav('learn',document.getElementById('tab-learn'))">📖 Back to Learn</button>
      <button class="btn-ghost" onclick="printMockResults()">🖨️ Print</button>
      <button class="btn-ghost" onclick="openModal('emailOverlay')">📧 Email</button>
    </div>
    <h3 style="font-family:var(--fd);font-size:20px;font-weight:700;color:var(--gold-l);margin-bottom:14px;text-align:left;">📋 Question Review</h3>
    ${mockQs.map((q,i)=>{
      const s=scores[i],sub=SUBJS.find(x=>x.key===q.subject)||{name:q.subject,cls:'sg-gen'},ns=s.numericScore||0;
      const qText=q.prompt||q.q||'';
      const isSit=(q.type==='situational')&&q.context;
      const qBadgeCls=ns>=7?'qsb-high':ns>=5?'qsb-mid':'qsb-low';
      return `<div class="q-review-item">
        <div style="font-size:11px;color:#a08060;margin-bottom:5px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
          Q${i+1} · <span class="sbg ${sub.cls}">${sub.name}</span>
          ${q.isReal?`<span style="font-size:9px;">📜 ${h(q.pastBarName||'Past Bar')}</span>`:q.source==='Pre-generated'?'<span style="font-size:9px;color:var(--teal);">📚 Pre-gen</span>':'<span style="font-size:9px;">🤖 AI</span>'}
          <span class="q-score-badge ${s.grade==='Not Answered'?'qsb-low':qBadgeCls}" style="margin-left:auto;">${s.grade==='Not Answered'?'Not Answered':ns+'/10'}</span>
        </div>
        ${isSit
          ? `<div class="facts-box" style="margin-bottom:16px;">
               <div class="facts-label">📋 Facts</div>
               <div class="facts-text" style="font-size:15px;">${h(q.context)}</div>
             </div>
             <div class="question-label">❓ Question</div>
             <div class="question-text" style="font-size:14px;margin-bottom:10px;">${h(qText)}</div>`
          : `<div class="question-text" style="font-size:14px;margin-bottom:10px;">${h(qText)}</div>`
        }
        ${s.grade==='Not Answered'?'':`
        <div class="ai-fb show" style="margin-top:8px;">${renderEvalCard(s)}</div>`}
        <details style="margin-top:8px;"><summary style="cursor:pointer;color:var(--muted);font-size:12px;font-weight:600;">Your answer</summary>
          <div style="margin-top:6px;padding:10px;background:rgba(255,255,255,.03);border-radius:8px;font-size:12px;line-height:1.7;color:rgba(248,246,241,.8);">${h(mockAnswers[i]||'(no answer)')}</div>
        </details>
      </div>`;
    }).join('')}
  </div>`;
}

// ══════════════════════════════════
// MANUAL QUESTION UPLOAD
// ══════════════════════════════════
function toggleManualContext(){
  const isSit=document.querySelector('input[name="mn-type"]:checked')?.value==='situational';
  document.getElementById('mn-context-wrap').style.display=isSit?'block':'none';
}
function updateManualPreview(){
  const el=document.getElementById('mn-preview');
  if(!manualBatch.length){el.innerHTML='';return;}
  el.innerHTML=manualBatch.map((q,i)=>`
    <div class="mn-prev-item">
      <span style="font-weight:700;color:var(--gold);font-family:var(--fm);flex-shrink:0;">Q${i+1}</span>
      <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${h(q.q.slice(0,80))}${q.q.length>80?'…':''}</span>
      <button class="mn-rm" onclick="removeManualQ(${i})">✕</button>
    </div>`).join('');
}
function removeManualQ(i){
  manualBatch.splice(i,1);
  updateManualPreview();
}
function addManualQ(){
  const qText=document.getElementById('mn-q').value.trim();
  if(!qText){document.getElementById('mn-q').focus();document.getElementById('mn-status').innerHTML='<div style="color:#e07080;font-size:12px;padding:4px 0;">⚠️ Enter the question text first.</div>';return;}
  const type=document.querySelector('input[name="mn-type"]:checked')?.value||'situational';
  const context=type==='situational'?document.getElementById('mn-context').value.trim():'';
  const rawPoints=document.getElementById('mn-points').value.trim();
  const keyPoints=rawPoints?rawPoints.split('\n').map(l=>l.trim()).filter(Boolean):[];
  manualBatch.push({
    q:qText,
    context,
    modelAnswer:document.getElementById('mn-answer').value.trim(),
    keyPoints,
    type,
  });
  // Auto-increment number, clear question-specific fields
  manualQNum++;
  document.getElementById('mn-num').value=manualQNum;
  document.getElementById('mn-q').value='';
  document.getElementById('mn-context').value='';
  document.getElementById('mn-answer').value='';
  document.getElementById('mn-points').value='';
  document.getElementById('mn-status').innerHTML='';
  updateManualPreview();
}
function onMnSubjectChange(val) {
  const inp = document.getElementById('mn-name');
  if (!inp) return;
  inp.placeholder = val === 'custom'
    ? 'e.g. Midterm Exam — Special Topic (Manual)'
    : 'e.g. 2023 Bar — Civil Law (Manual)';
}

async function saveManualBatch(){
  if(!manualBatch.length){document.getElementById('mn-status').innerHTML='<div style="color:#e07080;font-size:12px;padding:4px 0;">⚠️ Add at least one question first.</div>';return;}
  const name=document.getElementById('mn-name').value.trim();
  if(!name){document.getElementById('mn-name').focus();document.getElementById('mn-status').innerHTML='<div style="color:#e07080;font-size:12px;padding:4px 0;">⚠️ Enter a batch name.</div>';return;}
  const subject=document.getElementById('mn-subject').value;
  const year=document.getElementById('mn-year').value.trim();
  const sta=document.getElementById('mn-status');
  sta.innerHTML='<div style="color:var(--gold-l);font-size:12px;padding:4px 0;">⏳ Saving…</div>';
  try{
    const r=await fetch('/api/admin/pastbar/manual',{method:'POST',headers:{'Content-Type':'application/json','x-admin-key':adminKey},body:JSON.stringify({name,subject,year,questions:manualBatch})});
    const d=await r.json();
    if(d.error)throw new Error(d.error);
    sta.innerHTML=`<div style="color:var(--teal);font-size:12px;padding:4px 0;">✅ Saved ${d.questionsAdded} question${d.questionsAdded===1?'':'s'} to Knowledge Base.</div>`;
    manualBatch=[];manualQNum=1;
    document.getElementById('mn-num').value=1;
    document.getElementById('mn-name').value='';
    updateManualPreview();
    await loadKB();refreshAdminKB();renderPastBarList();
  }catch(e){sta.innerHTML=`<div style="color:#e07080;font-size:12px;padding:4px 0;">⚠️ ${h(e.message)}</div>`;}
}

function renderPastBarList(){
  const el=document.getElementById('pb-list');if(!el)return;
  if(!KB.pastBar?.length){el.innerHTML=`<div style="font-size:13px;color:var(--muted);text-align:center;padding:12px 0;">No past bar materials uploaded yet.</div>`;return;}
  el.innerHTML=KB.pastBar.map(pb=>{
    const isCustom = pb.subject === 'custom';
    const sub = isCustom ? {cls:'sg-gen',name:'Custom Subject'} : (SUBJS.find(s=>s.key===pb.subject)||{cls:'sg-gen',name:pb.subject});
    const icon = isCustom ? '📁' : '📜';
    const badge = isCustom
      ? `<span class="sbg" style="background:rgba(136,153,170,.15);color:#8899aa;border:1px solid rgba(136,153,170,.3);">📁 Custom</span>`
      : `<span class="sbg ${sub.cls}">${h(sub.name)}</span>`;
    return `<div class="r-item" style="cursor:default;"><div class="r-ic">${icon}</div><div class="r-info"><div class="r-title">${h(pb.name)}</div><div class="r-sub">${pb.year} · ${pb.qCount} question${pb.qCount===1?'':'s'}</div></div>${badge}</div>`;
  }).join('');
}

// ══════════════════════════════════
// PRINT / EMAIL RESULTS
// ══════════════════════════════════
function buildResultsHtml(){
  const e=s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
  const dateStr=mockSessionDate?mockSessionDate.toLocaleString('en-PH'):new Date().toLocaleString('en-PH');
  const subjStr=(!mockSubjectsUsed.length||mockSubjectsUsed.includes('all'))?'All Subjects':mockSubjectsUsed.map(s=>SUBJS.find(x=>x.key===s)?.name||s).join(', ');
  const answered=mockAnswers.filter(a=>a?.trim()).length;
  const totalSc=mockScores.reduce((a,s)=>a+(s.numericScore||0),0);
  const avg=mockScores.length?Math.round(totalSc/mockScores.length*10)/10:0;
  const pct=Math.round(avg/10*100);
  const passColor=pct>=70?'#1a7a5e':pct>=55?'#8b6914':'#b32d2d';

  const alacTr=(label,c,max)=>c?`<tr><td style="padding:6px 8px;border:1px solid #d0b870;font-weight:600;">${label}</td><td style="padding:6px 8px;border:1px solid #d0b870;text-align:center;font-weight:bold;">${c.score!=null?c.score+'/'+max:'—'}</td><td style="padding:6px 8px;border:1px solid #d0b870;">${e(c.feedback||'')}</td></tr>`:'';

  const qHtml=mockQs.map((q,i)=>{
    const s=mockScores[i]||{};
    const sub=SUBJS.find(x=>x.key===q.subject)||{name:q.subject||'Unknown'};
    const qText=q.prompt||q.q||'';
    const ans=mockAnswers[i]||'';
    const al=s.alac||{};
    const isSit=(q.type==='situational')&&q.context;
    const pageBreak=i<mockQs.length-1?'page-break-after:always;':'';
    return `<div style="padding:22px 0;${pageBreak}${i>0?'border-top:1px solid #e0d0a0;':''}">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
        <span style="font-size:17px;font-weight:bold;color:#7a6128;">Q${i+1}</span>
        <span style="background:#eee;border-radius:4px;padding:2px 8px;font-size:12px;color:#333;">${e(sub.name)}</span>
        <span style="color:#666;font-size:12px;">${q.isReal?'📜 Past Bar '+(q.year||q.source||''):q.source==='Pre-generated'?'📚 Pre-generated':'🤖 AI Generated'}</span>
      </div>
      ${isSit?`<div style="background:#f0f4ff;border-left:3px solid #3a5abf;padding:10px 14px;margin-bottom:12px;border-radius:4px;"><div style="font-size:10px;font-weight:bold;text-transform:uppercase;letter-spacing:.08em;color:#3a5abf;margin-bottom:5px;">FACTS</div><div style="font-size:13px;line-height:1.7;">${e(q.context)}</div></div>`:''}
      <div style="font-size:14px;font-weight:bold;line-height:1.7;margin-bottom:14px;">${e(qText)}</div>
      ${ans.trim()?`
      <div style="font-size:10px;font-weight:bold;text-transform:uppercase;letter-spacing:.08em;color:#7a6128;margin:12px 0 5px;">ALAC SCORECARD</div>
      <table style="width:100%;border-collapse:collapse;font-size:12px;margin-bottom:12px;">
        <tr style="background:#f5efe0;"><th style="text-align:left;padding:6px 8px;border:1px solid #d0b870;font-size:11px;">Component</th><th style="padding:6px 8px;border:1px solid #d0b870;font-size:11px;">Score</th><th style="text-align:left;padding:6px 8px;border:1px solid #d0b870;font-size:11px;">Feedback</th></tr>
        ${alacTr('A — Answer',al.answer,1.5)}
        ${alacTr('L — Legal Basis',al.legalBasis,3.0)}
        ${alacTr('A — Application',al.application,4.0)}
        ${alacTr('C — Conclusion',al.conclusion,1.5)}
        <tr style="background:#faf5e0;"><td colspan="2" style="padding:7px 8px;border:1px solid #d0b870;font-weight:bold;">TOTAL: ${e(s.score||'?/10')} — ${e(s.grade||'')}</td><td style="padding:7px 8px;border:1px solid #d0b870;font-size:12px;">${e(s.overallFeedback||'')}</td></tr>
      </table>
      ${s.keyMissed?.length?`<div style="font-size:10px;font-weight:bold;text-transform:uppercase;letter-spacing:.08em;color:#7a6128;margin:12px 0 5px;">KEY POINTS MISSED</div><ul style="margin:4px 0 12px 20px;font-size:13px;">${s.keyMissed.map(k=>`<li>${e(k)}</li>`).join('')}</ul>`:''}
      <div style="font-size:10px;font-weight:bold;text-transform:uppercase;letter-spacing:.08em;color:#7a6128;margin:12px 0 5px;">STUDENT ANSWER</div>
      <div style="background:#f9f9f9;border:1px solid #ddd;border-radius:4px;padding:10px 14px;font-size:13px;line-height:1.7;margin-bottom:10px;">${e(ans)}</div>
      <div style="font-size:10px;font-weight:bold;text-transform:uppercase;letter-spacing:.08em;color:#7a6128;margin:12px 0 5px;">MODEL ANSWER</div>
      <div style="background:#f0f8f0;border:1px solid #b0d8b0;border-radius:4px;padding:10px 14px;font-size:13px;line-height:1.7;">${e(s.modelAnswer||'—')}</div>
      `:'<div style="color:#999;font-style:italic;font-size:13px;margin:8px 0;">— Not Answered —</div>'}
    </div>`;
  }).join('');

  return `<div style="font-family:Georgia,serif;color:#111;max-width:800px;margin:0 auto;padding:20px;">
    <h1 style="font-size:22px;color:#7a6128;border-bottom:2px solid #7a6128;padding-bottom:8px;margin-bottom:8px;">BarBuddy — Mock Bar Examination Results</h1>
    <div style="font-size:13px;color:#333;margin-bottom:14px;line-height:2;">
      <div><strong>Date:</strong> ${e(dateStr)}</div>
      <div><strong>Subject:</strong> ${e(subjStr)}</div>
      <div><strong>Questions:</strong> ${answered} answered / ${mockQs.length} total</div>
    </div>
    <div style="font-size:20px;font-weight:bold;color:${passColor};margin:10px 0 5px;">Overall Score: ${avg}/10 — ${pct>=70?'✅ PASSED':pct>=55?'📖 KEEP STUDYING':'❌ NEEDS MORE REVIEW'}</div>
    <div style="font-size:12px;color:#888;margin-bottom:20px;">Passing score: 7.0/10 (70%)</div>
    ${qHtml}
    <div style="margin-top:30px;padding-top:12px;border-top:1px solid #ccc;font-size:11px;color:#666;text-align:center;">Generated by BarBuddy — Philippine Bar Exam Companion</div>
  </div>`;
}

function printMockResults(){
  if(!mockQs.length)return;
  const body=buildResultsHtml();
  const w=window.open('','_blank');
  if(!w){alert('Pop-up blocked. Please allow pop-ups to print results.');return;}
  w.document.write(`<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>BarBuddy Results</title><style>@media print{@page{margin:1.5cm;}}</style></head><body>${body}</body></html>`);
  w.document.close();w.focus();
  setTimeout(()=>w.print(),600);
}

async function sendEmailResults(){
  const to=document.getElementById('email-to').value.trim();
  const subject=document.getElementById('email-subject').value.trim();
  const sta=document.getElementById('email-status');
  const btn=document.getElementById('emailSendBtn');
  if(!to){sta.style.display='block';sta.style.background='rgba(155,35,53,.15)';sta.style.color='#e07080';sta.textContent='⚠️ Enter an email address.';return;}
  btn.disabled=true;btn.textContent='⏳ Sending…';
  sta.style.display='block';sta.style.background='rgba(201,168,76,.1)';sta.style.color='var(--gold-l)';sta.textContent='Sending…';
  try{
    const r=await fetch('/api/email-results',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to,subject,htmlBody:buildResultsHtml()})});
    const d=await r.json();
    if(d.error){
      sta.style.background='rgba(155,35,53,.15)';sta.style.color='#e07080';
      sta.innerHTML=`⚠️ ${h(d.error)}${d.error.includes('not configured')?'<br><small style="display:block;margin-top:5px;opacity:.8;">Go to Railway → Variables → add EMAIL_USER and EMAIL_PASS (Gmail app password).</small>':''}`;
    }else{
      sta.style.background='rgba(20,180,160,.1)';sta.style.color='var(--teal)';
      sta.textContent=`✅ Results sent to ${to}`;
    }
  }catch(err){sta.style.background='rgba(155,35,53,.15)';sta.style.color='#e07080';sta.textContent='⚠️ '+err.message;}
  btn.disabled=false;btn.textContent='📧 Send Results';
}

// ══════════════════════════════════
// ADMIN
// ══════════════════════════════════
// ══════════════════════════════════
// TAB ACCESS CONTROL
// ══════════════════════════════════
let pendingTabSettings = null;

function getDefaultTabSettings() {
  return {
    overview: true,
    subjects: {
      civil:      { learn: true, quiz: true, mockbar: true },
      criminal:   { learn: true, quiz: true, mockbar: true },
      political:  { learn: true, quiz: true, mockbar: true },
      labor:      { learn: true, quiz: true, mockbar: true },
      commercial: { learn: true, quiz: true, mockbar: true },
      taxation:   { learn: true, quiz: true, mockbar: true },
      remedial:   { learn: true, quiz: true, mockbar: true },
      ethics:     { learn: true, quiz: true, mockbar: true },
      custom:     { mockbar: true },
    },
  };
}

async function applyTabSettings() {
  try {
    const r = await fetch('/api/tab-settings');
    const settings = await r.json();
    window.TAB_SETTINGS = settings;
    const isAdmin = !!adminKey;
    // Update sidebar subject rows — dim if all modes disabled, show lock icon
    SUBJS.forEach(s => {
      const subjEl = document.getElementById(`sb-subj-${s.key}`);
      if (!subjEl) return;
      const allModes = ['learn','quiz','mockbar'];
      const allDisabled = allModes.every(m => settings.subjects?.[s.key]?.[m] === false);
      const anyDisabled = allModes.some(m => settings.subjects?.[s.key]?.[m] === false);
      if (!isAdmin && allDisabled) {
        subjEl.style.display = 'none';
      } else {
        subjEl.style.display = '';
        subjEl.style.opacity = allDisabled ? '0.35' : '';
      }
      const lockEl = subjEl.querySelector('.sb-lock-icon');
      if (lockEl) lockEl.style.display = allDisabled ? '' : 'none';
      // Partial label
      let partialEl = subjEl.querySelector('.sb-partial-label');
      if (anyDisabled && !allDisabled && isAdmin) {
        if (!partialEl) {
          partialEl = document.createElement('span');
          partialEl.className = 'sb-partial-label';
          partialEl.style.cssText = 'font-size:9px;opacity:.5;margin-left:4px;color:var(--muted);flex-shrink:0;';
          partialEl.textContent = '(partial)';
          subjEl.appendChild(partialEl);
        }
      } else if (partialEl) {
        partialEl.remove();
      }
    });
    // Custom subject
    const customEl = document.getElementById('sb-subj-custom');
    if (customEl) {
      const cEnabled = settings.subjects?.custom?.mockbar !== false;
      if (!isAdmin && !cEnabled) customEl.style.display = 'none';
      else { customEl.style.display = ''; customEl.style.opacity = cEnabled ? '' : '0.35'; }
    }
    // If currently on subject page, refresh its tab bar to reflect new permissions
    if (currentSubject && document.querySelector('#page-subject.on')) {
      renderSubjectTabs(currentSubject, currentMode || 'learn');
      // If current tab just got disabled, auto-switch
      if (settings.subjects?.[currentSubject]?.[currentMode] === false) {
        const first = ['learn','quiz','mockbar'].find(m => settings.subjects?.[currentSubject]?.[m] !== false);
        if (first) switchSubjectTab(currentSubject, first);
      }
    }
    updateAccessControlBadge();
  } catch(e) { console.warn('Tab settings load failed:', e.message); }
}

function initTabControls() {
  if (window.TAB_SETTINGS) {
    pendingTabSettings = JSON.parse(JSON.stringify(window.TAB_SETTINGS));
  } else {
    pendingTabSettings = getDefaultTabSettings();
  }
  renderTabControls();
}

function renderTabControls() {
  const container = document.getElementById('tabToggleList');
  if (!container) return;
  const s = pendingTabSettings || getDefaultTabSettings();
  const modeLabels = { learn: '📖 Learn', quiz: '✏️ Quiz', mockbar: '⏱ Mock Bar' };
  let html = '';
  // Global shortcuts
  html += `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;">
    <button class="tab-global-btn" onclick="setAllTabs(true)">✅ Enable All</button>
    <button class="tab-global-btn" onclick="setAllTabs(false)">🔒 Disable All</button>
    <button class="tab-global-btn" onclick="setAllOfMode('learn',false)">Hide All Learn</button>
    <button class="tab-global-btn" onclick="setAllOfMode('quiz',false)">Hide All Quiz</button>
    <button class="tab-global-btn" onclick="setAllOfMode('mockbar',false)">Hide All Mock Bar</button>
    <button class="tab-global-btn" style="margin-left:auto;color:var(--muted);" onclick="resetTabSettings()">↺ Reset Defaults</button>
  </div>`;
  // Per-subject rows
  SUBJS.forEach(subj => {
    const ss = s.subjects?.[subj.key] || {};
    html += `<div class="tab-ctrl-subject-header">
      <span class="tab-ctrl-subject-dot" style="background:${subj.color};"></span>
      <span style="font-size:13px;font-weight:600;">${subj.name}</span>
    </div>
    <div style="padding-left:16px;margin-bottom:12px;">`;
    ['learn','quiz','mockbar'].forEach(mode => {
      const on = ss[mode] !== false;
      html += `<div class="tab-ctrl-row">
        <span style="font-size:12px;min-width:90px;color:var(--muted);">${modeLabels[mode]}</span>
        <div class="tab-ctrl-btns">
          <button class="tct-on${on?' tct-active':''}" onclick="setTabSetting('${subj.key}','${mode}',true)">ON</button>
          <button class="tct-off${!on?' tct-active':''}" onclick="setTabSetting('${subj.key}','${mode}',false)">OFF</button>
        </div>
      </div>`;
    });
    html += `</div>`;
  });
  // Custom Subject — mockbar only
  const cOn = s.subjects?.custom?.mockbar !== false;
  html += `<div class="tab-ctrl-subject-header">
    <span class="tab-ctrl-subject-dot" style="background:#8899aa;"></span>
    <span style="font-size:13px;font-weight:600;">Custom Subject</span>
  </div>
  <div style="padding-left:16px;margin-bottom:12px;">
    <div class="tab-ctrl-row">
      <span style="font-size:12px;min-width:90px;color:var(--muted);">⏱ Mock Bar</span>
      <div class="tab-ctrl-btns">
        <button class="tct-on${cOn?' tct-active':''}" onclick="setTabSetting('custom','mockbar',true)">ON</button>
        <button class="tct-off${!cOn?' tct-active':''}" onclick="setTabSetting('custom','mockbar',false)">OFF</button>
      </div>
    </div>
  </div>`;
  container.innerHTML = html;
}

function setTabSetting(subject, mode, value) {
  if (!pendingTabSettings) pendingTabSettings = getDefaultTabSettings();
  if (!pendingTabSettings.subjects) pendingTabSettings.subjects = {};
  if (!pendingTabSettings.subjects[subject]) pendingTabSettings.subjects[subject] = {};
  pendingTabSettings.subjects[subject][mode] = value;
  renderTabControls();
}

function setAllTabs(value) {
  if (!pendingTabSettings) pendingTabSettings = getDefaultTabSettings();
  SUBJS.forEach(s => {
    if (!pendingTabSettings.subjects[s.key]) pendingTabSettings.subjects[s.key] = {};
    ['learn','quiz','mockbar'].forEach(m => { pendingTabSettings.subjects[s.key][m] = value; });
  });
  if (!pendingTabSettings.subjects.custom) pendingTabSettings.subjects.custom = {};
  pendingTabSettings.subjects.custom.mockbar = value;
  renderTabControls();
}

function setAllOfMode(mode, value) {
  if (!pendingTabSettings) pendingTabSettings = getDefaultTabSettings();
  SUBJS.forEach(s => {
    if (!pendingTabSettings.subjects[s.key]) pendingTabSettings.subjects[s.key] = {};
    pendingTabSettings.subjects[s.key][mode] = value;
  });
  renderTabControls();
}

async function saveTabSettings() {
  const btn = document.getElementById('saveTabBtn');
  btn.disabled = true; btn.textContent = '⏳ Saving…';
  try {
    const r = await fetch('/api/admin/tab-settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-admin-key': adminKey },
      body: JSON.stringify(pendingTabSettings)
    });
    const d = await r.json();
    if (d.error) throw new Error(d.error);
    window.TAB_SETTINGS = JSON.parse(JSON.stringify(pendingTabSettings));
    await applyTabSettings();
    btn.textContent = '✅ Saved!';
    setTimeout(() => { btn.disabled = false; btn.textContent = '💾 Save Access Settings'; }, 2000);
  } catch(e) { btn.textContent = '⚠️ ' + e.message; btn.disabled = false; }
}

function resetTabSettings() {
  if (!confirm('Reset all tab settings to defaults (everything enabled)?')) return;
  pendingTabSettings = getDefaultTabSettings();
  renderTabControls();
}

function updateAccessControlBadge() {
  const badge = document.getElementById('accessControlBadge');
  if (!badge) return;
  const s = window.TAB_SETTINGS;
  if (!s || !adminKey) { badge.style.display = 'none'; return; }
  const anyDisabled = SUBJS.some(subj =>
    ['learn','quiz','mockbar'].some(m => s.subjects?.[subj.key]?.[m] === false)
  ) || s.subjects?.custom?.mockbar === false;
  badge.style.display = anyDisabled ? '' : 'none';
}

function scrollToTabControl() {
  navToAdmin();
  setTimeout(() => {
    const el = document.getElementById('tabAccessControlPanel');
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 150);
}

// SUBJECT OVERVIEW GRID (admin)
// ══════════════════════════════════
function renderSubjectOverview() {
  const container = document.getElementById('subjOvGridContent');
  if (!container) return;
  const allSubjs = [...SUBJS, CUSTOM_SUBJ];
  container.innerHTML = allSubjs.map(s => {
    const isCustom = s.key === 'custom';
    const refs   = isCustom ? (KB.customRefs   || 0) : (KB.references?.filter(r=>r.subject===s.key).length || 0);
    const pbSets = isCustom ? (KB.customPastBar || 0) : (KB.pastBar?.filter(p=>p.subject===s.key).length || 0);
    const qs     = isCustom ? (KB.customQuestions || 0)
                            : (KB.pastBar?.filter(p=>p.subject===s.key).reduce((a,p)=>a+(p.qCount||0),0) || 0);
    const topics = isCustom ? 0 : (KB.syllabusTopics?.find(t=>t.key===s.key)?.topics?.length || 0);
    return `<div class="subj-ov-card">
      <div class="subj-ov-name">
        <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${s.color};margin-right:6px;flex-shrink:0;"></span>
        ${s.name}
      </div>
      <div class="subj-ov-stats">
        <span title="References">📄 ${refs} refs</span>
        <span title="Past Bar Sets">🗂 ${pbSets} sets</span>
        <span title="Past Bar Questions">❓ ${qs} Qs</span>
        ${!isCustom ? `<span title="Topics">📋 ${topics} topics</span>` : ''}
      </div>
      <div class="subj-ov-btns">
        <button class="subj-ov-btn" onclick="quickAddRef('${s.key}')">+ Reference</button>
        <button class="subj-ov-btn" onclick="quickAddPastBar('${s.key}')">+ Past Bar</button>
      </div>
    </div>`;
  }).join('');
}

function quickAddRef(subjKey) {
  // Scroll to reference upload panel and pre-select subject
  navToAdmin();
  setTimeout(() => {
    const el = document.getElementById('ref-subject');
    if (el) { el.value = subjKey; el.dispatchEvent(new Event('change')); }
    const panel = document.querySelector('.admin-card');
    if (panel) panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 150);
}

function quickAddPastBar(subjKey) {
  // Scroll to past bar upload panel and pre-select subject
  navToAdmin();
  setTimeout(() => {
    const el = document.getElementById('pb-subject');
    if (el) { el.value = subjKey; el.dispatchEvent(new Event('change')); }
    const panels = document.querySelectorAll('.admin-card');
    if (panels[1]) panels[1].scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 150);
}

async function unlockAdmin(){
  adminKey=document.getElementById('adminKeyInput').value.trim();
  if(!adminKey)return;
  window._adminKey=adminKey;
  document.getElementById('adminStatus').textContent='Checking…';
  try{
    await fetch('/api/kb');
    document.getElementById('adminLocked').style.display='none';
    document.getElementById('adminUnlocked').style.display='block';
    document.getElementById('adminStatus').textContent='✓ Unlocked';
    refreshAdminKB();updateSyllabusStatus();initTabControls();
    // Show admin sidebar button + subject overview
    const sbAdmin = document.getElementById('sb-admin');
    if (sbAdmin) sbAdmin.style.display = '';
    const sovGrid = document.getElementById('subjectOverviewGrid');
    if (sovGrid) { sovGrid.style.display = ''; renderSubjectOverview(); }
    // Show admin panels
    document.getElementById('adminUserPanel').style.display='block';
    document.getElementById('adminResultsPanel').style.display='block';
    loadAdminUsers();loadAdminResults();
    // Update registration toggle label
    fetch('/api/settings').then(r=>r.json()).then(s=>{
      const btn=document.getElementById('regToggleBtn');
      if(btn)btn.textContent=s.registrationOpen?'Close Registration':'Open Registration';
    }).catch(()=>{});
    // Show gen panel if running
    if(KB.genState?.running) document.getElementById('adminGenPanel').style.display='block';
    else if(KB.genState?.finishedAt) document.getElementById('adminGenDone').style.display='block';
  }catch(e){document.getElementById('adminStatus').textContent='Error: '+e.message;}
}

async function readFile(input,targetId){
  const f=input.files[0];if(!f)return;
  const ext=f.name.split('.').pop().toLowerCase();
  if(ext==='pdf'||ext==='doc'||ext==='docx'){
    const fd=new FormData();fd.append('file',f);
    const statusId=targetId.replace('-content','-status');
    const sta=document.getElementById(statusId);
    if(sta)sta.innerHTML=`<div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--gold-l);padding:8px;"><div class="spin" style="width:14px;height:14px;border-width:2px;"></div>Extracting text from ${ext.toUpperCase()}…</div>`;
    try{
      const r=await fetch('/api/admin/parse-file',{method:'POST',headers:{'x-admin-key':adminKey},body:fd});
      const d=await r.json();
      if(d.error)throw new Error(d.error);
      document.getElementById(targetId).value=d.text;
      if(sta)sta.innerHTML=`<div style="color:var(--teal);font-size:12px;padding:4px 8px;">✓ Extracted ${d.text.length.toLocaleString()} characters from ${h(f.name)}</div>`;
    }catch(e){
      if(sta)sta.innerHTML=`<div style="color:#e07080;font-size:13px;padding:8px;">⚠️ ${h(e.message)}</div>`;
    }
  }else{
    const r=new FileReader();r.onload=e=>document.getElementById(targetId).value=e.target.result;r.readAsText(f);
  }
}
function countLeafTopics(topics) {
  let n=0;
  function walk(items){(items||[]).forEach(t=>{if(!t.isGroup)n++;walk(t.subtopics);walk(t.children);});}
  walk(topics);return n;
}
function updateSyllabusStatus(){
  const el=document.getElementById('syllabusStatus');if(!el)return;
  if(KB.hasSyllabus){
    const n=(KB.syllabusTopics||[]).reduce((a,s)=>a+countLeafTopics(s.topics||[]),0);
    el.innerHTML=`<span style="color:var(--teal);">✓ ${h(KB.syllabusName||'Syllabus')} · ${KB.syllabusTopics?.length||0} subjects · ${n} topics</span>`;
  } else el.textContent='No syllabus uploaded yet.';
}

async function adminPost(url,body,status){
  const sta=document.getElementById(status);
  sta.innerHTML=`<div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--gold-l);padding:10px;"><div class="spin" style="width:16px;height:16px;border-width:2px;"></div>Processing…</div>`;
  const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','x-admin-key':adminKey},body:JSON.stringify(body)});
  return r.json();
}

async function uploadSyllabus(){
  const name=document.getElementById('syl-name').value.trim();
  const content=document.getElementById('syl-content').value.trim();
  if(!content){alert('Paste or upload syllabus content.');return;}
  try{
    const r=await adminPost('/api/admin/syllabus',{name,content},'syl-status');
    if(r.error){
      const staEl=document.getElementById('syl-status');
      let msg=h(r.error);
      if(r.raw){msg+=`<br><br><span style="color:rgba(248,246,241,.4);font-size:11px;">Claude returned: &ldquo;${h(r.raw)}&hellip;&rdquo;</span><br><span style="color:rgba(248,246,241,.4);font-size:11px;">Tip: Try uploading again. If this keeps happening, try breaking the syllabus into smaller sections by subject.</span>`;}
      staEl.innerHTML=`<div style="color:#e07080;font-size:13px;line-height:1.7;padding:12px;background:rgba(155,35,53,.1);border:1px solid rgba(155,35,53,.3);border-radius:10px;">⚠️ ${msg}</div>`;
      return;
    }
    document.getElementById('syl-status').innerHTML=`<div style="color:var(--teal);font-size:13px;padding:8px;">✅ Saved! ${r.subjects} subjects, ${r.totalTopics} topics. Pre-generating content now…</div>`;
    // Per-subject breakdown
    const bdEl=document.getElementById('syl-breakdown');
    if(bdEl && r.breakdown?.length){
      const clr={civil:'#4a9eff',criminal:'#e07080',political:'#50d090',labor:'#f0a040',commercial:'#a070e0',taxation:'#40c0b0',remedial:'#e0c050',ethics:'#c0a080',custom:'#8899aa'};
      const rows=r.breakdown.map(s=>`<div style="display:flex;align-items:center;gap:8px;padding:4px 0;font-size:12px;"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${clr[s.key]||'#888'};flex-shrink:0;"></span><span style="flex:1;color:rgba(248,246,241,.8);">${h(s.name)}</span><span style="color:var(--muted);font-family:var(--fm);">${s.topicCount} topics</span></div>`).join('');
      const unknownHtml=r.unknownTopics?.length?`<div style="margin-top:8px;padding:8px;background:rgba(155,35,53,.1);border-radius:6px;font-size:11px;color:#e07080;">⚠️ ${r.unknownTopics.length} unrecognized subject(s) skipped: ${r.unknownTopics.map(h).join(', ')}</div>`:'';
      // Warnings panel
      let warningsHtml = '';
      if (r.warnings?.length) {
        const items = r.warnings.map(w=>`<div class="sw-item">⚠ <strong>${h(w.topic)}</strong> is under <em>${h(w.assignedTo)}</em> but keywords suggest <em>${h(w.possiblyBelongsTo)}</em> (matched: ${w.matchedKeywords.map(h).join(', ')})</div>`).join('');
        warningsHtml = `<div class="syllabus-warnings" style="margin-top:10px;">
          <div class="sw-header" onclick="this.nextElementSibling.classList.toggle('open')">
            ⚠️ ${r.warningCount} topic assignment warning${r.warningCount>1?'s':''} — click to review
            <span style="margin-left:auto;font-size:10px;opacity:.6;">Topics kept as-is. Review if needed.</span>
          </div>
          <div class="sw-body">${items}</div>
        </div>`;
      }
      bdEl.innerHTML=`<div style="background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:12px 14px;"><div style="font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.06em;text-transform:uppercase;margin-bottom:8px;">Subjects Parsed</div>${rows}${unknownHtml}</div>${warningsHtml}`;
      bdEl.style.display='';
    }
    document.getElementById('adminGenPanel').style.display='block';
    document.getElementById('adminGenDone').style.display='none';
    await loadKB();updateSyllabusStatus();renderSyllabusTree();refreshSidebarDots();
  }catch(e){document.getElementById('syl-status').innerHTML=`<div style="color:#e07080;font-size:13px;padding:8px;">⚠️ ${h(e.message)}</div>`;}
}
function showRefGeneralWarning(val) {
  const el = document.getElementById('refGeneralWarning');
  if (el) el.style.display = val === 'general' ? '' : 'none';
}
function showPbGeneralWarning(val) {
  const el = document.getElementById('pbGeneralWarning');
  if (el) el.style.display = val === 'general' ? '' : 'none';
}

async function uploadReference(){
  const name=document.getElementById('ref-name').value.trim(),content=document.getElementById('ref-content').value.trim();
  const subject=document.getElementById('ref-subject').value,type=document.getElementById('ref-type').value;
  if(!name||!content){alert('Enter name and content.');return;}
  const sta=document.getElementById('ref-status');
  const spin=`<div class="spin" style="width:14px;height:14px;border-width:2px;flex-shrink:0;"></div>`;
  try{
    const r=await adminPost('/api/admin/reference',{name,subject,type,content},'ref-status');
    if(r.error)throw new Error(r.error);
    document.getElementById('ref-name').value='';document.getElementById('ref-content').value='';
    await loadKB();refreshAdminKB();
    sta.innerHTML=`<div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--gold-l);padding:10px;">${spin}⏳ Saved "${h(r.name)}" — summarising in background…</div>`;
    pollJob(r.jobId,sta,(err)=>{
      if(err){
        sta.innerHTML=`<div style="color:#ff8c42;font-size:13px;padding:8px;">⚠️ Saved "${h(r.name)}" but summarisation failed: ${h(err)}</div>`;
      }else{
        sta.innerHTML=`<div style="color:var(--teal);font-size:13px;padding:8px;">✅ "${h(r.name)}" saved and summarised. Re-generating ${h(subject)} content…</div>`;
      }
    });
  }catch(e){sta.innerHTML=`<div style="color:#e07080;font-size:13px;padding:8px;">⚠️ ${h(e.message)}</div>`;}
}
async function uploadPastBar(){
  const name=document.getElementById('pb-name').value.trim();
  const content=document.getElementById('pb-content').value.trim();
  const subject=document.getElementById('pb-subject').value;
  const year=document.getElementById('pb-year').value.trim();
  const sta=document.getElementById('pb-status');
  if(!name||!content){
    sta.innerHTML=`<div style="color:#e07080;font-size:13px;padding:8px;">⚠️ Enter a name and paste or upload content first.</div>`;
    return;
  }
  const spin=`<div class="spin" style="width:14px;height:14px;border-width:2px;flex-shrink:0;"></div>`;
  sta.innerHTML=`<div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--gold-l);padding:10px;">${spin}Saving…</div>`;
  try{
    const r=await fetch('/api/admin/pastbar',{method:'POST',headers:{'Content-Type':'application/json','x-admin-key':adminKey},body:JSON.stringify({name,content,subject,year})});
    const d=await r.json();
    if(d.error)throw new Error(d.error);
    document.getElementById('pb-name').value='';
    document.getElementById('pb-content').value='';
    await loadKB();refreshAdminKB();renderPastBarList();
    sta.innerHTML=`<div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--gold-l);padding:10px;">${spin}⏳ Saved "${h(d.name)}" — extracting questions…</div>`;
    pollJob(d.jobId,sta,(err,result)=>{
      if(err){
        sta.innerHTML=`<div style="color:#ff8c42;font-size:13px;padding:8px;">⚠️ Saved "${h(d.name)}" but extraction failed: ${h(err)}</div>`;
      }else if(!result?.questionsExtracted){
        sta.innerHTML=`<div style="color:#ff8c42;font-size:13px;padding:8px;">⚠️ Saved "${h(d.name)}" but 0 questions were extracted. Try pasting as plain text.</div>`;
      }else{
        sta.innerHTML=`<div style="color:var(--teal);font-size:13px;padding:8px;">✅ "${h(d.name)}" — ${result.questionsExtracted} questions extracted.</div>`;
      }
      loadKB();refreshAdminKB();renderPastBarList();refreshSidebarDots();
    });
  }catch(e){sta.innerHTML=`<div style="color:#e07080;font-size:13px;padding:8px;">⚠️ ${h(e.message)}</div>`;}
}
// Generic job poller — polls /api/job/:jobId every 8s
// onDone(errorMsg|null, result|null)
function pollJob(jobId,sta,onDone){
  const spin=`<div class="spin" style="width:14px;height:14px;border-width:2px;flex-shrink:0;"></div>`;
  let attempts=0;
  const iv=setInterval(async()=>{
    attempts++;
    try{
      const r=await fetch(`/api/job/${jobId}`,{headers:{'x-admin-key':adminKey}});
      const d=await r.json();
      if(d.status==='done'){
        clearInterval(iv);onDone(null,d.result);
      }else if(d.status==='failed'){
        clearInterval(iv);onDone(d.error,null);
      }else if(attempts>=38){ // ~5 min max
        clearInterval(iv);
        sta.innerHTML=`<div style="color:var(--muted);font-size:13px;padding:8px;">⏳ Still processing on server. Check back later.</div>`;
      }else{
        const elapsed=attempts*8;
        sta.innerHTML=`<div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--gold-l);padding:10px;">${spin}Processing… (${elapsed<60?elapsed+'s':Math.floor(elapsed/60)+'m '+elapsed%60+'s'} elapsed)</div>`;
      }
    }catch(e){if(attempts>=38)clearInterval(iv);}
  },8000);
}
function toggleDownloadPicker(id){
  document.querySelectorAll('.dl-picker').forEach(el=>{if(el.id!==`dl-picker-${id}`)el.style.display='none';});
  const p=document.getElementById(`dl-picker-${id}`);
  if(p) p.style.display=p.style.display==='flex'?'none':'flex';
}
async function downloadKBItem(id,format){
  const r=await fetch(`/api/admin/pastbar/${id}/download?format=${format}`,{headers:{'x-admin-key':adminKey}});
  if(!r.ok){alert('Download failed: '+(await r.text()));return;}
  if(format==='pdf'){
    // Open HTML page in new tab — it auto-prints
    const blob=await r.blob();
    const url=URL.createObjectURL(blob);
    window.open(url,'_blank');
    setTimeout(()=>URL.revokeObjectURL(url),60000);
    return;
  }
  const blob=await r.blob();
  const objUrl=URL.createObjectURL(blob);
  const cd=r.headers.get('content-disposition')||'';
  const fname=cd.match(/filename="?([^"]+)"?/)?.[1]||`questions-${id}.${format}`;
  const a=document.createElement('a');a.href=objUrl;a.download=fname;a.click();
  URL.revokeObjectURL(objUrl);
}
async function downloadAllQuestions(){
  const r=await fetch('/api/admin/pastbar/download-all?format=txt',{headers:{'x-admin-key':adminKey}});
  if(!r.ok){alert('Download failed: '+(await r.text()));return;}
  const blob=await r.blob();
  const objUrl=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=objUrl;a.download='barbuddy-all-questions.txt';a.click();
  URL.revokeObjectURL(objUrl);
}
async function refreshAdminKB(){
  loadStorageInfo();
  const el=document.getElementById('adminKbList');if(!el)return;
  const items=[
    ...(KB.hasSyllabus?[{name:KB.syllabusName||'Syllabus',subject:'all',type:'syllabus',id:'_syl'}]:[]),
    ...(KB.references||[]).map(r=>({...r,_cat:'ref'})),
    ...(KB.pastBar||[]).map(p=>({...p,_cat:'pb'})),
  ];
  if(!items.length){el.innerHTML=`<div style="font-size:12px;color:var(--muted);">Knowledge base is empty.</div>`;return;}
  el.innerHTML=items.map(i=>{
    const isPB=i._cat==='pb';
    const item=`<div class="kb-list-item" style="${isPB?'border-radius:9px 9px 0 0;margin-bottom:0;':''}">
      <div style="font-size:15px;">${i.type==='syllabus'?'📋':isPB?'📜':'📂'}</div>
      <div style="flex:1;min-width:0;"><div class="kl-name">${h(i.name)}</div><div class="kl-sub">${i.subject||''} ${i.year?'· '+i.year:''} ${i.qCount!==undefined?'· '+i.qCount+' Qs':i.type?'· '+i.type:''}</div></div>
      ${isPB?`<button class="kl-dl" onclick="toggleDownloadPicker('${i.id}')">⬇ Download</button>`:''}
      ${i.id!=='_syl'?`<button class="kl-del" onclick="deleteItem('${i.id}',this)">✕</button>`:`<button class="kl-del" onclick="deleteSyllabus(this)">✕</button>`}
    </div>`;
    const picker=isPB?`<div class="dl-picker" id="dl-picker-${i.id}">
      <span style="font-size:11px;color:var(--muted);">Download as:</span>
      <button class="kl-dl" onclick="downloadKBItem('${i.id}','pdf')">📄 PDF</button>
      <button class="kl-dl" onclick="downloadKBItem('${i.id}','json')">📋 JSON</button>
      <button class="kl-dl" onclick="downloadKBItem('${i.id}','txt')">📝 TXT</button>
    </div>`:'';
    return item+picker;
  }).join('');
}
async function loadStorageInfo(){
  const el=document.getElementById('storageIndicator');if(!el)return;
  try{
    const r=await fetch('/api/storage-info',{headers:{'x-admin-key':adminKey}});
    if(!r.ok){el.innerHTML='<span style="color:var(--muted);">Storage info unavailable.</span>';return;}
    const d=await r.json();
    const kb=d.files['kb.json'],ct=d.files['content.json'];
    const fmt=b=>b>=1024*1024?(b/1024/1024).toFixed(1)+'MB':b>=1024?(b/1024).toFixed(1)+'KB':b+'B';
    const persistColor=d.persistent?'#14b4a0':'#e09050';
    const persistLabel=d.persistent?'✅ Persistent (Railway Volume)':'⚠️ Ephemeral — data lost on redeploy';
    el.innerHTML=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
      <span style="color:${persistColor};font-weight:600;">${persistLabel}</span>
    </div>
    <div style="color:rgba(248,246,241,.6);line-height:1.7;">
      📄 kb.json: ${kb.exists?fmt(kb.bytes):'not found'} &nbsp;|&nbsp;
      📄 content.json: ${ct.exists?fmt(ct.bytes):'not found'}<br>
      📁 Path: <code style="font-size:11px;background:rgba(255,255,255,.06);padding:1px 5px;border-radius:4px;">${h(d.storageDir)}</code>
    </div>
    ${!d.persistent?`<div style="margin-top:8px;padding:8px 10px;background:rgba(224,144,80,.08);border:1px solid rgba(224,144,80,.25);border-radius:8px;color:#e09050;line-height:1.6;">
      <strong>To enable persistent storage on Railway:</strong><br>
      1. Add a Volume to your Railway service (Storage → Add Volume)<br>
      2. Set mount path (e.g. <code style="font-size:11px;">/data</code>)<br>
      3. Add env var: <code style="font-size:11px;">PERSISTENT_STORAGE_PATH=/data</code><br>
      4. Redeploy — your KB will survive future redeploys.
    </div>`:''}`;
  }catch(e){el.innerHTML=`<span style="color:var(--muted);">Storage info unavailable.</span>`;}
}
async function deleteItem(id,btn){
  if(!confirm('Delete this material?'))return;btn.disabled=true;
  await fetch('/api/admin/reference/'+id,{method:'DELETE',headers:{'x-admin-key':adminKey}});
  await loadKB();refreshAdminKB();renderPastBarList();
}
async function deleteSyllabus(btn){
  if(!confirm('Delete syllabus? All generated content will also be cleared.'))return;btn.disabled=true;
  await fetch('/api/admin/syllabus',{method:'DELETE',headers:{'x-admin-key':adminKey}});
  CACHE={};saveLocalCache();
  await loadKB();refreshAdminKB();renderSyllabusTree();updateSyllabusStatus();
}
async function retriggerGen(){
  if(!confirm('Regenerate all content? This replaces all existing lessons and quizzes.'))return;
  // Clear local cache
  CACHE={};saveLocalCache();buildQuizPool();renderSyllabusTree();
  await fetch('/api/admin/content',{method:'DELETE',headers:{'x-admin-key':adminKey}});
  const r=await fetch('/api/admin/generate',{method:'POST',headers:{'Content-Type':'application/json','x-admin-key':adminKey},body:JSON.stringify({})});
  const d=await r.json();
  document.getElementById('adminGenPanel').style.display='block';
  document.getElementById('adminGenDone').style.display='none';
  alert(`Re-generation started! ${d.total||0} topics queued.`);
}
async function clearContent(){
  if(!confirm('Clear all browser-cached content? Server content is preserved.'))return;
  CACHE={};saveLocalCache();buildQuizPool();renderSyllabusTree();
  alert('Browser cache cleared. Click topics to reload from server.');
}


// ══════════════════════════════════
// UTILS
// ══════════════════════════════════
function h(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// ══════════════════════════════════
// AUTH STATE
// ══════════════════════════════════
let currentUser  = null;
let sessionToken = null;

function switchAuthTab(tab) {
  document.getElementById('authFormLogin').style.display    = tab === 'login'    ? '' : 'none';
  document.getElementById('authFormRegister').style.display = tab === 'register' ? '' : 'none';
  document.getElementById('authFormForgot').style.display   = 'none';
  const tabRow = document.getElementById('authTabRow');
  if (tabRow) tabRow.style.display = 'flex';
  document.querySelectorAll('.auth-tab-btn').forEach((b,i) => b.classList.toggle('active', (i===0&&tab==='login')||(i===1&&tab==='register')));
}

async function doLogin() {
  const email    = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const errEl    = document.getElementById('loginErr');
  const btn      = document.getElementById('loginBtn');
  errEl.textContent = '';
  if (!email || !password) { errEl.textContent = 'Please fill in all fields.'; return; }
  btn.disabled = true; btn.textContent = 'Logging in…';
  try {
    const r = await fetch('/api/auth/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ email, password }) });
    const d = await r.json();
    if (!r.ok) { errEl.textContent = d.error || 'Login failed.'; return; }
    onAuthSuccess(d.token, d.user);
  } catch(e) { errEl.textContent = 'Network error. Try again.'; }
  finally { btn.disabled = false; btn.textContent = 'Log In'; }
}

async function doRegister() {
  const name     = document.getElementById('regName').value.trim();
  const email    = document.getElementById('regEmail').value.trim();
  const password = document.getElementById('regPassword').value;
  const errEl    = document.getElementById('regErr');
  const btn      = document.getElementById('regBtn');
  errEl.textContent = '';
  if (!name || !email || !password) { errEl.textContent = 'Please fill in all fields.'; return; }
  if (password.length < 6) { errEl.textContent = 'Password must be at least 6 characters.'; return; }
  btn.disabled = true; btn.textContent = 'Creating account…';
  try {
    const r = await fetch('/api/auth/register', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ name, email, password }) });
    const d = await r.json();
    if (!r.ok) { errEl.textContent = d.error || 'Registration failed.'; return; }
    onAuthSuccess(d.token, d.user);
  } catch(e) { errEl.textContent = 'Network error. Try again.'; }
  finally { btn.disabled = false; btn.textContent = 'Create Account'; }
}

function onAuthSuccess(token, user) {
  sessionToken = token;
  currentUser  = user;
  localStorage.setItem('bb_token', token);
  localStorage.setItem('bb_user', JSON.stringify(user));
  document.getElementById('authWall').style.display = 'none';
  updateUserDisplay();
}

function updateUserDisplay() {
  const disp   = document.getElementById('userNameDisplay');
  const logBtn = document.getElementById('logoutBtn');
  if (currentUser) {
    disp.textContent = currentUser.name;
    disp.style.display  = '';
    logBtn.style.display = '';
  } else {
    disp.style.display  = 'none';
    logBtn.style.display = 'none';
  }
}

async function doLogout() {
  if (sessionToken) {
    try { await fetch('/api/auth/logout', { method:'POST', headers:{'x-session-token': sessionToken} }); } catch(e) {}
  }
  sessionToken = null;
  currentUser  = null;
  localStorage.removeItem('bb_token');
  localStorage.removeItem('bb_user');
  document.getElementById('authWall').style.display = 'flex';
  updateUserDisplay();
}

async function checkExistingSession() {
  const savedToken = localStorage.getItem('bb_token');
  if (!savedToken) return false;
  try {
    const r = await fetch('/api/auth/me', { headers:{'x-session-token': savedToken} });
    if (!r.ok) { localStorage.removeItem('bb_token'); localStorage.removeItem('bb_user'); return false; }
    const user = await r.json();
    sessionToken = savedToken;
    currentUser  = user;
    localStorage.setItem('bb_user', JSON.stringify(user));
    document.getElementById('authWall').style.display = 'none';
    updateUserDisplay();
    return true;
  } catch(e) { return false; }
}

function showForgotPassword(show = true) {
  document.getElementById('authFormLogin').style.display    = show ? 'none' : '';
  document.getElementById('authFormRegister').style.display = 'none';
  document.getElementById('authFormForgot').style.display   = show ? '' : 'none';
  const tabRow = document.getElementById('authTabRow');
  if (tabRow) tabRow.style.display = show ? 'none' : 'flex';
  if (!show) switchAuthTab('login');
  document.getElementById('forgotError').style.display   = 'none';
  document.getElementById('forgotSuccess').style.display = 'none';
  document.getElementById('forgotEmail').value = '';
}

async function doForgotPassword() {
  const email     = document.getElementById('forgotEmail').value.trim();
  const errEl     = document.getElementById('forgotError');
  const btn       = document.getElementById('forgotBtn');
  const successEl = document.getElementById('forgotSuccess');
  errEl.style.display = 'none';
  if (!email) { errEl.textContent = 'Please enter your email address.'; errEl.style.display = 'block'; return; }
  btn.disabled = true; btn.textContent = '⏳ Submitting…';
  try {
    await fetch('/api/auth/forgot-password', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ email }) });
    successEl.style.display = 'block';
    btn.style.display = 'none';
  } catch(e) {
    errEl.textContent = '⚠️ Something went wrong. Try again.';
    errEl.style.display = 'block';
    btn.disabled = false; btn.textContent = '📨 Submit Reset Request';
  }
}

function timeAgo(isoString) {
  const diff = Date.now() - new Date(isoString).getTime();
  const s = Math.floor(diff / 1000);
  if (s < 60)  return `${s} second${s===1?'':'s'} ago`;
  const m = Math.floor(s / 60);
  if (m < 60)  return `${m} minute${m===1?'':'s'} ago`;
  const hr = Math.floor(m / 60);
  if (hr < 24) return `${hr} hour${hr===1?'':'s'} ago`;
  const d = Math.floor(hr / 24);
  return `${d} day${d===1?'':'s'} ago`;
}

async function adminResetPassword(userId, requestId, inputId) {
  const newPassword = document.getElementById(inputId)?.value.trim();
  if (!newPassword || newPassword.length < 6) { alert('Password must be at least 6 characters.'); return; }
  const r = await fetch('/api/admin/reset-password', {
    method: 'POST',
    headers: { 'Content-Type':'application/json', 'x-admin-key': window._adminKey || '' },
    body: JSON.stringify({ userId, newPassword, requestId }),
  });
  const d = await r.json();
  if (d.success) {
    alert(`✅ Password updated. Tell the user their new password is: ${newPassword}`);
    loadAdminUsers();
  } else {
    alert('Error: ' + (d.error || 'Unknown error'));
  }
}

async function dismissResetRequest(requestId) {
  await fetch(`/api/admin/reset-requests/${requestId}`, { method:'DELETE', headers:{'x-admin-key': window._adminKey || ''} });
  loadAdminUsers();
}

// ══════════════════════════════════
// SAVE MOCK BAR RESULTS
// ══════════════════════════════════
async function saveMockBarResults(scores) {
  if (!sessionToken || !currentUser) return;
  const total     = scores.length;
  const scoreSum  = scores.reduce((a,s) => a + (s.score||0), 0);
  const maxSum    = scores.reduce((a,s) => a + (s.max||10), 0);
  const timeTaken = window.mockStartTime ? Date.now() - window.mockStartTime : null;
  try {
    await fetch('/api/results/save', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'x-session-token': sessionToken },
      body: JSON.stringify({
        score:       parseFloat((scoreSum / total).toFixed(2)),
        total,
        subject:     'Mock Bar',
        questions:   scores.map(s => ({ q: s.q, score: s.score, max: s.max })),
        timeTakenMs: timeTaken,
      }),
    });
  } catch(e) { console.warn('Could not save results:', e.message); }
}

// ══════════════════════════════════
// ADMIN: USERS
// ══════════════════════════════════
async function loadAdminUsers() {
  const el = document.getElementById('adminUserList');
  if (!el) return;
  try {
    // Fetch users and reset requests in parallel
    const [rUsers, rReset] = await Promise.all([
      fetch('/api/admin/users',         { headers:{'x-admin-key': window._adminKey||''} }),
      fetch('/api/admin/reset-requests',{ headers:{'x-admin-key': window._adminKey||''} }),
    ]);
    const users   = await rUsers.json();
    const resets  = await rReset.json();
    const pending = resets.filter(r => r.status === 'pending');

    // Password reset requests panel (only when there are pending ones)
    let resetHtml = '';
    if (pending.length) {
      resetHtml = `
        <div style="background:rgba(155,35,53,.08);border:1px solid rgba(155,35,53,.3);border-radius:12px;padding:14px 16px;margin-bottom:16px;">
          <div style="font-weight:700;font-size:14px;color:#e07080;margin-bottom:10px;">🔑 Password Reset Requests <span style="background:rgba(155,35,53,.25);color:#e07080;border-radius:5px;padding:1px 7px;font-size:11px;">${pending.length}</span></div>
          ${pending.map(req => `<div class="kb-list-item" style="flex-wrap:wrap;gap:8px;align-items:center;">
            <div style="flex:1;min-width:140px;">
              <div class="kl-name">${h(req.name)}</div>
              <div class="kl-sub">${h(req.email)} &nbsp;·&nbsp; ${timeAgo(req.requestedAt)}</div>
            </div>
            <input type="password" id="newpw_${req.id}" class="form-input" placeholder="New password" style="width:160px;padding:7px 10px;font-size:12px;margin:0;">
            <button onclick="adminResetPassword('${req.userId}','${req.id}','newpw_${req.id}')" class="kl-del" style="color:#14b4a0;background:rgba(20,180,160,.1);white-space:nowrap;">✓ Set Password</button>
            <button onclick="dismissResetRequest('${req.id}')" class="kl-del" style="white-space:nowrap;">✕ Dismiss</button>
          </div>`).join('')}
        </div>`;
    }

    if (!users.length) { el.innerHTML = resetHtml + '<div style="font-size:12px;color:var(--muted);">No registered users yet.</div>'; return; }
    el.innerHTML = resetHtml + users.map(u => {
      const avg = u.stats.totalAttempts ? (u.stats.totalScore / u.stats.totalAttempts).toFixed(2) : '—';
      return `<div class="ur-row">
        <div><div class="ur-name">${h(u.name)}</div><div class="ur-meta">${h(u.email)} &nbsp;·&nbsp; Joined ${u.createdAt.slice(0,10)} &nbsp;·&nbsp; ${u.stats.totalAttempts} attempt(s), avg ${avg}/10</div></div>
        <span class="ur-badge${u.active?'':' off'}">${u.active?'Active':'Disabled'}</span>
        <button class="ur-act view" onclick="viewUserResults('${u.id}','${h(u.name)}')">Results</button>
        <button class="ur-act ${u.active?'disable':'enable'}" onclick="toggleUserAccess('${u.id}',${!u.active})">${u.active?'Disable':'Enable'}</button>
        <button class="ur-act del" onclick="deleteUser('${u.id}','${h(u.name)}')">Delete</button>
      </div>`;
    }).join('');
  } catch(e) { el.innerHTML = '<div style="font-size:12px;color:#e07080;">Failed to load users.</div>'; }
}

async function toggleUserAccess(userId, active) {
  if (!window._adminKey) return;
  await fetch(`/api/admin/users/${userId}`, { method:'PATCH', headers:{'Content-Type':'application/json','x-admin-key':window._adminKey}, body:JSON.stringify({ active }) });
  loadAdminUsers();
}

async function deleteUser(userId, name) {
  if (!confirm(`Delete user "${name}"? This cannot be undone.`)) return;
  await fetch(`/api/admin/users/${userId}`, { method:'DELETE', headers:{'x-admin-key':window._adminKey||''} });
  loadAdminUsers();
}

async function toggleRegistration() {
  const r = await fetch('/api/settings');
  const s = await r.json();
  await fetch('/api/admin/settings', { method:'POST', headers:{'Content-Type':'application/json','x-admin-key':window._adminKey||''}, body:JSON.stringify({ registrationOpen: !s.registrationOpen }) });
  const newState = !s.registrationOpen;
  const btn = document.getElementById('regToggleBtn');
  if (btn) btn.textContent = newState ? 'Close Registration' : 'Open Registration';
  loadAdminUsers();
}

// ══════════════════════════════════
// ADMIN: RESULTS
// ══════════════════════════════════
async function loadAdminResults() {
  const el = document.getElementById('adminResultsList');
  if (!el) return;
  try {
    const r    = await fetch('/api/admin/results', { headers:{'x-admin-key': window._adminKey||''} });
    const rows = await r.json();
    if (!rows.length) { el.innerHTML = '<div style="font-size:12px;color:var(--muted);">No results saved yet.</div>'; return; }
    el.innerHTML = rows.map(row => {
      const pct   = ((row.score / 10) * 100).toFixed(0);
      const passed = row.score >= 7;
      return `<div class="ur-row">
        <div><div class="ur-name">${h(row.userName)}</div><div class="ur-meta">${row.completedAt.slice(0,10)} &nbsp;·&nbsp; ${row.total} questions</div></div>
        <span class="ur-badge${passed?'':' off'}">${row.score}/10 (${pct}%)</span>
        <button class="ur-act view" onclick="viewResult('${row.id}')">View</button>
        <button class="ur-act del" onclick="deleteResult('${row.id}')">Delete</button>
      </div>`;
    }).join('');
  } catch(e) { el.innerHTML = '<div style="font-size:12px;color:#e07080;">Failed to load results.</div>'; }
}

async function viewUserResults(userId, name) {
  const r    = await fetch(`/api/admin/results/${userId}`, { headers:{'x-admin-key': window._adminKey||''} });
  const rows = await r.json();
  document.getElementById('resultDetailTitle').textContent = `📊 ${name} — Results`;
  document.getElementById('resultDetailStats').innerHTML = `
    <div class="res-dstat"><div class="res-dstat-val">${rows.length}</div><div class="res-dstat-lbl">Attempts</div></div>
    <div class="res-dstat"><div class="res-dstat-val">${rows.length ? (rows.reduce((a,r)=>a+r.score,0)/rows.length).toFixed(2) : '—'}</div><div class="res-dstat-lbl">Avg Score</div></div>
    <div class="res-dstat"><div class="res-dstat-val">${rows.filter(r=>r.score>=7).length}</div><div class="res-dstat-lbl">Passed</div></div>`;
  document.getElementById('resultDetailBody').innerHTML = rows.map(r =>
    `<div style="padding:8px 0;border-bottom:1px solid var(--bdr2);font-size:12px;">${r.completedAt.slice(0,10)} &nbsp; <strong>${r.score}/10</strong> &nbsp; ${r.total} questions</div>`
  ).join('') || '<div style="color:var(--muted);">No results.</div>';
  document.getElementById('resultDetailOverlay').classList.add('on');
}

async function viewResult(resultId) {
  const r    = await fetch('/api/admin/results', { headers:{'x-admin-key': window._adminKey||''} });
  const rows = await r.json();
  const row  = rows.find(x => x.id === resultId);
  if (!row) return;
  document.getElementById('resultDetailTitle').textContent = `📊 ${row.userName} — ${row.completedAt.slice(0,10)}`;
  const pct = ((row.score/10)*100).toFixed(0);
  document.getElementById('resultDetailStats').innerHTML = `
    <div class="res-dstat"><div class="res-dstat-val">${row.score}/10</div><div class="res-dstat-lbl">Score</div></div>
    <div class="res-dstat"><div class="res-dstat-val">${pct}%</div><div class="res-dstat-lbl">Percentage</div></div>
    <div class="res-dstat"><div class="res-dstat-val">${row.total}</div><div class="res-dstat-lbl">Questions</div></div>`;
  document.getElementById('resultDetailBody').innerHTML = (row.questions||[]).map((q,i)=>
    `<div style="padding:7px 0;border-bottom:1px solid var(--bdr2);font-size:12px;"><strong>Q${i+1}:</strong> ${h((q.q||'').slice(0,120))} &nbsp;<span style="color:var(--gold);">${q.score}/${q.max||10}</span></div>`
  ).join('') || '<div style="color:var(--muted);">No question detail.</div>';
  document.getElementById('resultDetailOverlay').classList.add('on');
}

async function deleteResult(resultId) {
  if (!confirm('Delete this result?')) return;
  await fetch(`/api/admin/results/${resultId}`, { method:'DELETE', headers:{'x-admin-key':window._adminKey||''} });
  loadAdminResults();
}

async function exportResultsCSV() {
  const r    = await fetch('/api/admin/results', { headers:{'x-admin-key': window._adminKey||''} });
  const rows = await r.json();
  const lines = ['Name,Email,Date,Score,Total,Questions'];
  rows.forEach(row => lines.push(`"${row.userName}","","${row.completedAt.slice(0,10)}","${row.score}","${row.total}","${row.total}"`));
  const blob = new Blob([lines.join('\n')], { type:'text/csv' });
  const a    = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'barbuddy_results.csv'; a.click();
}
</script>
</body>
</html>
